<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HospiSafe - Sistema de Gestión Hospitalaria</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <style>
        :root {
          /* Primitive Color Tokens */
          --color-white: rgba(255, 255, 255, 1);
          --color-black: rgba(0, 0, 0, 1);
          --color-cream-50: rgba(252, 252, 249, 1);
          --color-cream-100: rgba(255, 255, 253, 1);
          --color-gray-200: rgba(245, 245, 245, 1);
          --color-gray-300: rgba(167, 169, 169, 1);
          --color-gray-400: rgba(119, 124, 124, 1);
          --color-slate-500: rgba(98, 108, 113, 1);
          --color-brown-600: rgba(94, 82, 64, 1);
          --color-charcoal-700: rgba(31, 33, 33, 1);
          --color-charcoal-800: rgba(38, 40, 40, 1);
          --color-slate-900: rgba(19, 52, 59, 1);
          --color-teal-300: rgba(50, 184, 198, 1);
          --color-teal-400: rgba(45, 166, 178, 1);
          --color-teal-500: rgba(33, 128, 141, 1);
          --color-teal-600: rgba(29, 116, 128, 1);
          --color-teal-700: rgba(26, 104, 115, 1);
          --color-teal-800: rgba(41, 150, 161, 1);
          --color-red-400: rgba(255, 84, 89, 1);
          --color-red-500: rgba(192, 21, 47, 1);
          --color-orange-400: rgba(230, 129, 97, 1);
          --color-orange-500: rgba(168, 75, 47, 1);

          /* RGB versions for opacity control */
          --color-brown-600-rgb: 94, 82, 64;
          --color-teal-500-rgb: 33, 128, 141;
          --color-slate-900-rgb: 19, 52, 59;
          --color-slate-500-rgb: 98, 108, 113;
          --color-red-500-rgb: 192, 21, 47;
          --color-red-400-rgb: 255, 84, 89;
          --color-orange-500-rgb: 168, 75, 47;
          --color-orange-400-rgb: 230, 129, 97;

          /* Background color tokens (Light Mode) */
          --color-bg-1: rgba(59, 130, 246, 0.08); /* Light blue */
          --color-bg-2: rgba(245, 158, 11, 0.08); /* Light yellow */
          --color-bg-3: rgba(34, 197, 94, 0.08); /* Light green */
          --color-bg-4: rgba(239, 68, 68, 0.08); /* Light red */
          --color-bg-5: rgba(147, 51, 234, 0.08); /* Light purple */
          --color-bg-6: rgba(249, 115, 22, 0.08); /* Light orange */
          --color-bg-7: rgba(236, 72, 153, 0.08); /* Light pink */
          --color-bg-8: rgba(6, 182, 212, 0.08); /* Light cyan */

          /* Semantic Color Tokens (Light Mode) */
          --color-background: var(--color-cream-50);
          --color-surface: var(--color-cream-100);
          --color-text: var(--color-slate-900);
          --color-text-secondary: var(--color-slate-500);
          --color-primary: var(--color-teal-500);
          --color-primary-hover: var(--color-teal-600);
          --color-primary-active: var(--color-teal-700);
          --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
          --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
          --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
          --color-border: rgba(var(--color-brown-600-rgb), 0.2);
          --color-btn-primary-text: var(--color-cream-50);
          --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
          --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
          --color-error: var(--color-red-500);
          --color-success: var(--color-teal-500);
          --color-warning: var(--color-orange-500);
          --color-info: var(--color-slate-500);
          --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);
          --color-select-caret: rgba(var(--color-slate-900-rgb), 0.8);

          /* Common style patterns */
          --focus-ring: 0 0 0 3px var(--color-focus-ring);
          --focus-outline: 2px solid var(--color-primary);
          --status-bg-opacity: 0.15;
          --status-border-opacity: 0.25;
          --select-caret-light: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23134252' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
          --select-caret-dark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23f5f5f5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");

          /* RGB versions for opacity control */
          --color-success-rgb: 33, 128, 141;
          --color-error-rgb: 192, 21, 47;
          --color-warning-rgb: 168, 75, 47;
          --color-info-rgb: 98, 108, 113;

          /* Typography */
          --font-family-base: "FKGroteskNeue", "Geist", "Inter", -apple-system,
            BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
          --font-family-mono: "Berkeley Mono", ui-monospace, SFMono-Regular, Menlo,
            Monaco, Consolas, monospace;
          --font-size-xs: 11px;
          --font-size-sm: 12px;
          --font-size-base: 14px;
          --font-size-md: 14px;
          --font-size-lg: 16px;
          --font-size-xl: 18px;
          --font-size-2xl: 20px;
          --font-size-3xl: 24px;
          --font-size-4xl: 30px;
          --font-weight-normal: 400;
          --font-weight-medium: 500;
          --font-weight-semibold: 550;
          --font-weight-bold: 600;
          --line-height-tight: 1.2;
          --line-height-normal: 1.5;
          --letter-spacing-tight: -0.01em;

          /* Spacing */
          --space-0: 0;
          --space-1: 1px;
          --space-2: 2px;
          --space-4: 4px;
          --space-6: 6px;
          --space-8: 8px;
          --space-10: 10px;
          --space-12: 12px;
          --space-16: 16px;
          --space-20: 20px;
          --space-24: 24px;
          --space-32: 32px;

          /* Border Radius */
          --radius-sm: 6px;
          --radius-base: 8px;
          --radius-md: 10px;
          --radius-lg: 12px;
          --radius-full: 9999px;

          /* Shadows */
          --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.02);
          --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
          --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04),
            0 2px 4px -1px rgba(0, 0, 0, 0.02);
          --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.04),
            0 4px 6px -2px rgba(0, 0, 0, 0.02);
          --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.15),
            inset 0 -1px 0 rgba(0, 0, 0, 0.03);

          /* Animation */
          --duration-fast: 150ms;
          --duration-normal: 250ms;
          --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);

          /* Layout */
          --container-sm: 640px;
          --container-md: 768px;
          --container-lg: 1024px;
          --container-xl: 1280px;
        }

        /* Dark mode colors */
        @media (prefers-color-scheme: dark) {
          :root {
            /* RGB versions for opacity control (Dark Mode) */
            --color-gray-400-rgb: 119, 124, 124;
            --color-teal-300-rgb: 50, 184, 198;
            --color-gray-300-rgb: 167, 169, 169;
            --color-gray-200-rgb: 245, 245, 245;

            /* Background color tokens (Dark Mode) */
            --color-bg-1: rgba(29, 78, 216, 0.15); /* Dark blue */
            --color-bg-2: rgba(180, 83, 9, 0.15); /* Dark yellow */
            --color-bg-3: rgba(21, 128, 61, 0.15); /* Dark green */
            --color-bg-4: rgba(185, 28, 28, 0.15); /* Dark red */
            --color-bg-5: rgba(107, 33, 168, 0.15); /* Dark purple */
            --color-bg-6: rgba(194, 65, 12, 0.15); /* Dark orange */
            --color-bg-7: rgba(190, 24, 93, 0.15); /* Dark pink */
            --color-bg-8: rgba(8, 145, 178, 0.15); /* Dark cyan */

            /* Semantic Color Tokens (Dark Mode) */
            --color-background: var(--color-charcoal-700);
            --color-surface: var(--color-charcoal-800);
            --color-text: var(--color-gray-200);
            --color-text-secondary: rgba(var(--color-gray-300-rgb), 0.7);
            --color-primary: var(--color-teal-300);
            --color-primary-hover: var(--color-teal-400);
            --color-primary-active: var(--color-teal-800);
            --color-secondary: rgba(var(--color-gray-400-rgb), 0.15);
            --color-secondary-hover: rgba(var(--color-gray-400-rgb), 0.25);
            --color-secondary-active: rgba(var(--color-gray-400-rgb), 0.3);
            --color-border: rgba(var(--color-gray-400-rgb), 0.3);
            --color-error: var(--color-red-400);
            --color-success: var(--color-teal-300);
            --color-warning: var(--color-orange-400);
            --color-info: var(--color-gray-300);
            --color-focus-ring: rgba(var(--color-teal-300-rgb), 0.4);
            --color-btn-primary-text: var(--color-slate-900);
            --color-card-border: rgba(var(--color-gray-400-rgb), 0.2);
            --color-card-border-inner: rgba(var(--color-gray-400-rgb), 0.15);
            --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.1),
              inset 0 -1px 0 rgba(0, 0, 0, 0.15);
            --button-border-secondary: rgba(var(--color-gray-400-rgb), 0.2);
            --color-border-secondary: rgba(var(--color-gray-400-rgb), 0.2);
            --color-select-caret: rgba(var(--color-gray-200-rgb), 0.8);

            /* Common style patterns - updated for dark mode */
            --focus-ring: 0 0 0 3px var(--color-focus-ring);
            --focus-outline: 2px solid var(--color-primary);
            --status-bg-opacity: 0.15;
            --status-border-opacity: 0.25;
            --select-caret-light: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23134252' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            --select-caret-dark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23f5f5f5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");

            /* RGB versions for dark mode */
            --color-success-rgb: var(--color-teal-300-rgb);
            --color-error-rgb: var(--color-red-400-rgb);
            --color-warning-rgb: var(--color-orange-400-rgb);
            --color-info-rgb: var(--color-gray-300-rgb);
          }
        }

        /* Base styles */
        html {
          font-size: var(--font-size-base);
          font-family: var(--font-family-base);
          line-height: var(--line-height-normal);
          color: var(--color-text);
          background-color: var(--color-background);
          -webkit-font-smoothing: antialiased;
          box-sizing: border-box;
        }

        body {
          margin: 0;
          padding: 0;
        }

        *,
        *::before,
        *::after {
          box-sizing: inherit;
        }

        /* Custom HospiSafe styles */
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Login Screen */
        .login-screen {
            background: linear-gradient(135deg, var(--color-bg-1), var(--color-bg-3));
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-16);
        }

        .login-card {
            background: var(--color-surface);
            padding: var(--space-32);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 400px;
        }

        .login-header {
            text-align: center;
            margin-bottom: var(--space-32);
        }

        .logo {
            font-size: var(--font-size-3xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
            margin-bottom: var(--space-8);
        }

        .form-group {
            margin-bottom: var(--space-16);
        }

        .form-label {
            display: block;
            margin-bottom: var(--space-8);
            font-weight: var(--font-weight-medium);
            font-size: var(--font-size-sm);
        }

        .form-control {
            display: block;
            width: 100%;
            padding: var(--space-12);
            font-size: var(--font-size-md);
            line-height: 1.5;
            color: var(--color-text);
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            transition: border-color var(--duration-fast) var(--ease-standard),
              box-shadow var(--duration-fast) var(--ease-standard);
        }

        .form-control:focus {
            border-color: var(--color-primary);
            outline: var(--focus-outline);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-12) var(--space-20);
            border-radius: var(--radius-base);
            font-size: var(--font-size-base);
            font-weight: 500;
            line-height: 1.5;
            cursor: pointer;
            transition: all var(--duration-normal) var(--ease-standard);
            border: none;
            text-decoration: none;
            position: relative;
        }

        .btn--primary {
            background: var(--color-primary);
            color: var(--color-btn-primary-text);
            width: 100%;
        }

        .btn--primary:hover {
            background: var(--color-primary-hover);
        }

        .btn--secondary {
            background: var(--color-secondary);
            color: var(--color-text);
        }

        .btn--outline {
            background: transparent;
            border: 1px solid var(--color-border);
            color: var(--color-text);
        }

        .btn--sm {
            padding: var(--space-6) var(--space-12);
            font-size: var(--font-size-sm);
        }

        /* Dashboard Layout */
        .dashboard {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: var(--color-surface);
            border-right: 1px solid var(--color-border);
            display: flex;
            flex-direction: column;
            transition: transform var(--duration-normal) var(--ease-standard);
        }

        .sidebar-header {
            padding: var(--space-20);
            border-bottom: 1px solid var(--color-border);
        }

        .sidebar-nav {
            flex: 1;
            padding: var(--space-16);
        }

        .nav-item {
            margin-bottom: var(--space-8);
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: var(--space-12) var(--space-16);
            color: var(--color-text);
            text-decoration: none;
            border-radius: var(--radius-base);
            transition: all var(--duration-fast) var(--ease-standard);
        }

        .nav-link:hover {
            background: var(--color-bg-1);
            color: var(--color-primary);
        }

        .nav-link.active {
            background: var(--color-primary);
            color: var(--color-btn-primary-text);
        }

        .nav-icon {
            margin-right: var(--space-12);
            width: 20px;
            text-align: center;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            padding: var(--space-16) var(--space-24);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-semibold);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: var(--space-16);
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: var(--space-8);
        }

        .content {
            flex: 1;
            padding: var(--space-24);
            overflow: auto;
        }

        /* Cards */
        .card {
            background: var(--color-surface);
            border: 1px solid var(--color-card-border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }

        .card-header {
            padding: var(--space-16) var(--space-20);
            border-bottom: 1px solid var(--color-card-border-inner);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            margin: 0;
        }

        .card-body {
            padding: var(--space-20);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-20);
            margin-bottom: var(--space-24);
        }

        .stat-card {
            background: var(--color-bg-1);
            padding: var(--space-20);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border);
        }

        .stat-number {
            font-size: var(--font-size-3xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
            margin-bottom: var(--space-8);
        }

        .stat-label {
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: var(--space-16);
        }

        .table th,
        .table td {
            padding: var(--space-12) var(--space-16);
            text-align: left;
            border-bottom: 1px solid var(--color-border);
        }

        .table th {
            background: var(--color-bg-1);
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        .table tr:hover {
            background: var(--color-bg-1);
        }

        /* Status badges */
        .status {
            display: inline-flex;
            align-items: center;
            padding: var(--space-4) var(--space-12);
            border-radius: var(--radius-full);
            font-weight: var(--font-weight-medium);
            font-size: var(--font-size-xs);
        }

        .status--success {
            background-color: rgba(var(--color-success-rgb), var(--status-bg-opacity));
            color: var(--color-success);
            border: 1px solid rgba(var(--color-success-rgb), var(--status-border-opacity));
        }

        .status--warning {
            background-color: rgba(var(--color-warning-rgb), var(--status-bg-opacity));
            color: var(--color-warning);
            border: 1px solid rgba(var(--color-warning-rgb), var(--status-border-opacity));
        }

        .status--error {
            background-color: rgba(var(--color-error-rgb), var(--status-bg-opacity));
            color: var(--color-error);
            border: 1px solid rgba(var(--color-error-rgb), var(--status-border-opacity));
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow: auto;
        }

        .modal-header {
            padding: var(--space-20);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            margin: 0;
        }

        .modal-body {
            padding: var(--space-20);
        }

        .close {
            background: none;
            border: none;
            font-size: var(--font-size-xl);
            cursor: pointer;
            color: var(--color-text-secondary);
        }

        /* Form layouts */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-16);
            margin-bottom: var(--space-16);
        }

        /* Search bar */
        .search-bar {
            position: relative;
            margin-bottom: var(--space-20);
        }

        .search-input {
            padding-left: var(--space-32);
        }

        .search-icon {
            position: absolute;
            left: var(--space-12);
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-text-secondary);
        }

        /* Mobile styles */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100%;
                z-index: 999;
                transform: translateX(-100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .mobile-menu-btn {
                display: block;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            font-size: var(--font-size-lg);
            cursor: pointer;
            color: var(--color-text);
        }

        /* 2FA Screen */
        .twofa-screen {
            background: linear-gradient(135deg, var(--color-bg-1), var(--color-bg-3));
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-16);
        }

        .code-input {
            text-align: center;
            font-size: var(--font-size-xl);
            letter-spacing: 0.5em;
        }

        /* Chart container */
        .chart-container {
            height: 300px;
            position: relative;
        }

        /* Hidden class */
        .hidden {
            display: none !important;
        }

        /* QR Scanner simulation */
        .qr-scanner {
            background: var(--color-charcoal-700);
            border-radius: var(--radius-lg);
            padding: var(--space-20);
            text-align: center;
            color: var(--color-white);
        }

        .scan-area {
            width: 200px;
            height: 200px;
            border: 2px dashed var(--color-primary);
            margin: var(--space-20) auto;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .scan-line {
            width: 100%;
            height: 2px;
            background: var(--color-primary);
            position: absolute;
            animation: scan 2s infinite;
        }

        /* Advanced styling */
        .stat-trend {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
            margin-top: var(--space-4);
        }

        .stat-card[data-bg="1"] {
            background: var(--color-bg-1);
        }
        .stat-card[data-bg="2"] {
            background: var(--color-bg-2);
        }
        .stat-card[data-bg="3"] {
            background: var(--color-bg-3);
        }
        .stat-card[data-bg="4"] {
            background: var(--color-bg-4);
        }
        .stat-card[data-bg="5"] {
            background: var(--color-bg-5);
        }
        .stat-card[data-bg="6"] {
            background: var(--color-bg-6);
        }

        /* Advanced components */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--color-secondary);
            border-radius: var(--radius-full);
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--color-primary);
            transition: width var(--duration-normal) var(--ease-standard);
        }

        .notification-panel {
            position: fixed;
            top: 80px;
            right: var(--space-20);
            width: 350px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            z-index: 1001;
            display: none;
            max-height: 400px;
            overflow-y: auto;
        }

        .notification-panel.active {
            display: block;
        }

        .notification-item {
            padding: var(--space-16);
            border-bottom: 1px solid var(--color-border);
            cursor: pointer;
        }

        .notification-item:hover {
            background: var(--color-bg-1);
        }

        .notification-item.urgent {
            border-left: 4px solid var(--color-error);
        }

        .notification-item.info {
            border-left: 4px solid var(--color-info);
        }

        .notification-item.warning {
            border-left: 4px solid var(--color-warning);
        }

        .filter-bar {
            display: flex;
            gap: var(--space-12);
            margin-bottom: var(--space-20);
            flex-wrap: wrap;
        }

        .filter-chip {
            display: inline-flex;
            align-items: center;
            padding: var(--space-6) var(--space-12);
            background: var(--color-bg-1);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-full);
            font-size: var(--font-size-sm);
            cursor: pointer;
        }

        .filter-chip.active {
            background: var(--color-primary);
            color: var(--color-btn-primary-text);
        }

        .tab-navigation {
            display: flex;
            border-bottom: 1px solid var(--color-border);
            margin-bottom: var(--space-20);
        }

        .tab-item {
            padding: var(--space-12) var(--space-20);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all var(--duration-fast) var(--ease-standard);
        }

        .tab-item.active {
            border-bottom-color: var(--color-primary);
            color: var(--color-primary);
        }

        .breadcrumbs {
            display: flex;
            align-items: center;
            gap: var(--space-8);
            margin-bottom: var(--space-16);
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        .breadcrumb-separator {
            opacity: 0.5;
        }

        /* Dark mode styles */
        body.dark-mode {
            --color-background: var(--color-charcoal-700);
            --color-surface: var(--color-charcoal-800);
            --color-text: var(--color-gray-200);
            --color-text-secondary: rgba(var(--color-gray-300-rgb), 0.7);
            --color-primary: var(--color-teal-300);
            --color-primary-hover: var(--color-teal-400);
            --color-btn-primary-text: var(--color-slate-900);
        }

        /* Animation classes */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Skeleton loading */
        .skeleton {
            background: linear-gradient(90deg, var(--color-secondary) 25%, var(--color-bg-1) 50%, var(--color-secondary) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Tooltip */
        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--color-charcoal-800);
            color: var(--color-white);
            padding: var(--space-6) var(--space-8);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-xs);
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity var(--duration-fast);
        }

        .tooltip:hover::after {
            opacity: 1;
        }
        
        /* Enhanced notification badge */
        .notification-badge::after {
            content: var(--notification-count, '3');
        }
        
        /* Responsive enhancements */
        @media (max-width: 640px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                gap: var(--space-12);
            }
            
            .header-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .search-bar {
                flex: 1;
            }
            
            .tab-navigation {
                overflow-x: auto;
            }
            
            .filter-bar {
                overflow-x: auto;
                padding-bottom: var(--space-8);
            }
        }
        
        /* Loading states */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Error states */
        .error {
            border-color: var(--color-error) !important;
            background-color: rgba(var(--color-error-rgb), 0.05);
        }
        
        .success {
            border-color: var(--color-success) !important;
            background-color: rgba(var(--color-success-rgb), 0.05);
        }
        
        /* Print styles */
        @media print {
            .sidebar,
            .header-actions,
            .btn,
            .notification-panel {
                display: none !important;
            }
            
            .main-content {
                margin-left: 0 !important;
            }
            
            .card {
                break-inside: avoid;
                box-shadow: none;
                border: 1px solid #000;
            }
        }

        @keyframes scan {
            0% { top: 0; }
            50% { top: 100%; }
            100% { top: 0; }
        }

        /* Mobile view toggle */
        .view-toggle {
            margin-bottom: var(--space-16);
        }

        /* Notification badge */
        .notification-badge {
            position: relative;
        }

        .notification-badge::after {
            content: '3';
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--color-error);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div class="app-container" id="app">
        <!-- Login Screen -->
        <div id="loginScreen" class="login-screen">
            <div class="login-card">
                <div class="login-header">
                    <div class="logo">
                        <i class="fas fa-heartbeat"></i> HospiSafe
                    </div>
                    <p class="login-subtitle">Sistema de Gestión Hospitalaria</p>
                </div>
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label" for="username">Usuario</label>
                        <input type="text" id="username" class="form-control" placeholder="Ingrese su usuario" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="password">Contraseña</label>
                        <input type="password" id="password" class="form-control" placeholder="Ingrese su contraseña" required>
                    </div>
                    <button type="submit" class="btn btn--primary">
                        <i class="fas fa-sign-in-alt"></i> Iniciar Sesión
                    </button>
                </form>
                <div class="mt-8" style="margin-top: var(--space-16); text-align: center;">
                    <small style="color: var(--color-text-secondary);">
                        Demo: admin/admin123, doctor1/doc123, nurse1/nurse123
                    </small>
                </div>
            </div>
        </div>

        <!-- 2FA Screen -->
        <div id="twofaScreen" class="twofa-screen hidden">
            <div class="login-card">
                <div class="login-header">
                    <div class="logo">
                        <i class="fas fa-shield-alt"></i> Verificación 2FA
                    </div>
                    <p class="login-subtitle">Ingrese el código de verificación</p>
                </div>
                <form id="twofaForm">
                    <div class="form-group">
                        <label class="form-label" for="verificationCode">Código de Verificación</label>
                        <input type="text" id="verificationCode" class="form-control code-input" placeholder="123456" maxlength="6" required>
                    </div>
                    <button type="submit" class="btn btn--primary">
                        <i class="fas fa-check"></i> Verificar
                    </button>
                </form>
                <div class="mt-8" style="margin-top: var(--space-16); text-align: center;">
                    <small style="color: var(--color-text-secondary);">
                        Código demo: 123456
                    </small>
                </div>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="dashboard hidden">
            <!-- Sidebar -->
            <div class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <div class="logo">
                        <i class="fas fa-heartbeat"></i> HospiSafe
                    </div>
                </div>
                <nav class="sidebar-nav">
                    <div class="nav-item">
                        <a href="#" class="nav-link active" data-module="dashboard">
                            <i class="fas fa-tachometer-alt nav-icon"></i>
                            Dashboard
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" data-module="patients">
                            <i class="fas fa-user-injured nav-icon"></i>
                            Pacientes
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" data-module="appointments">
                            <i class="fas fa-calendar-alt nav-icon"></i>
                            Citas
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" data-module="records">
                            <i class="fas fa-file-medical nav-icon"></i>
                            Historiales
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" data-module="doctors">
                            <i class="fas fa-user-md nav-icon"></i>
                            Personal
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" data-module="prescriptions">
                            <i class="fas fa-prescription-bottle-alt nav-icon"></i>
                            Recetas
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" data-module="billing">
                            <i class="fas fa-file-invoice-dollar nav-icon"></i>
                            Facturación
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" data-module="mobile">
                            <i class="fas fa-mobile-alt nav-icon"></i>
                            Vista Móvil
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" data-module="inventory">
                            <i class="fas fa-boxes nav-icon"></i>
                            Inventario
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" data-module="laboratory">
                            <i class="fas fa-flask nav-icon"></i>
                            Laboratorio
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" data-module="radiology">
                            <i class="fas fa-x-ray nav-icon"></i>
                            Radiología
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" data-module="surgery">
                            <i class="fas fa-procedures nav-icon"></i>
                            Quirófanos
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" data-module="emergency">
                            <i class="fas fa-ambulance nav-icon"></i>
                            Urgencias
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" data-module="rooms">
                            <i class="fas fa-bed nav-icon"></i>
                            Habitaciones
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" data-module="communications">
                            <i class="fas fa-comments nav-icon"></i>
                            Comunicaciones
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" data-module="reports">
                            <i class="fas fa-chart-bar nav-icon"></i>
                            Reportes
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" data-module="settings">
                            <i class="fas fa-cog nav-icon"></i>
                            Configuración
                        </a>
                    </div>
                </nav>
            </div>

            <!-- Main Content -->
            <div class="main-content">
                <!-- Header -->
                <header class="header">
                    <div class="header-left">
                        <button class="mobile-menu-btn" id="mobileMenuBtn">
                            <i class="fas fa-bars"></i>
                        </button>
                        <h1 class="header-title" id="headerTitle">Dashboard</h1>
                    </div>
                    <div class="header-actions">
                        <div class="search-bar">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="form-control search-input" id="globalSearch" placeholder="Buscar...">
                        </div>
                        <div class="notification-badge" onclick="showNotifications()">
                            <i class="fas fa-bell"></i>
                        </div>
                        <button class="btn btn--outline btn--sm" onclick="toggleDarkMode()" title="Cambiar tema">
                            <i class="fas fa-moon" id="themeIcon"></i>
                        </button>
                        <div class="user-menu">
                            <span id="userName">Usuario</span>
                            <button class="btn btn--outline btn--sm" onclick="logout()">
                                <i class="fas fa-sign-out-alt"></i> Salir
                            </button>
                        </div>
                    </div>
                </header>

                <!-- Content -->
                <main class="content" id="content">
                    <!-- Dashboard Module -->
                    <div id="dashboardModule" class="module">
                        <div class="stats-grid">
                            <div class="stat-card" data-bg="1">
                                <div class="stat-number" id="totalPatientsCount">342</div>
                                <div class="stat-label">Total Pacientes</div>
                                <div class="stat-trend">↗ +12 desde ayer</div>
                            </div>
                            <div class="stat-card" data-bg="2">
                                <div class="stat-number" id="todayAppointmentsCount">28</div>
                                <div class="stat-label">Citas Hoy</div>
                                <div class="stat-trend">↗ 12 completadas</div>
                            </div>
                            <div class="stat-card" data-bg="3">
                                <div class="stat-number" id="occupancyRate">78%</div>
                                <div class="stat-label">Ocupación Camas</div>
                                <div class="stat-trend">→ Estable</div>
                            </div>
                            <div class="stat-card" data-bg="4">
                                <div class="stat-number" id="emergenciesToday">5</div>
                                <div class="stat-label">Emergencias Hoy</div>
                                <div class="stat-trend">↘ -2 vs ayer</div>
                            </div>
                            <div class="stat-card" data-bg="5">
                                <div class="stat-number">€8.750</div>
                                <div class="stat-label">Ingresos Semana</div>
                                <div class="stat-trend">↗ +15% vs anterior</div>
                            </div>
                            <div class="stat-card" data-bg="6">
                                <div class="stat-number">4.6/5</div>
                                <div class="stat-label">Satisfacción</div>
                                <div class="stat-trend">⭐ Excelente</div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--space-20); margin-bottom: var(--space-24);">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Citas por Mes</h3>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="appointmentsChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Citas Hoy</h3>
                                </div>
                                <div class="card-body" id="todayAppointments">
                                    <!-- Populated by JS -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Patients Module -->
                    <div id="patientsModule" class="module hidden">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Gestión de Pacientes</h3>
                                <button class="btn btn--primary btn--sm" onclick="showPatientModal()">
                                    <i class="fas fa-plus"></i> Nuevo Paciente
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-container">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Nombre</th>
                                                <th>DNI</th>
                                                <th>Teléfono</th>
                                                <th>Seguro</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="patientsTable">
                                            <!-- Populated by JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced modules populated by JavaScript -->
                    <div id="appointmentsModule" class="module hidden"></div>
                    <div id="recordsModule" class="module hidden"></div>
                    <div id="doctorsModule" class="module hidden"></div>
                    <div id="prescriptionsModule" class="module hidden"></div>
                    <div id="billingModule" class="module hidden"></div>
                    <div id="inventoryModule" class="module hidden"></div>
                    <div id="laboratoryModule" class="module hidden"></div>
                    <div id="radiologyModule" class="module hidden"></div>
                    <div id="surgeryModule" class="module hidden"></div>
                    <div id="emergencyModule" class="module hidden"></div>
                    <div id="roomsModule" class="module hidden"></div>
                    <div id="communicationsModule" class="module hidden"></div>
                    <div id="reportsModule" class="module hidden"></div>
                    <div id="mobileModule" class="module hidden"></div>
                    <div id="settingsModule" class="module hidden"></div>
                </main>
            </div>
        </div>
    </div>

    <!-- Modal for forms -->
    <div class="modal" id="formModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Título</h3>
                <button class="close" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content populated by JS -->
            </div>
        </div>
    </div>

    <script>
        // Application state
        let currentUser = null;
        let currentModule = 'dashboard';
        let appointmentsChart = null;

        // Sample data based on provided JSON
        const users = [
            {
                id: 1,
                username: "admin",
                password: "admin123",
                role: "Administrador",
                name: "Dr. Carlos Administrador",
                email: "admin@hospis.com"
            },
            {
                id: 2,
                username: "doctor1",
                password: "doc123",
                role: "Médico",
                name: "Dr. María García",
                email: "maria.garcia@hospis.com",
                specialty: "Cardiología"
            },
            {
                id: 3,
                username: "nurse1",
                password: "nurse123",
                role: "Enfermería",
                name: "Ana Martínez",
                email: "ana.martinez@hospis.com"
            }
        ];

        let patients = [
            {
                id: 1,
                name: "Juan Pérez López",
                dni: "12345678A",
                birthdate: "1980-05-15",
                phone: "666555444",
                email: "juan.perez@email.com",
                address: "Calle Mayor 123, Alicante",
                insurance: "Seguridad Social",
                emergency_contact: "María Pérez - 666777888"
            },
            {
                id: 2,
                name: "Ana Rodríguez Sánchez",
                dni: "87654321B",
                birthdate: "1992-03-22",
                phone: "677888999",
                email: "ana.rodriguez@email.com",
                address: "Avenida del Mar 45, Alicante",
                insurance: "Privada - Sanitas",
                emergency_contact: "Pedro Rodríguez - 688999000"
            },
            {
                id: 3,
                name: "Carlos Gómez Ruiz",
                dni: "11223344C",
                birthdate: "1975-12-08",
                phone: "655444333",
                email: "carlos.gomez@email.com",
                address: "Plaza España 67, Alicante",
                insurance: "Seguridad Social",
                emergency_contact: "Laura Gómez - 644333222"
            }
        ];

        let appointments = [
            {
                id: 1,
                patient_id: 1,
                patient_name: "Juan Pérez López",
                doctor: "Dr. María García",
                specialty: "Cardiología",
                date: "2025-10-23",
                time: "09:00",
                status: "Programada",
                reason: "Control hipertensión"
            },
            {
                id: 2,
                patient_id: 2,
                patient_name: "Ana Rodríguez Sánchez",
                doctor: "Dr. Pedro López",
                specialty: "Medicina General",
                date: "2025-10-23",
                time: "10:30",
                status: "Programada",
                reason: "Revisión resultados"
            },
            {
                id: 3,
                patient_id: 3,
                patient_name: "Carlos Gómez Ruiz",
                doctor: "Dr. María García",
                specialty: "Cardiología",
                date: "2025-10-24",
                time: "11:00",
                status: "Programada",
                reason: "Primera consulta"
            }
        ];

        let medicalRecords = [
            {
                id: 1,
                patient_id: 1,
                date: "2025-10-20",
                doctor: "Dr. María García",
                diagnosis: "Hipertensión arterial",
                treatment: "Enalapril 10mg - 1 comp/día",
                notes: "Control en 3 meses"
            },
            {
                id: 2,
                patient_id: 1,
                date: "2025-07-15",
                doctor: "Dr. José Martín",
                diagnosis: "Revisión rutinaria",
                treatment: "Sin tratamiento",
                notes: "Paciente en buen estado general"
            },
            {
                id: 3,
                patient_id: 2,
                date: "2025-10-18",
                doctor: "Dr. María García",
                diagnosis: "Dolor torácico atípico",
                treatment: "ECG normal, analítica pendiente",
                notes: "Cita control en 1 semana"
            }
        ];

        let doctors = [
            {
                id: 1,
                name: "Dr. María García",
                specialty: "Cardiología",
                license: "282844556",
                phone: "965123456",
                email: "maria.garcia@hospis.com",
                schedule: "L-V: 8:00-15:00"
            },
            {
                id: 2,
                name: "Dr. Pedro López",
                specialty: "Medicina General",
                license: "282844557",
                phone: "965123457",
                email: "pedro.lopez@hospis.com",
                schedule: "L-V: 9:00-17:00"
            },
            {
                id: 3,
                name: "Dr. José Martín",
                specialty: "Traumatología",
                license: "282844558",
                phone: "965123458",
                email: "jose.martin@hospis.com",
                schedule: "L-V: 8:30-14:30"
            }
        ];

        let prescriptions = [
            {
                id: 1,
                patient_id: 1,
                patient_name: "Juan Pérez López",
                doctor: "Dr. María García",
                date: "2025-10-20",
                medications: [
                    {
                        name: "Enalapril",
                        dosage: "10mg",
                        frequency: "1 vez al día",
                        duration: "90 días"
                    }
                ],
                status: "Activa"
            },
            {
                id: 2,
                patient_id: 2,
                patient_name: "Ana Rodríguez Sánchez",
                doctor: "Dr. Pedro López",
                date: "2025-10-18",
                medications: [
                    {
                        name: "Ibuprofeno",
                        dosage: "600mg",
                        frequency: "3 veces al día",
                        duration: "7 días"
                    }
                ],
                status: "Activa"
            }
        ];

        // Advanced medical data structures
        let medications = [
            {
                id: 1,
                name: "Enalapril",
                generic_name: "Enalapril Maleato",
                category: "IECA",
                dosage_forms: ["5mg", "10mg", "20mg"],
                contraindications: ["Embarazo", "Angioedema previo"],
                interactions: ["Diuréticos", "AINEs"],
                stock: 250,
                min_stock: 50,
                expiry_date: "2026-08-15",
                manufacturer: "Cinfa",
                price: 4.50
            },
            {
                id: 2,
                name: "Ibuprofeno",
                generic_name: "Ibuprofeno",
                category: "AINE",
                dosage_forms: ["400mg", "600mg"],
                contraindications: ["Úlcera péptica", "Insuficiencia renal"],
                interactions: ["Anticoagulantes", "IECA"],
                stock: 180,
                min_stock: 30,
                expiry_date: "2027-03-20",
                manufacturer: "Kern Pharma",
                price: 2.80
            }
        ];

        let rooms = [
            {
                id: "101A",
                floor: 1,
                type: "Individual",
                status: "Disponible",
                equipment: ["Cama eléctrica", "Monitor", "Oxígeno"],
                capacity: 1,
                last_cleaning: "2025-10-22T06:00:00"
            },
            {
                id: "201A",
                floor: 2,
                type: "Individual",
                status: "Ocupada",
                patient_id: 3,
                equipment: ["Cama eléctrica", "Monitor cardíaco", "Oxígeno", "Desfibrilador"],
                capacity: 1,
                last_cleaning: "2025-10-21T06:00:00"
            }
        ];

        let laboratoryTests = [
            {
                id: 1,
                patient_id: 1,
                test_name: "Hemograma completo",
                ordered_by: "Dra. María García",
                order_date: "2025-10-20",
                status: "Completado",
                results_date: "2025-10-21",
                results: [
                    {
                        parameter: "Hemoglobina",
                        value: 14.2,
                        unit: "g/dL",
                        reference: "13.5-17.5",
                        status: "Normal"
                    },
                    {
                        parameter: "Leucocitos",
                        value: 7200,
                        unit: "/µL",
                        reference: "4000-11000",
                        status: "Normal"
                    }
                ],
                priority: "Rutina"
            }
        ];

        let surgeries = [
            {
                id: 1,
                patient_id: 3,
                patient_name: "Carlos Gómez Ruiz",
                procedure: "Angioplastia coronaria",
                surgeon: "Dr. José Martín",
                date: "2025-10-25",
                time: "09:00",
                duration: 120,
                room: "Quirófano 1",
                status: "Programada",
                anesthesiologist: "Dr. Ana Pérez",
                nurses: ["Ana Martínez", "Carmen López"]
            }
        ];

        let emergencies = [
            {
                id: 1,
                patient_name: "Luis García",
                arrival_time: "2025-10-22T14:30:00",
                triage_level: "Urgente",
                symptoms: "Dolor torácico",
                attending_doctor: "Dr. Urgencias",
                status: "En tratamiento",
                vital_signs: {
                    blood_pressure: "160/95",
                    heart_rate: 110,
                    temperature: 37.2,
                    oxygen_sat: 96
                }
            }
        ];

        let statistics = {
            patients_total: 342,
            patients_active: 298,
            patients_hospitalized: 24,
            appointments_today: 28,
            appointments_completed_today: 12,
            appointments_pending_today: 16,
            appointments_week: 156,
            appointments_month: 645,
            revenue_today: 1250.50,
            revenue_week: 8750.25,
            revenue_month: 35420.75,
            staff_total: 67,
            doctors_active: 23,
            nurses_active: 31,
            admin_staff: 13,
            bed_occupancy_rate: 78,
            average_wait_time: 15,
            satisfaction_score: 4.6,
            emergency_cases_today: 5
        };

        let notifications = [
            {
                id: 1,
                type: "urgent",
                title: "Emergencia en UCI",
                message: "Paciente en estado crítico requiere atención inmediata",
                time: "2025-10-22T15:00:00",
                read: false
            },
            {
                id: 2,
                type: "info",
                title: "Resultado de laboratorio",
                message: "Análisis de Juan Pérez disponible",
                time: "2025-10-22T14:30:00",
                read: false
            },
            {
                id: 3,
                type: "warning",
                title: "Stock bajo",
                message: "Medicamento Enalapril por debajo del mínimo",
                time: "2025-10-22T13:15:00",
                read: true
            }
        ];

        let communications = [
            {
                id: 1,
                from: "Dr. María García",
                to: "Ana Martínez",
                subject: "Paciente Carlos Gómez",
                message: "Por favor, prepare al paciente para la cirugía de mañana",
                time: "2025-10-22T14:45:00",
                read: false,
                urgent: true
            }
        ];

        // App state management
        let appState = {
            darkMode: false,
            sidebarCollapsed: false,
            activeFilters: {},
            searchResults: [],
            currentPage: 1,
            itemsPerPage: 10
        };

        let invoices = [
            {
                id: 1,
                patient_id: 1,
                patient_name: "Juan Pérez López",
                date: "2025-10-20",
                amount: 75.50,
                concept: "Consulta Cardiología",
                status: "Pagada",
                payment_method: "Tarjeta"
            },
            {
                id: 2,
                patient_id: 2,
                patient_name: "Ana Rodríguez Sánchez",
                date: "2025-10-18",
                amount: 45.00,
                concept: "Consulta Medicina General",
                status: "Pendiente",
                payment_method: "Efectivo"
            }
        ];

        // Authentication functions
        function login(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            const user = users.find(u => u.username === username && u.password === password);
            if (user) {
                currentUser = user;
                showScreen('twofa');
            } else {
                alert('Credenciales incorrectas');
            }
        }

        function verify2FA(event) {
            event.preventDefault();
            const code = document.getElementById('verificationCode').value;

            if (code === '123456') {
                showScreen('dashboard');
                document.getElementById('userName').textContent = currentUser.name;
                loadDashboard();
            } else {
                alert('Código incorrecto');
            }
        }

        function logout() {
            currentUser = null;
            showScreen('login');
            document.getElementById('loginForm').reset();
            document.getElementById('twofaForm').reset();
        }

        function showScreen(screen) {
            document.querySelectorAll('.login-screen, .twofa-screen, .dashboard').forEach(el => {
                el.classList.add('hidden');
            });

            switch(screen) {
                case 'login':
                    document.getElementById('loginScreen').classList.remove('hidden');
                    break;
                case 'twofa':
                    document.getElementById('twofaScreen').classList.remove('hidden');
                    break;
                case 'dashboard':
                    document.getElementById('dashboard').classList.remove('hidden');
                    break;
            }
        }

        // Navigation functions
        function showModule(moduleId) {
            // Hide all modules
            document.querySelectorAll('.module').forEach(module => {
                module.classList.add('hidden');
            });

            // Remove active class from all nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });

            // Show selected module
            document.getElementById(moduleId + 'Module').classList.remove('hidden');

            // Add active class to current nav link
            document.querySelector(`[data-module="${moduleId}"]`).classList.add('active');

            // Update header title
            const titles = {
                dashboard: 'Dashboard',
                patients: 'Gestión de Pacientes',
                appointments: 'Gestión de Citas',
                records: 'Historiales Médicos',
                doctors: 'Personal Sanitario',
                prescriptions: 'Recetas Médicas',
                billing: 'Facturación',
                mobile: 'Vista Móvil',
                settings: 'Configuración'
            };
            document.getElementById('headerTitle').textContent = titles[moduleId];

            currentModule = moduleId;
            loadModuleContent(moduleId);
        }

        function loadModuleContent(moduleId) {
            // Add breadcrumbs
            updateBreadcrumbs(moduleId);
            
            switch(moduleId) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'patients':
                    loadPatientsModule();
                    break;
                case 'appointments':
                    loadAppointmentsModule();
                    break;
                case 'records':
                    loadRecordsModule();
                    break;
                case 'doctors':
                    loadDoctorsModule();
                    break;
                case 'prescriptions':
                    loadPrescriptionsModule();
                    break;
                case 'billing':
                    loadBillingModule();
                    break;
                case 'inventory':
                    loadInventoryModule();
                    break;
                case 'laboratory':
                    loadLaboratoryModule();
                    break;
                case 'radiology':
                    loadRadiologyModule();
                    break;
                case 'surgery':
                    loadSurgeryModule();
                    break;
                case 'emergency':
                    loadEmergencyModule();
                    break;
                case 'rooms':
                    loadRoomsModule();
                    break;
                case 'communications':
                    loadCommunicationsModule();
                    break;
                case 'reports':
                    loadReportsModule();
                    break;
                case 'mobile':
                    loadMobileModule();
                    break;
                case 'settings':
                    loadSettingsModule();
                    break;
            }
        }

        function loadDashboard() {
            // Update real-time statistics
            updateDashboardStats();
            
            // Load appointments chart
            loadAppointmentsChart();
            
            // Load additional charts
            loadOccupancyChart();
            loadRevenueChart();

            // Load today's appointments
            const today = new Date().toISOString().split('T')[0];
            const todayAppointments = appointments.filter(apt => apt.date === '2025-10-23'); // Using demo date
            
            const container = document.getElementById('todayAppointments');
            if (todayAppointments.length === 0) {
                container.innerHTML = '<p style="color: var(--color-text-secondary);">No hay citas para hoy</p>';
            } else {
                container.innerHTML = todayAppointments.map(apt => `
                    <div style="padding: var(--space-12); border-bottom: 1px solid var(--color-border); display: flex; justify-content: space-between; animation: slideIn 0.3s ease-out;">
                        <div>
                            <strong>${apt.time}</strong><br>
                            <small>${apt.patient_name}</small><br>
                            <small style="color: var(--color-text-secondary);">${apt.doctor}</small>
                        </div>
                        <div style="text-align: right;">
                            <span class="status status--success">${apt.status}</span><br>
                            <small class="tooltip" data-tooltip="${apt.reason}">
                                <i class="fas fa-info-circle" style="color: var(--color-info);"></i>
                            </small>
                        </div>
                    </div>
                `).join('');
            }
            
            // Load urgent notifications
            loadUrgentAlerts();
        }
        
        function updateDashboardStats() {
            // Animate counters
            animateCounter('totalPatientsCount', statistics.patients_total);
            animateCounter('todayAppointmentsCount', statistics.appointments_today);
            animateCounter('occupancyRate', statistics.bed_occupancy_rate, '%');
            animateCounter('emergenciesToday', statistics.emergency_cases_today);
        }
        
        function animateCounter(elementId, target, suffix = '') {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            let current = 0;
            const increment = target / 50;
            const timer = setInterval(() => {
                current += increment;
                if (current >= target) {
                    current = target;
                    clearInterval(timer);
                }
                element.textContent = Math.floor(current) + suffix;
            }, 30);
        }
        
        function loadUrgentAlerts() {
            const urgentNotifications = notifications.filter(n => !n.read && n.type === 'urgent');
            if (urgentNotifications.length > 0) {
                // Show urgent notification toast
                showToast('urgent', urgentNotifications[0].title, urgentNotifications[0].message);
            }
        }
        
        function loadOccupancyChart() {
            // Add bed occupancy chart if canvas exists
            const ctx = document.getElementById('occupancyChart');
            if (ctx) {
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Ocupadas', 'Disponibles', 'Mantenimiento'],
                        datasets: [{
                            data: [78, 18, 4],
                            backgroundColor: ['#1FB8CD', '#FFC185', '#B4413C']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
        }
        
        function loadRevenueChart() {
            const ctx = document.getElementById('revenueChart');
            if (ctx) {
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'],
                        datasets: [{
                            label: 'Ingresos (€)',
                            data: [25000, 28000, 32000, 29000, 35000, 42000],
                            backgroundColor: '#1FB8CD'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        }

        function loadAppointmentsChart() {
            const ctx = document.getElementById('appointmentsChart');
            if (appointmentsChart) {
                appointmentsChart.destroy();
            }
            
            appointmentsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio'],
                    datasets: [{
                        label: 'Citas',
                        data: [65, 59, 80, 81, 56, 84],
                        borderColor: '#1FB8CD',
                        backgroundColor: 'rgba(31, 184, 205, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function loadPatientsModule() {
            const module = document.getElementById('patientsModule');
            module.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Gestión de Pacientes</h3>
                        <div>
                            <button class="btn btn--outline btn--sm" onclick="exportPatients()">
                                <i class="fas fa-download"></i> Exportar
                            </button>
                            <button class="btn btn--primary btn--sm" onclick="showPatientModal()">
                                <i class="fas fa-plus"></i> Nuevo Paciente
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="search-bar" style="margin-bottom: var(--space-16);">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="form-control search-input" id="patientSearch" placeholder="Buscar por nombre, DNI o teléfono..." onkeyup="filterPatients()">
                        </div>
                        <div class="filter-bar">
                            <div class="filter-chip active" data-filter="all" onclick="filterPatientsByStatus('all')">Todos</div>
                            <div class="filter-chip" data-filter="active" onclick="filterPatientsByStatus('active')">Activos</div>
                            <div class="filter-chip" data-filter="hospitalized" onclick="filterPatientsByStatus('hospitalized')">Hospitalizados</div>
                            <div class="filter-chip" data-filter="seguridad-social" onclick="filterPatientsByInsurance('Seguridad Social')">Seg. Social</div>
                            <div class="filter-chip" data-filter="privado" onclick="filterPatientsByInsurance('Privada')">Privado</div>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th onclick="sortPatients('name')" style="cursor: pointer;">
                                            Nombre <i class="fas fa-sort"></i>
                                        </th>
                                        <th onclick="sortPatients('dni')" style="cursor: pointer;">
                                            DNI <i class="fas fa-sort"></i>
                                        </th>
                                        <th onclick="sortPatients('phone')" style="cursor: pointer;">
                                            Teléfono <i class="fas fa-sort"></i>
                                        </th>
                                        <th>Seguro</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="patientsTableBody">
                                    <!-- Populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        <div id="patientsPagination"></div>
                    </div>
                </div>
            `;
            
            renderPatientsTable(patients);
        }
        
        function renderPatientsTable(data) {
            const tbody = document.getElementById('patientsTableBody');
            const paginated = paginateData(data, currentPage, itemsPerPage);
            
            tbody.innerHTML = paginated.data.map(patient => `
                <tr class="fade-in">
                    <td>
                        <strong>${patient.name}</strong><br>
                        <small style="color: var(--color-text-secondary);">${patient.email || 'No email'}</small>
                    </td>
                    <td>${patient.dni}</td>
                    <td>${patient.phone}</td>
                    <td>
                        <span class="filter-chip">${patient.insurance}</span>
                    </td>
                    <td>
                        <span class="status ${
                            patient.status === 'hospitalized' ? 'status--warning' :
                            patient.status === 'active' ? 'status--success' : 'status--info'
                        }">
                            ${patient.status === 'hospitalized' ? 'Hospitalizado' : 'Activo'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn--outline btn--sm" onclick="viewPatient(${patient.id})" title="Ver detalles">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn--outline btn--sm" onclick="editPatient(${patient.id})" title="Editar" style="margin-left: var(--space-4);">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn--outline btn--sm" onclick="createAppointmentForPatient(${patient.id})" title="Nueva cita" style="margin-left: var(--space-4);">
                            <i class="fas fa-calendar-plus"></i>
                        </button>
                        <button class="btn btn--outline btn--sm" onclick="deletePatient(${patient.id})" title="Eliminar" style="margin-left: var(--space-4);">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            // Add pagination
            const paginationContainer = document.getElementById('patientsPagination');
            paginationContainer.innerHTML = createPaginationControls(
                paginated.totalPages,
                paginated.currentPage,
                'changePatientPage'
            );
        }
        
        function filterPatients() {
            const searchTerm = document.getElementById('patientSearch').value.toLowerCase();
            const filtered = patients.filter(patient => 
                patient.name.toLowerCase().includes(searchTerm) ||
                patient.dni.toLowerCase().includes(searchTerm) ||
                patient.phone.includes(searchTerm) ||
                (patient.email && patient.email.toLowerCase().includes(searchTerm))
            );
            currentPage = 1;
            renderPatientsTable(filtered);
        }
        
        function filterPatientsByStatus(status) {
            // Update filter chips
            document.querySelectorAll('.filter-chip').forEach(chip => chip.classList.remove('active'));
            document.querySelector(`[data-filter="${status}"]`).classList.add('active');
            
            const filtered = status === 'all' ? patients : patients.filter(p => p.status === status);
            currentPage = 1;
            renderPatientsTable(filtered);
            showToast('info', 'Filtro aplicado', `Mostrando pacientes: ${status === 'all' ? 'todos' : status}`);
        }
        
        function filterPatientsByInsurance(insurance) {
            document.querySelectorAll('.filter-chip').forEach(chip => chip.classList.remove('active'));
            event.target.classList.add('active');
            
            const filtered = patients.filter(p => p.insurance.includes(insurance));
            currentPage = 1;
            renderPatientsTable(filtered);
            showToast('info', 'Filtro aplicado', `Mostrando pacientes con ${insurance}`);
        }
        
        function sortPatients(column) {
            sortTable('patientsTable', column, patients, renderPatientsTable);
        }
        
        function changePatientPage(page) {
            currentPage = page;
            const searchTerm = document.getElementById('patientSearch')?.value.toLowerCase() || '';
            const filtered = searchTerm ? 
                patients.filter(patient => 
                    patient.name.toLowerCase().includes(searchTerm) ||
                    patient.dni.toLowerCase().includes(searchTerm) ||
                    patient.phone.includes(searchTerm)
                ) : patients;
            renderPatientsTable(filtered);
        }
        
        function viewPatient(id) {
            const patient = patients.find(p => p.id === id);
            const patientAppointments = appointments.filter(a => a.patient_id === id);
            const patientRecords = medicalRecords.filter(r => r.patient_id === id);
            const patientPrescriptions = prescriptions.filter(p => p.patient_id === id);
            
            document.getElementById('modalTitle').textContent = `Perfil del Paciente - ${patient.name}`;
            document.getElementById('modalBody').innerHTML = `
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--space-20);">
                    <div>
                        <div class="card" style="margin-bottom: var(--space-16);">
                            <div class="card-header">
                                <h5 class="card-title">Información Personal</h5>
                            </div>
                            <div class="card-body">
                                <div class="form-row" style="margin-bottom: var(--space-12);">
                                    <div><strong>DNI:</strong> ${patient.dni}</div>
                                    <div><strong>Edad:</strong> ${patient.age || 'N/A'} años</div>
                                </div>
                                <div class="form-row" style="margin-bottom: var(--space-12);">
                                    <div><strong>Teléfono:</strong> ${patient.phone}</div>
                                    <div><strong>Email:</strong> ${patient.email || 'No registrado'}</div>
                                </div>
                                <div style="margin-bottom: var(--space-12);">
                                    <strong>Dirección:</strong> ${patient.address || 'No registrada'}
                                </div>
                                <div class="form-row">
                                    <div><strong>Seguro:</strong> ${patient.insurance}</div>
                                    <div><strong>Estado:</strong> 
                                        <span class="status ${
                                            patient.status === 'hospitalized' ? 'status--warning' : 'status--success'
                                        }">
                                            ${patient.status === 'hospitalized' ? 'Hospitalizado' : 'Activo'}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title">Historial Médico Reciente</h5>
                            </div>
                            <div class="card-body">
                                ${patientRecords.length > 0 ? 
                                    patientRecords.slice(0, 3).map(record => `
                                        <div style="margin-bottom: var(--space-12); padding: var(--space-8); border-left: 3px solid var(--color-primary); background: var(--color-bg-1);">
                                            <div><strong>${record.date}</strong> - ${record.doctor}</div>
                                            <div style="margin: var(--space-4) 0;">${record.diagnosis}</div>
                                            <small style="color: var(--color-text-secondary);">${record.treatment}</small>
                                        </div>
                                    `).join('') :
                                    '<p style="color: var(--color-text-secondary);">Sin historial médico registrado</p>'
                                }
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <div class="card" style="margin-bottom: var(--space-16);">
                            <div class="card-header">
                                <h5 class="card-title">Próximas Citas</h5>
                            </div>
                            <div class="card-body">
                                ${patientAppointments.filter(a => new Date(a.date) >= new Date()).length > 0 ?
                                    patientAppointments.filter(a => new Date(a.date) >= new Date()).slice(0, 3).map(apt => `
                                        <div style="margin-bottom: var(--space-8); padding: var(--space-8); border: 1px solid var(--color-border); border-radius: var(--radius-base);">
                                            <div><strong>${apt.date}</strong> ${apt.time}</div>
                                            <div style="font-size: var(--font-size-sm);">${apt.doctor}</div>
                                            <div style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">${apt.reason}</div>
                                        </div>
                                    `).join('') :
                                    '<p style="color: var(--color-text-secondary); font-size: var(--font-size-sm);">Sin citas próximas</p>'
                                }
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title">Prescripciones Activas</h5>
                            </div>
                            <div class="card-body">
                                ${patientPrescriptions.filter(p => p.status === 'Activa').length > 0 ?
                                    patientPrescriptions.filter(p => p.status === 'Activa').slice(0, 2).map(presc => `
                                        <div style="margin-bottom: var(--space-8); padding: var(--space-8); border: 1px solid var(--color-border); border-radius: var(--radius-base);">
                                            <div><strong>${presc.date}</strong></div>
                                            <div style="font-size: var(--font-size-sm);">${presc.doctor}</div>
                                            ${presc.medications.map(med => `
                                                <div style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">
                                                    • ${med.name} ${med.dosage} - ${med.frequency}
                                                </div>
                                            `).join('')}
                                        </div>
                                    `).join('') :
                                    '<p style="color: var(--color-text-secondary); font-size: var(--font-size-sm);">Sin prescripciones activas</p>'
                                }
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: var(--space-12); justify-content: flex-end; margin-top: var(--space-20);">
                    <button type="button" class="btn btn--outline" onclick="closeModal()">Cerrar</button>
                    <button type="button" class="btn btn--outline" onclick="createAppointmentForPatient(${id})">Nueva Cita</button>
                    <button type="button" class="btn btn--primary" onclick="editPatient(${id})">Editar Datos</button>
                </div>
            `;
            
            document.getElementById('formModal').classList.add('active');
        }
        
        function createAppointmentForPatient(patientId) {
            closeModal();
            setTimeout(() => {
                showAppointmentModal();
                // Pre-select the patient
                setTimeout(() => {
                    const patientSelect = document.querySelector('select[name="patient_id"]');
                    if (patientSelect) {
                        patientSelect.value = patientId;
                        // Trigger change event to update specialty if needed
                        patientSelect.dispatchEvent(new Event('change'));
                    }
                }, 100);
            }, 100);
        }
        
        function exportPatients() {
            const csvContent = [
                ['Nombre', 'DNI', 'Teléfono', 'Email', 'Seguro', 'Estado', 'Última Visita'],
                ...patients.map(p => [
                    p.name,
                    p.dni,
                    p.phone,
                    p.email || '',
                    p.insurance,
                    p.status,
                    p.last_visit || 'N/A'
                ])
            ].map(row => row.join(',')).join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pacientes_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showToast('success', 'Exportación completa', 'Lista de pacientes exportada como CSV');
        }

        function loadAppointmentsModule() {
            const module = document.getElementById('appointmentsModule');
            module.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Gestión de Citas</h3>
                        <button class="btn btn--primary btn--sm" onclick="showAppointmentModal()">
                            <i class="fas fa-plus"></i> Nueva Cita
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Paciente</th>
                                        <th>Doctor</th>
                                        <th>Fecha</th>
                                        <th>Hora</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${appointments.map(apt => `
                                        <tr>
                                            <td>${apt.patient_name}</td>
                                            <td>${apt.doctor}<br><small style="color: var(--color-text-secondary);">${apt.specialty}</small></td>
                                            <td>${apt.date}</td>
                                            <td>${apt.time}</td>
                                            <td><span class="status status--success">${apt.status}</span></td>
                                            <td>
                                                <button class="btn btn--outline btn--sm" onclick="editAppointment(${apt.id})">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn--outline btn--sm" onclick="cancelAppointment(${apt.id})" style="margin-left: var(--space-8);">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function loadRecordsModule() {
            const module = document.getElementById('recordsModule');
            module.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Historiales Médicos</h3>
                        <button class="btn btn--primary btn--sm" onclick="showRecordModal()">
                            <i class="fas fa-plus"></i> Nuevo Historial
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Paciente</th>
                                        <th>Fecha</th>
                                        <th>Doctor</th>
                                        <th>Diagnóstico</th>
                                        <th>Tratamiento</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${medicalRecords.map(record => {
                                        const patient = patients.find(p => p.id === record.patient_id);
                                        return `
                                            <tr>
                                                <td>${patient ? patient.name : 'N/A'}</td>
                                                <td>${record.date}</td>
                                                <td>${record.doctor}</td>
                                                <td>${record.diagnosis}</td>
                                                <td>${record.treatment}</td>
                                                <td>
                                                    <button class="btn btn--outline btn--sm" onclick="viewRecord(${record.id})">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button class="btn btn--outline btn--sm" onclick="editRecord(${record.id})" style="margin-left: var(--space-8);">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function loadDoctorsModule() {
            const module = document.getElementById('doctorsModule');
            module.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Personal Sanitario</h3>
                        <button class="btn btn--primary btn--sm" onclick="showDoctorModal()">
                            <i class="fas fa-plus"></i> Nuevo Personal
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Especialidad</th>
                                        <th>Colegiado</th>
                                        <th>Teléfono</th>
                                        <th>Horario</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${doctors.map(doctor => `
                                        <tr>
                                            <td>${doctor.name}</td>
                                            <td>${doctor.specialty}</td>
                                            <td>${doctor.license}</td>
                                            <td>${doctor.phone}</td>
                                            <td>${doctor.schedule}</td>
                                            <td>
                                                <button class="btn btn--outline btn--sm" onclick="editDoctor(${doctor.id})">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn--outline btn--sm" onclick="deleteDoctor(${doctor.id})" style="margin-left: var(--space-8);">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function loadPrescriptionsModule() {
            const module = document.getElementById('prescriptionsModule');
            module.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Recetas Médicas</h3>
                        <button class="btn btn--primary btn--sm" onclick="showPrescriptionModal()">
                            <i class="fas fa-plus"></i> Nueva Receta
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Paciente</th>
                                        <th>Doctor</th>
                                        <th>Fecha</th>
                                        <th>Medicamentos</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${prescriptions.map(prescription => `
                                        <tr>
                                            <td>${prescription.patient_name}</td>
                                            <td>${prescription.doctor}</td>
                                            <td>${prescription.date}</td>
                                            <td>
                                                ${prescription.medications.map(med => 
                                                    `<div><strong>${med.name}</strong> ${med.dosage} - ${med.frequency}</div>`
                                                ).join('')}
                                            </td>
                                            <td><span class="status status--success">${prescription.status}</span></td>
                                            <td>
                                                <button class="btn btn--outline btn--sm" onclick="printPrescription(${prescription.id})">
                                                    <i class="fas fa-print"></i>
                                                </button>
                                                <button class="btn btn--outline btn--sm" onclick="editPrescription(${prescription.id})" style="margin-left: var(--space-8);">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function loadBillingModule() {
            const module = document.getElementById('billingModule');
            module.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Facturación</h3>
                        <button class="btn btn--primary btn--sm" onclick="showInvoiceModal()">
                            <i class="fas fa-plus"></i> Nueva Factura
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="stats-grid" style="margin-bottom: var(--space-20);">
                            <div class="stat-card">
                                <div class="stat-number">€15.750</div>
                                <div class="stat-label">Ingresos Mes</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">€2.340</div>
                                <div class="stat-label">Pendiente Cobro</div>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Paciente</th>
                                        <th>Fecha</th>
                                        <th>Concepto</th>
                                        <th>Importe</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${invoices.map(invoice => `
                                        <tr>
                                            <td>${invoice.patient_name}</td>
                                            <td>${invoice.date}</td>
                                            <td>${invoice.concept}</td>
                                            <td>€${invoice.amount.toFixed(2)}</td>
                                            <td><span class="status ${invoice.status === 'Pagada' ? 'status--success' : 'status--warning'}">${invoice.status}</span></td>
                                            <td>
                                                <button class="btn btn--outline btn--sm" onclick="printInvoice(${invoice.id})">
                                                    <i class="fas fa-print"></i>
                                                </button>
                                                ${invoice.status === 'Pendiente' ? 
                                                    `<button class="btn btn--outline btn--sm" onclick="markAsPaid(${invoice.id})" style="margin-left: var(--space-8);">
                                                        <i class="fas fa-check"></i>
                                                    </button>` : ''}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function loadMobileModule() {
            const module = document.getElementById('mobileModule');
            module.innerHTML = `
                <div style="max-width: 400px; margin: 0 auto;">
                    <div class="view-toggle">
                        <h3>Vista Móvil - Funciones Rápidas</h3>
                        <div style="margin-bottom: var(--space-16);">
                            <button class="btn btn--outline btn--sm" onclick="startRealQRScanner()" style="margin-right: var(--space-8);">
                                <i class="fas fa-camera"></i> Escáner QR Real
                            </button>
                            <button class="btn btn--outline btn--sm" onclick="loadAdvancedCalendar()" style="margin-right: var(--space-8);">
                                <i class="fas fa-calendar-alt"></i> Calendario Avanzado
                            </button>
                            <button class="btn btn--outline btn--sm" onclick="startDictation()">
                                <i class="fas fa-microphone"></i> Dictado por Voz
                            </button>
                        </div>
                        <p style="color: var(--color-text-secondary); margin-bottom: var(--space-20);">Simula la versión móvil de HospiSafe</p>
                    </div>
                    
                    <div class="card" style="margin-bottom: var(--space-16);">
                        <div class="card-header">
                            <h4 class="card-title">Escáner QR</h4>
                        </div>
                        <div class="card-body">
                            <div class="qr-scanner">
                                <div class="scan-area">
                                    <div class="scan-line"></div>
                                    <i class="fas fa-qrcode" style="font-size: 3rem; opacity: 0.5;"></i>
                                </div>
                                <p>Simulando escáner QR para ubicaciones hospitalarias</p>
                                <button class="btn btn--primary" onclick="simulateQRScan()">
                                    <i class="fas fa-camera"></i> Simular Escaneo
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="card" style="margin-bottom: var(--space-16);">
                        <div class="card-header">
                            <h4 class="card-title">Citas de Hoy</h4>
                        </div>
                        <div class="card-body">
                            ${appointments.filter(apt => apt.date === '2025-10-23').map(apt => `
                                <div style="padding: var(--space-12); border: 1px solid var(--color-border); border-radius: var(--radius-base); margin-bottom: var(--space-8);">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <strong>${apt.time}</strong><br>
                                            <span>${apt.patient_name}</span><br>
                                            <small style="color: var(--color-text-secondary);">${apt.reason}</small>
                                        </div>
                                        <span class="status status--success">${apt.status}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">Notificaciones</h4>
                        </div>
                        <div class="card-body">
                            <div style="padding: var(--space-12); border: 1px solid var(--color-border); border-radius: var(--radius-base); margin-bottom: var(--space-8); background: var(--color-bg-2);">
                                <i class="fas fa-bell"></i> Nueva cita programada para mañana
                            </div>
                            <div style="padding: var(--space-12); border: 1px solid var(--color-border); border-radius: var(--radius-base); margin-bottom: var(--space-8); background: var(--color-bg-3);">
                                <i class="fas fa-file-medical"></i> Resultado de análisis disponible
                            </div>
                            <div style="padding: var(--space-12); border: 1px solid var(--color-border); border-radius: var(--radius-base); background: var(--color-bg-1);">
                                <i class="fas fa-pills"></i> Recordatorio: Receta por vencer
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function loadSettingsModule() {
            const module = document.getElementById('settingsModule');
            module.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--space-20);">
                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">Perfil de Usuario</h4>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Nombre</label>
                                <input type="text" class="form-control" value="${currentUser.name}" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" value="${currentUser.email}" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Rol</label>
                                <input type="text" class="form-control" value="${currentUser.role}" readonly>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">Configuración del Sistema</h4>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Idioma</label>
                                <select class="form-control">
                                    <option selected>Español</option>
                                    <option>English</option>
                                    <option>Français</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Zona Horaria</label>
                                <select class="form-control">
                                    <option selected>Europa/Madrid</option>
                                    <option>America/New_York</option>
                                    <option>Asia/Tokyo</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">Seguridad &amp; Privacidad</h4>
                        </div>
                        <div class="card-body">
                            <div style="margin-bottom: var(--space-16);">
                                <h5 style="margin-bottom: var(--space-8);">RGPD - Cumplimiento</h5>
                                <p style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-12);">Los datos están protegidos según el Reglamento General de Protección de Datos.</p>
                                <button class="btn btn--outline btn--sm" onclick="showAuditLog()">
                                    <i class="fas fa-shield-alt"></i> Ver Auditoría
                                </button>
                            </div>
                            <div>
                                <h5 style="margin-bottom: var(--space-8);">Copia de Seguridad</h5>
                                <p style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-12);">Última copia: 22/10/2025 - 02:00</p>
                                <button class="btn btn--primary btn--sm" onclick="simulateBackup()">
                                    <i class="fas fa-download"></i> Crear Copia
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">Gestión de Usuarios</h4>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Usuario</th>
                                            <th>Rol</th>
                                            <th>Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${users.map(user => `
                                            <tr>
                                                <td>${user.name}<br><small style="color: var(--color-text-secondary);">${user.email}</small></td>
                                                <td>${user.role}</td>
                                                <td><span class="status status--success">Activo</span></td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Modal functions
        function showPatientModal(patientId = null) {
            const patient = patientId ? patients.find(p => p.id === patientId) : {};
            const isEdit = !!patientId;
            
            document.getElementById('modalTitle').textContent = isEdit ? 'Editar Paciente' : 'Nuevo Paciente';
            document.getElementById('modalBody').innerHTML = `
                <form id="patientForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Nombre Completo</label>
                            <input type="text" name="name" class="form-control" value="${patient.name || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">DNI</label>
                            <input type="text" name="dni" class="form-control" value="${patient.dni || ''}" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Fecha de Nacimiento</label>
                            <input type="date" name="birthdate" class="form-control" value="${patient.birthdate || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Teléfono</label>
                            <input type="tel" name="phone" class="form-control" value="${patient.phone || ''}" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" name="email" class="form-control" value="${patient.email || ''}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Dirección</label>
                        <input type="text" name="address" class="form-control" value="${patient.address || ''}" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Seguro Médico</label>
                            <select name="insurance" class="form-control" required>
                                <option value="">Seleccionar...</option>
                                <option value="Seguridad Social" ${patient.insurance === 'Seguridad Social' ? 'selected' : ''}>Seguridad Social</option>
                                <option value="Privada - Sanitas" ${patient.insurance === 'Privada - Sanitas' ? 'selected' : ''}>Privada - Sanitas</option>
                                <option value="Privada - Adeslas" ${patient.insurance === 'Privada - Adeslas' ? 'selected' : ''}>Privada - Adeslas</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Contacto de Emergencia</label>
                            <input type="text" name="emergency_contact" class="form-control" value="${patient.emergency_contact || ''}" placeholder="Nombre - Teléfono" required>
                        </div>
                    </div>
                    <div style="display: flex; gap: var(--space-12); justify-content: flex-end; margin-top: var(--space-20);">
                        <button type="button" class="btn btn--outline" onclick="closeModal()">Cancelar</button>
                        <button type="submit" class="btn btn--primary">Guardar</button>
                    </div>
                </form>
            `;
            
            document.getElementById('formModal').classList.add('active');
            
            document.getElementById('patientForm').onsubmit = function(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                const errors = validatePatientData(formData);
                
                if (showValidationErrors(errors)) {
                    savePatient(formData, patientId);
                }
            };
        }

        function savePatient(formData, patientId) {
            const patientData = {
                name: formData.get('name'),
                dni: formData.get('dni'),
                birthdate: formData.get('birthdate'),
                phone: formData.get('phone'),
                email: formData.get('email'),
                address: formData.get('address'),
                insurance: formData.get('insurance'),
                emergency_contact: formData.get('emergency_contact')
            };
            
            if (patientId) {
                const index = patients.findIndex(p => p.id === patientId);
                patients[index] = { ...patients[index], ...patientData };
            } else {
                patientData.id = Math.max(...patients.map(p => p.id)) + 1;
                patients.push(patientData);
            }
            
            closeModal();
            loadPatientsModule();
        }

        function editPatient(patientId) {
            showPatientModal(patientId);
        }

        function deletePatient(patientId) {
            if (confirm('¿Está seguro de que desea eliminar este paciente?')) {
                const index = patients.findIndex(p => p.id === patientId);
                patients.splice(index, 1);
                loadPatientsModule();
            }
        }

        function closeModal() {
            document.getElementById('formModal').classList.remove('active');
        }

        // === INVENTORY MANAGEMENT ===
        function exportInventory() {
            // Generate CSV content
            const csvContent = [
                ['Medicamento', 'Categoría', 'Stock', 'Stock Mínimo', 'Precio', 'Vencimiento'],
                ...medications.map(med => [
                    med.name,
                    med.category,
                    med.stock,
                    med.min_stock,
                    med.price,
                    med.expiry_date
                ])
            ].map(row => row.join(',')).join('\n');
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `inventario_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showToast('success', 'Exportación completa', 'Inventario exportado como CSV');
        }
        
        function showMedicationModal(medicationId = null) {
            const medication = medicationId ? medications.find(m => m.id === medicationId) : {};
            const isEdit = !!medicationId;
            
            document.getElementById('modalTitle').textContent = isEdit ? 'Editar Medicamento' : 'Nuevo Medicamento';
            document.getElementById('modalBody').innerHTML = `
                <form id="medicationForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Nombre Comercial</label>
                            <input type="text" name="name" class="form-control" value="${medication.name || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nombre Genérico</label>
                            <input type="text" name="generic_name" class="form-control" value="${medication.generic_name || ''}" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Categoría</label>
                            <select name="category" class="form-control" required>
                                <option value="">Seleccionar...</option>
                                <option value="IECA" ${medication.category === 'IECA' ? 'selected' : ''}>IECA</option>
                                <option value="AINE" ${medication.category === 'AINE' ? 'selected' : ''}>AINE</option>
                                <option value="Antibiótico" ${medication.category === 'Antibiótico' ? 'selected' : ''}>Antibiótico</option>
                                <option value="Analgésico" ${medication.category === 'Analgésico' ? 'selected' : ''}>Analgésico</option>
                                <option value="Antihipertensivo" ${medication.category === 'Antihipertensivo' ? 'selected' : ''}>Antihipertensivo</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Precio (€)</label>
                            <input type="number" name="price" class="form-control" value="${medication.price || ''}" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Stock Actual</label>
                            <input type="number" name="stock" class="form-control" value="${medication.stock || ''}" min="0" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Stock Mínimo</label>
                            <input type="number" name="min_stock" class="form-control" value="${medication.min_stock || ''}" min="0" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Fecha de Vencimiento</label>
                        <input type="date" name="expiry_date" class="form-control" value="${medication.expiry_date || ''}" required>
                    </div>
                    <div style="display: flex; gap: var(--space-12); justify-content: flex-end; margin-top: var(--space-20);">
                        <button type="button" class="btn btn--outline" onclick="closeModal()">Cancelar</button>
                        <button type="submit" class="btn btn--primary">Guardar</button>
                    </div>
                </form>
            `;
            
            document.getElementById('formModal').classList.add('active');
            
            document.getElementById('medicationForm').onsubmit = function(e) {
                e.preventDefault();
                saveMedication(new FormData(e.target), medicationId);
            };
        }
        
        function saveMedication(formData, medicationId) {
            const medicationData = {
                name: formData.get('name'),
                generic_name: formData.get('generic_name'),
                category: formData.get('category'),
                price: parseFloat(formData.get('price')),
                stock: parseInt(formData.get('stock')),
                min_stock: parseInt(formData.get('min_stock')),
                expiry_date: formData.get('expiry_date')
            };
            
            if (medicationId) {
                const index = medications.findIndex(m => m.id === medicationId);
                medications[index] = { ...medications[index], ...medicationData };
                showToast('success', 'Medicamento actualizado', 'Los datos del medicamento se han actualizado');
            } else {
                medicationData.id = Math.max(...medications.map(m => m.id)) + 1;
                medications.push(medicationData);
                showToast('success', 'Medicamento agregado', 'Nuevo medicamento registrado en inventario');
            }
            
            closeModal();
            if (currentModule === 'inventory') loadInventoryModule();
        }
        
        function editMedication(id) {
            showMedicationModal(id);
        }
        
        function orderMedication(id) {
            const medication = medications.find(m => m.id === id);
            if (medication && confirm(`¿Confirma el pedido de ${medication.name}?\nCantidad sugerida: ${medication.min_stock * 2} unidades`)) {
                medication.stock += medication.min_stock * 2;
                showToast('success', 'Pedido realizado', `Pedido de ${medication.name} procesado. Stock actualizado.`);
                if (currentModule === 'inventory') loadInventoryModule();
            }
        }
        
        // === LABORATORY MANAGEMENT ===
        function showLabTestModal(testId = null) {
            const test = testId ? laboratoryTests.find(t => t.id === testId) : {};
            const isEdit = !!testId;
            
            document.getElementById('modalTitle').textContent = isEdit ? 'Editar Análisis' : 'Nueva Solicitud de Laboratorio';
            document.getElementById('modalBody').innerHTML = `
                <form id="labTestForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Paciente</label>
                            <select name="patient_id" class="form-control" required>
                                <option value="">Seleccionar paciente...</option>
                                ${patients.map(p => `<option value="${p.id}" ${test.patient_id == p.id ? 'selected' : ''}>${p.name} - ${p.dni}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Médico Solicitante</label>
                            <input type="text" name="ordered_by" class="form-control" value="${test.ordered_by || currentUser.name}" readonly>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Tipo de Análisis</label>
                            <select name="test_name" class="form-control" required>
                                <option value="">Seleccionar...</option>
                                <option value="Hemograma completo" ${test.test_name === 'Hemograma completo' ? 'selected' : ''}>Hemograma completo</option>
                                <option value="Bioquímica básica" ${test.test_name === 'Bioquímica básica' ? 'selected' : ''}>Bioquímica básica</option>
                                <option value="Perfil lipídico" ${test.test_name === 'Perfil lipídico' ? 'selected' : ''}>Perfil lipídico</option>
                                <option value="Función hepática" ${test.test_name === 'Función hepática' ? 'selected' : ''}>Función hepática</option>
                                <option value="Función renal" ${test.test_name === 'Función renal' ? 'selected' : ''}>Función renal</option>
                                <option value="Hormonal tiroideo" ${test.test_name === 'Hormonal tiroideo' ? 'selected' : ''}>Hormonal tiroideo</option>
                                <option value="Marcadores tumorales" ${test.test_name === 'Marcadores tumorales' ? 'selected' : ''}>Marcadores tumorales</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Prioridad</label>
                            <select name="priority" class="form-control" required>
                                <option value="Rutina" ${test.priority === 'Rutina' ? 'selected' : ''}>Rutina</option>
                                <option value="Urgente" ${test.priority === 'Urgente' ? 'selected' : ''}>Urgente</option>
                                <option value="Stat" ${test.priority === 'Stat' ? 'selected' : ''}>Stat (Inmediato)</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Fecha de Solicitud</label>
                        <input type="date" name="order_date" class="form-control" value="${test.order_date || new Date().toISOString().split('T')[0]}" required>
                    </div>
                    <div style="display: flex; gap: var(--space-12); justify-content: flex-end; margin-top: var(--space-20);">
                        <button type="button" class="btn btn--outline" onclick="closeModal()">Cancelar</button>
                        <button type="submit" class="btn btn--primary">Solicitar Análisis</button>
                    </div>
                </form>
            `;
            
            document.getElementById('formModal').classList.add('active');
            
            document.getElementById('labTestForm').onsubmit = function(e) {
                e.preventDefault();
                saveLabTest(new FormData(e.target), testId);
            };
        }
        
        function saveLabTest(formData, testId) {
            const testData = {
                patient_id: parseInt(formData.get('patient_id')),
                test_name: formData.get('test_name'),
                ordered_by: formData.get('ordered_by'),
                order_date: formData.get('order_date'),
                priority: formData.get('priority'),
                status: testId ? laboratoryTests.find(t => t.id === testId).status : 'Pendiente'
            };
            
            if (testId) {
                const index = laboratoryTests.findIndex(t => t.id === testId);
                laboratoryTests[index] = { ...laboratoryTests[index], ...testData };
                showToast('success', 'Análisis actualizado', 'La solicitud de análisis se ha actualizado');
            } else {
                testData.id = Math.max(...laboratoryTests.map(t => t.id)) + 1;
                laboratoryTests.push(testData);
                showToast('success', 'Análisis solicitado', 'Nueva solicitud de laboratorio registrada');
            }
            
            closeModal();
            if (currentModule === 'laboratory') loadLaboratoryModule();
        }
        
        function viewLabResults(id) {
            const test = laboratoryTests.find(t => t.id === id);
            const patient = patients.find(p => p.id === test.patient_id);
            
            document.getElementById('modalTitle').textContent = 'Resultados de Laboratorio';
            document.getElementById('modalBody').innerHTML = `
                <div style="margin-bottom: var(--space-20);">
                    <h4 style="color: var(--color-primary); margin-bottom: var(--space-12);">${test.test_name}</h4>
                    <div class="form-row">
                        <div><strong>Paciente:</strong> ${patient ? patient.name : 'N/A'}</div>
                        <div><strong>Fecha:</strong> ${test.results_date || test.order_date}</div>
                    </div>
                </div>
                
                ${test.results ? `
                    <div class="card" style="margin-bottom: var(--space-16);">
                        <div class="card-header">
                            <h5 class="card-title">Resultados</h5>
                        </div>
                        <div class="card-body">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Parámetro</th>
                                        <th>Valor</th>
                                        <th>Unidad</th>
                                        <th>Referencia</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${test.results.map(result => `
                                        <tr>
                                            <td>${result.parameter}</td>
                                            <td>${result.value}</td>
                                            <td>${result.unit}</td>
                                            <td>${result.reference}</td>
                                            <td><span class="status ${result.status === 'Normal' ? 'status--success' : 'status--warning'}">${result.status}</span></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                ` : '<p style="color: var(--color-text-secondary);">Resultados pendientes</p>'}
                
                <div style="display: flex; gap: var(--space-12); justify-content: flex-end; margin-top: var(--space-20);">
                    <button type="button" class="btn btn--outline" onclick="closeModal()">Cerrar</button>
                    ${test.results ? '<button type="button" class="btn btn--primary" onclick="printLabResults(' + id + ')">Imprimir</button>' : ''}
                </div>
            `;
            
            document.getElementById('formModal').classList.add('active');
        }
        
        function processLabTest(id) {
            const test = laboratoryTests.find(t => t.id === id);
            if (test && confirm('¿Procesar este análisis de laboratorio?')) {
                test.status = 'En proceso';
                showToast('info', 'Análisis en proceso', `${test.test_name} está siendo procesado`);
                
                // Simulate processing time
                setTimeout(() => {
                    test.status = 'Completado';
                    test.results_date = new Date().toISOString().split('T')[0];
                    // Add mock results based on test type
                    if (test.test_name === 'Hemograma completo') {
                        test.results = [
                            { parameter: 'Hemoglobina', value: 14.2, unit: 'g/dL', reference: '13.5-17.5', status: 'Normal' },
                            { parameter: 'Hematocrito', value: 42.1, unit: '%', reference: '41-50', status: 'Normal' },
                            { parameter: 'Leucocitos', value: 7200, unit: '/µL', reference: '4000-11000', status: 'Normal' }
                        ];
                    }
                    showToast('success', 'Análisis completado', `${test.test_name} - Resultados disponibles`);
                    if (currentModule === 'laboratory') loadLaboratoryModule();
                }, 3000);
                
                if (currentModule === 'laboratory') loadLaboratoryModule();
            }
        }
        
        function printLabResults(id) {
            const test = laboratoryTests.find(t => t.id === id);
            const patient = patients.find(p => p.id === test.patient_id);
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Resultados de Laboratorio - ${patient ? patient.name : 'N/A'}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; }
                        .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 30px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .normal { color: green; }
                        .abnormal { color: red; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>RESULTADOS DE LABORATORIO</h1>
                        <p>HospiSafe - Sistema de Gestión Hospitalaria</p>
                    </div>
                    <p><strong>Paciente:</strong> ${patient ? patient.name : 'N/A'} - ${patient ? patient.dni : 'N/A'}</p>
                    <p><strong>Análisis:</strong> ${test.test_name}</p>
                    <p><strong>Fecha:</strong> ${test.results_date}</p>
                    <p><strong>Médico:</strong> ${test.ordered_by}</p>
                    
                    ${test.results ? `
                        <table>
                            <thead>
                                <tr>
                                    <th>Parámetro</th>
                                    <th>Valor</th>
                                    <th>Unidad</th>
                                    <th>Referencia</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${test.results.map(result => `
                                    <tr>
                                        <td>${result.parameter}</td>
                                        <td>${result.value}</td>
                                        <td>${result.unit}</td>
                                        <td>${result.reference}</td>
                                        <td class="${result.status === 'Normal' ? 'normal' : 'abnormal'}">${result.status}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    ` : '<p>Resultados pendientes</p>'}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
            showToast('success', 'Impresión', 'Resultados enviados a imprimir');
        }
        
        // === RADIOLOGY MANAGEMENT ===
        function showRadiologyModal() {
            document.getElementById('modalTitle').textContent = 'Nueva Solicitud de Radiología';
            document.getElementById('modalBody').innerHTML = `
                <form id="radiologyForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Paciente</label>
                            <select name="patient_id" class="form-control" required>
                                <option value="">Seleccionar paciente...</option>
                                ${patients.map(p => `<option value="${p.id}">${p.name} - ${p.dni}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Médico Solicitante</label>
                            <input type="text" name="requesting_doctor" class="form-control" value="${currentUser.name}" readonly>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Tipo de Estudio</label>
                            <select name="study_type" class="form-control" required>
                                <option value="">Seleccionar...</option>
                                <option value="RX Tórax">RX Tórax</option>
                                <option value="RX Abdomen">RX Abdomen</option>
                                <option value="RX Extremidades">RX Extremidades</option>
                                <option value="TAC Cráneo">TAC Cráneo</option>
                                <option value="TAC Tórax">TAC Tórax</option>
                                <option value="TAC Abdomen">TAC Abdomen</option>
                                <option value="Resonancia Magnética">Resonancia Magnética</option>
                                <option value="Ecografía Abdominal">Ecografía Abdominal</option>
                                <option value="Ecografía Pélvica">Ecografía Pélvica</option>
                                <option value="Mamografía">Mamografía</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Prioridad</label>
                            <select name="priority" class="form-control" required>
                                <option value="Rutina">Rutina</option>
                                <option value="Urgente">Urgente</option>
                                <option value="Emergencia">Emergencia</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Indicaciones Clínicas</label>
                        <textarea name="clinical_indication" class="form-control" rows="3" required placeholder="Motivo de la solicitud, síntomas, sospecha diagnóstica..."></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Fecha Solicitud</label>
                        <input type="date" name="request_date" class="form-control" value="${new Date().toISOString().split('T')[0]}" required>
                    </div>
                    <div style="display: flex; gap: var(--space-12); justify-content: flex-end; margin-top: var(--space-20);">
                        <button type="button" class="btn btn--outline" onclick="closeModal()">Cancelar</button>
                        <button type="submit" class="btn btn--primary">Solicitar Estudio</button>
                    </div>
                </form>
            `;
            
            document.getElementById('formModal').classList.add('active');
            
            document.getElementById('radiologyForm').onsubmit = function(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                const selectedPatient = patients.find(p => p.id == formData.get('patient_id'));
                
                const radiologyRequest = {
                    id: Date.now(),
                    patient_id: parseInt(formData.get('patient_id')),
                    patient_name: selectedPatient ? selectedPatient.name : '',
                    study_type: formData.get('study_type'),
                    requesting_doctor: formData.get('requesting_doctor'),
                    priority: formData.get('priority'),
                    clinical_indication: formData.get('clinical_indication'),
                    request_date: formData.get('request_date'),
                    status: 'Pendiente'
                };
                
                // Add to a radiologyRequests array (would need to be created)
                showToast('success', 'Solicitud creada', `Estudio de ${radiologyRequest.study_type} solicitado`);
                closeModal();
            };
        }
        
        function viewRadiologyImages() {
            showToast('info', 'Visor DICOM', 'Abriendo visor de imágenes médicas');
            // Simulate opening DICOM viewer with enhanced functionality
            document.getElementById('modalTitle').textContent = 'Visor de Imágenes DICOM';
            document.getElementById('modalBody').innerHTML = `
                <div style="background: var(--color-charcoal-700); height: 400px; border-radius: var(--radius-base); display: flex; align-items: center; justify-content: center; color: var(--color-white); flex-direction: column; position: relative;">
                    <div id="dicomViewer" style="width: 100%; height: 100%; position: relative; overflow: hidden;">
                        <div style="position: absolute; top: 10px; left: 10px; color: white; font-family: monospace; font-size: 12px;">
                            <div>Paciente: PEREZ, JUAN</div>
                            <div>Estudio: RX TORAX AP/LAT</div>
                            <div>Fecha: 22/10/2025 14:30</div>
                            <div>Técnica: 110kV, 6.3mAs</div>
                        </div>
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 4rem; opacity: 0.3;">
                            <i class="fas fa-x-ray"></i>
                        </div>
                        <div id="measurements" style="position: absolute; bottom: 10px; right: 10px; color: yellow; font-family: monospace; font-size: 12px;"></div>
                    </div>
                </div>
                <div style="display: flex; justify-content: center; gap: var(--space-12); margin: var(--space-16) 0; flex-wrap: wrap;">
                    <button class="btn btn--outline btn--sm" onclick="zoomImage()" title="Zoom">
                        <i class="fas fa-search-plus"></i> Zoom
                    </button>
                    <button class="btn btn--outline btn--sm" onclick="rotateImage()" title="Rotar">
                        <i class="fas fa-redo"></i> Rotar
                    </button>
                    <button class="btn btn--outline btn--sm" onclick="measureImage()" title="Medir">
                        <i class="fas fa-ruler"></i> Medir
                    </button>
                    <button class="btn btn--outline btn--sm" onclick="adjustContrast()" title="Contraste">
                        <i class="fas fa-adjust"></i> Contraste
                    </button>
                    <button class="btn btn--outline btn--sm" onclick="invertColors()" title="Invertir">
                        <i class="fas fa-exchange-alt"></i> Invertir
                    </button>
                    <button class="btn btn--outline btn--sm" onclick="resetImage()" title="Restablecer">
                        <i class="fas fa-undo"></i> Reset
                    </button>
                </div>
                <div style="margin-top: var(--space-16); padding: var(--space-12); background: var(--color-bg-1); border-radius: var(--radius-base);">
                    <h5 style="margin-bottom: var(--space-8);">Informe Radiológico</h5>
                    <textarea class="form-control" rows="4" placeholder="Escribir informe radiológico..."></textarea>
                    <div style="display: flex; justify-content: flex-end; margin-top: var(--space-8);">
                        <button class="btn btn--primary btn--sm" onclick="saveRadiologyReport()">Guardar Informe</button>
                    </div>
                </div>
                <div style="display: flex; gap: var(--space-12); justify-content: flex-end; margin-top: var(--space-20);">
                    <button type="button" class="btn btn--outline" onclick="closeModal()">Cerrar</button>
                    <button type="button" class="btn btn--primary" onclick="printRadiologyReport()">Imprimir</button>
                </div>
            `;
            
            document.getElementById('formModal').classList.add('active');
        }
        
        function assignRadiologist() {
            document.getElementById('modalTitle').textContent = 'Asignar Radiólogo';
            document.getElementById('modalBody').innerHTML = `
                <form id="assignRadiologistForm">
                    <div class="form-group">
                        <label class="form-label">Seleccionar Radiólogo</label>
                        <select name="radiologist" class="form-control" required>
                            <option value="">Seleccionar...</option>
                            <option value="Dr. Ana Radióloga">Dr. Ana Radióloga - Radiología General</option>
                            <option value="Dr. Carlos Imagen">Dr. Carlos Imagen - Radiología Intervencionista</option>
                            <option value="Dr. Laura TAC">Dr. Laura TAC - Tomografía y RM</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Fecha Programada</label>
                        <input type="datetime-local" name="scheduled_date" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notas para el Radiólogo</label>
                        <textarea name="notes" class="form-control" rows="3" placeholder="Información adicional, urgencias, observaciones..."></textarea>
                    </div>
                    <div style="display: flex; gap: var(--space-12); justify-content: flex-end; margin-top: var(--space-20);">
                        <button type="button" class="btn btn--outline" onclick="closeModal()">Cancelar</button>
                        <button type="submit" class="btn btn--primary">Asignar</button>
                    </div>
                </form>
            `;
            
            document.getElementById('formModal').classList.add('active');
            
            document.getElementById('assignRadiologistForm').onsubmit = function(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                showToast('success', 'Radiólogo asignado', `${formData.get('radiologist')} asignado para ${formData.get('scheduled_date')}`);
                closeModal();
            };
        }
        
        let imageZoom = 1;
        let imageRotation = 0;
        let imageInverted = false;
        let measuring = false;
        
        function zoomImage() {
            imageZoom = imageZoom === 1 ? 1.5 : imageZoom === 1.5 ? 2 : 1;
            showToast('info', 'Zoom', `Zoom aplicado: ${imageZoom * 100}%`);
        }
        
        function rotateImage() {
            imageRotation = (imageRotation + 90) % 360;
            showToast('info', 'Rotación', `Imagen rotada: ${imageRotation}°`);
        }
        
        function measureImage() {
            measuring = !measuring;
            if (measuring) {
                document.getElementById('measurements').innerHTML = 'Modo medición activado<br>Medida: 12.5 cm';
                showToast('info', 'Medición', 'Herramienta de medición activada - Click para medir');
            } else {
                document.getElementById('measurements').innerHTML = '';
                showToast('info', 'Medición', 'Herramienta de medición desactivada');
            }
        }
        
        function adjustContrast() {
            showToast('info', 'Contraste', 'Contraste ajustado automáticamente');
        }
        
        function invertColors() {
            imageInverted = !imageInverted;
            showToast('info', 'Inversión', imageInverted ? 'Colores invertidos' : 'Colores normales');
        }
        
        function resetImage() {
            imageZoom = 1;
            imageRotation = 0;
            imageInverted = false;
            measuring = false;
            document.getElementById('measurements').innerHTML = '';
            showToast('info', 'Reset', 'Imagen restablecida a valores originales');
        }
        
        function saveRadiologyReport() {
            const report = document.querySelector('textarea').value;
            if (report.trim()) {
                showToast('success', 'Informe guardado', 'El informe radiológico se ha guardado correctamente');
            } else {
                showToast('warning', 'Informe vacío', 'Por favor, escriba el informe antes de guardar');
            }
        }
        
        function printRadiologyReport() {
            const report = document.querySelector('textarea').value;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Informe Radiológico</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; }
                        .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 30px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>INFORME RADIOLÓGICO</h1>
                        <p>HospiSafe - Sistema de Gestión Hospitalaria</p>
                    </div>
                    <p><strong>Paciente:</strong> PEREZ, JUAN</p>
                    <p><strong>Estudio:</strong> RX TÓRAX AP/LAT</p>
                    <p><strong>Fecha:</strong> 22/10/2025</p>
                    <p><strong>Radiólogo:</strong> ${currentUser.name}</p>
                    <hr>
                    <h3>INFORME:</h3>
                    <p style="white-space: pre-wrap;">${report || 'Sin informe disponible'}</p>
                    <div style="margin-top: 50px; text-align: right;">
                        <p>_________________________</p>
                        <p><strong>${currentUser.name}</strong></p>
                        <p>Médico Radiólogo</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
            showToast('success', 'Impresión', 'Informe enviado a imprimir');
        }
        
        // === SURGERY MANAGEMENT ===
        function showSurgeryModal() {
            document.getElementById('modalTitle').textContent = 'Programar Cirugía';
            document.getElementById('modalBody').innerHTML = `
                <form id="surgeryForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Paciente</label>
                            <select name="patient_id" class="form-control" required>
                                <option value="">Seleccionar paciente...</option>
                                ${patients.map(p => `<option value="${p.id}">${p.name} - ${p.dni}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Cirujano</label>
                            <select name="surgeon" class="form-control" required>
                                <option value="">Seleccionar cirujano...</option>
                                <option value="Dr. José Martín">Dr. José Martín - Traumatología</option>
                                <option value="Dr. María García">Dr. María García - Cardiología</option>
                                <option value="Dr. Ana Cirujana">Dr. Ana Cirujana - Cirugía General</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Procedimiento</label>
                            <select name="procedure" class="form-control" required>
                                <option value="">Seleccionar...</option>
                                <option value="Apendicectomía">Apendicectomía</option>
                                <option value="Colecistectomía">Colecistectomía</option>
                                <option value="Angioplastia coronaria">Angioplastia coronaria</option>
                                <option value="Artroscopia">Artroscopia</option>
                                <option value="Herniorrafia">Herniorrafia</option>
                                <option value="Cirugía de cataratas">Cirugía de cataratas</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Duración Estimada (min)</label>
                            <input type="number" name="duration" class="form-control" min="30" max="480" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Fecha</label>
                            <input type="date" name="date" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Hora</label>
                            <input type="time" name="time" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Quirófano</label>
                            <select name="room" class="form-control" required>
                                <option value="">Seleccionar...</option>
                                <option value="Quirófano 1">Quirófano 1</option>
                                <option value="Quirófano 2">Quirófano 2</option>
                                <option value="Quirófano 3">Quirófano 3</option>
                                <option value="Quirófano 4">Quirófano 4</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Anestesiólogo</label>
                            <select name="anesthesiologist" class="form-control" required>
                                <option value="">Seleccionar...</option>
                                <option value="Dr. Ana Anestesia">Dr. Ana Anestesia</option>
                                <option value="Dr. Pedro Anestesia">Dr. Pedro Anestesia</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Observaciones</label>
                        <textarea name="observations" class="form-control" rows="3" placeholder="Instrucciones especiales, alergias, etc."></textarea>
                    </div>
                    <div style="display: flex; gap: var(--space-12); justify-content: flex-end; margin-top: var(--space-20);">
                        <button type="button" class="btn btn--outline" onclick="closeModal()">Cancelar</button>
                        <button type="submit" class="btn btn--primary">Programar Cirugía</button>
                    </div>
                </form>
            `;
            
            document.getElementById('formModal').classList.add('active');
            
            document.getElementById('surgeryForm').onsubmit = function(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                const selectedPatient = patients.find(p => p.id == formData.get('patient_id'));
                
                const surgeryData = {
                    id: Math.max(...surgeries.map(s => s.id)) + 1,
                    patient_id: parseInt(formData.get('patient_id')),
                    patient_name: selectedPatient ? selectedPatient.name : '',
                    procedure: formData.get('procedure'),
                    surgeon: formData.get('surgeon'),
                    date: formData.get('date'),
                    time: formData.get('time'),
                    duration: parseInt(formData.get('duration')),
                    room: formData.get('room'),
                    anesthesiologist: formData.get('anesthesiologist'),
                    status: 'Programada',
                    observations: formData.get('observations')
                };
                
                surgeries.push(surgeryData);
                showToast('success', 'Cirugía programada', `${surgeryData.procedure} programada para ${surgeryData.date}`);
                closeModal();
                if (currentModule === 'surgery') loadSurgeryModule();
            };
        }
        
        // === EMERGENCY MANAGEMENT ===
        function showTriageModal() {
            document.getElementById('modalTitle').textContent = 'Nuevo Paciente - Triaje';
            document.getElementById('modalBody').innerHTML = `
                <form id="triageForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Nombre del Paciente</label>
                            <input type="text" name="patient_name" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">DNI/Pasaporte</label>
                            <input type="text" name="document" class="form-control">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Edad</label>
                            <input type="number" name="age" class="form-control" min="0" max="120">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Teléfono</label>
                            <input type="tel" name="phone" class="form-control">
                        </div>
                    </div>
                    
                    <h5 style="margin: var(--space-20) 0 var(--space-12) 0; color: var(--color-primary);">Signos Vitales</h5>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Presión Arterial</label>
                            <input type="text" name="blood_pressure" class="form-control" placeholder="120/80">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Frecuencia Cardíaca</label>
                            <input type="number" name="heart_rate" class="form-control" placeholder="75">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Temperatura (°C)</label>
                            <input type="number" name="temperature" class="form-control" step="0.1" placeholder="36.5">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Saturación O2 (%)</label>
                            <input type="number" name="oxygen_sat" class="form-control" min="0" max="100" placeholder="98">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Síntomas Principales</label>
                        <textarea name="symptoms" class="form-control" rows="3" required placeholder="Describir síntomas, dolor, malestar..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Nivel de Triaje</label>
                        <select name="triage_level" class="form-control" required>
                            <option value="">Seleccionar nivel...</option>
                            <option value="Crítico" style="color: red;">🔴 Crítico - Riesgo vital inmediato</option>
                            <option value="Urgente" style="color: orange;">🟠 Urgente - Atención en 15 min</option>
                            <option value="Menos Urgente" style="color: blue;">🔵 Menos Urgente - Atención en 60 min</option>
                            <option value="No Urgente" style="color: green;">🟢 No Urgente - Atención en 120 min</option>
                        </select>
                    </div>
                    
                    <div style="display: flex; gap: var(--space-12); justify-content: flex-end; margin-top: var(--space-20);">
                        <button type="button" class="btn btn--outline" onclick="closeModal()">Cancelar</button>
                        <button type="submit" class="btn btn--primary">Registrar en Urgencias</button>
                    </div>
                </form>
            `;
            
            document.getElementById('formModal').classList.add('active');
            
            document.getElementById('triageForm').onsubmit = function(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                
                const emergencyData = {
                    id: Math.max(...emergencies.map(e => e.id)) + 1,
                    patient_name: formData.get('patient_name'),
                    document: formData.get('document'),
                    age: formData.get('age'),
                    phone: formData.get('phone'),
                    arrival_time: new Date().toISOString(),
                    triage_level: formData.get('triage_level'),
                    symptoms: formData.get('symptoms'),
                    vital_signs: {
                        blood_pressure: formData.get('blood_pressure'),
                        heart_rate: formData.get('heart_rate'),
                        temperature: formData.get('temperature'),
                        oxygen_sat: formData.get('oxygen_sat')
                    },
                    status: 'En espera',
                    attending_doctor: null
                };
                
                emergencies.push(emergencyData);
                showToast('success', 'Paciente registrado', `${emergencyData.patient_name} registrado en urgencias - Nivel: ${emergencyData.triage_level}`);
                closeModal();
                if (currentModule === 'emergency') loadEmergencyModule();
                updateDashboardStats();
            };
        }
        
        // === ROOMS MANAGEMENT ===
        function showRoomFilters() {
            document.getElementById('modalTitle').textContent = 'Filtros de Habitaciones';
            document.getElementById('modalBody').innerHTML = `
                <form id="roomFilterForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Estado</label>
                            <select name="status" class="form-control">
                                <option value="">Todos los estados</option>
                                <option value="Disponible">Disponible</option>
                                <option value="Ocupada">Ocupada</option>
                                <option value="Limpieza">En limpieza</option>
                                <option value="Mantenimiento">Mantenimiento</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Planta</label>
                            <select name="floor" class="form-control">
                                <option value="">Todas las plantas</option>
                                <option value="1">Planta 1</option>
                                <option value="2">Planta 2</option>
                                <option value="3">Planta 3</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Tipo</label>
                            <select name="type" class="form-control">
                                <option value="">Todos los tipos</option>
                                <option value="Individual">Individual</option>
                                <option value="Doble">Doble</option>
                                <option value="UCI">UCI</option>
                                <option value="Pediatría">Pediatría</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Equipamiento</label>
                            <select name="equipment" class="form-control">
                                <option value="">Todo equipamiento</option>
                                <option value="Monitor">Con monitor</option>
                                <option value="Oxígeno">Con oxígeno</option>
                                <option value="Desfibrilador">Con desfibrilador</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: flex; gap: var(--space-12); justify-content: flex-end; margin-top: var(--space-20);">
                        <button type="button" class="btn btn--outline" onclick="clearRoomFilters()">Limpiar</button>
                        <button type="button" class="btn btn--primary" onclick="applyRoomFilters()">Aplicar Filtros</button>
                    </div>
                </form>
            `;
            
            document.getElementById('formModal').classList.add('active');
        }
        
        function clearRoomFilters() {
            showToast('info', 'Filtros', 'Filtros de habitaciones limpiados');
            closeModal();
            if (currentModule === 'rooms') loadRoomsModule();
        }
        
        function applyRoomFilters() {
            const form = document.getElementById('roomFilterForm');
            const formData = new FormData(form);
            const filters = {
                status: formData.get('status'),
                floor: formData.get('floor'),
                type: formData.get('type'),
                equipment: formData.get('equipment')
            };
            
            showToast('success', 'Filtros aplicados', `Filtros: ${Object.values(filters).filter(v => v).join(', ') || 'Ninguno'}`);
            closeModal();
        }
        
        function assignRoom() {
            document.getElementById('modalTitle').textContent = 'Asignar Habitación';
            document.getElementById('modalBody').innerHTML = `
                <form id="assignRoomForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Paciente</label>
                            <select name="patient_id" class="form-control" required>
                                <option value="">Seleccionar paciente...</option>
                                ${patients.filter(p => !p.room_id).map(p => `<option value="${p.id}">${p.name} - ${p.dni}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Habitación</label>
                            <select name="room_id" class="form-control" required>
                                <option value="">Seleccionar habitación...</option>
                                ${rooms.filter(r => r.status === 'Disponible').map(r => `<option value="${r.id}">${r.id} - Planta ${r.floor} (${r.type})</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Motivo de Hospitalización</label>
                        <textarea name="reason" class="form-control" rows="3" required placeholder="Describir el motivo de ingreso..."></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Fecha de Ingreso</label>
                            <input type="datetime-local" name="admission_date" class="form-control" value="${new Date().toISOString().slice(0, 16)}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Médico Responsable</label>
                            <select name="attending_doctor" class="form-control" required>
                                <option value="">Seleccionar médico...</option>
                                ${doctors.map(d => `<option value="${d.name}">${d.name} - ${d.specialty}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div style="display: flex; gap: var(--space-12); justify-content: flex-end; margin-top: var(--space-20);">
                        <button type="button" class="btn btn--outline" onclick="closeModal()">Cancelar</button>
                        <button type="submit" class="btn btn--primary">Asignar Habitación</button>
                    </div>
                </form>
            `;
            
            document.getElementById('formModal').classList.add('active');
            
            document.getElementById('assignRoomForm').onsubmit = function(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                const patientId = parseInt(formData.get('patient_id'));
                const roomId = formData.get('room_id');
                
                // Update patient
                const patient = patients.find(p => p.id === patientId);
                if (patient) {
                    patient.room_id = roomId;
                    patient.status = 'hospitalized';
                }
                
                // Update room
                const room = rooms.find(r => r.id === roomId);
                if (room) {
                    room.status = 'Ocupada';
                    room.patient_id = patientId;
                    room.admission_date = formData.get('admission_date');
                    room.attending_doctor = formData.get('attending_doctor');
                    room.admission_reason = formData.get('reason');
                }
                
                showToast('success', 'Habitación asignada', `Habitación ${roomId} asignada a ${patient.name}`);
                closeModal();
                if (currentModule === 'rooms') loadRoomsModule();
                updateDashboardStats();
            };
        }
        
        function showRoomDetails(roomId) {
            const room = rooms.find(r => r.id === roomId);
            const patient = room.patient_id ? patients.find(p => p.id === room.patient_id) : null;
            
            document.getElementById('modalTitle').textContent = `Detalles - Habitación ${roomId}`;
            document.getElementById('modalBody').innerHTML = `
                <div class="card" style="margin-bottom: var(--space-16);">
                    <div class="card-header">
                        <h5 class="card-title">Información de la Habitación</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-row" style="margin-bottom: var(--space-12);">
                            <div><strong>ID:</strong> ${room.id}</div>
                            <div><strong>Planta:</strong> ${room.floor}</div>
                        </div>
                        <div class="form-row" style="margin-bottom: var(--space-12);">
                            <div><strong>Tipo:</strong> ${room.type}</div>
                            <div><strong>Capacidad:</strong> ${room.capacity} persona(s)</div>
                        </div>
                        <div style="margin-bottom: var(--space-12);">
                            <strong>Estado:</strong> 
                            <span class="status ${
                                room.status === 'Disponible' ? 'status--success' :
                                room.status === 'Ocupada' ? 'status--warning' : 'status--error'
                            }">${room.status}</span>
                        </div>
                        <div style="margin-bottom: var(--space-12);">
                            <strong>Equipamiento:</strong> ${room.equipment ? room.equipment.join(', ') : 'Equipamiento básico'}
                        </div>
                        <div>
                            <strong>Última limpieza:</strong> ${room.last_cleaning ? new Date(room.last_cleaning).toLocaleString('es-ES') : 'N/A'}
                        </div>
                    </div>
                </div>
                
                ${patient ? `
                    <div class="card" style="margin-bottom: var(--space-16);">
                        <div class="card-header">
                            <h5 class="card-title">Paciente Actual</h5>
                        </div>
                        <div class="card-body">
                            <div class="form-row" style="margin-bottom: var(--space-12);">
                                <div><strong>Nombre:</strong> ${patient.name}</div>
                                <div><strong>DNI:</strong> ${patient.dni}</div>
                            </div>
                            <div class="form-row" style="margin-bottom: var(--space-12);">
                                <div><strong>Edad:</strong> ${patient.age || 'N/A'}</div>
                                <div><strong>Seguro:</strong> ${patient.insurance}</div>
                            </div>
                            ${room.admission_date ? `<div><strong>Fecha de ingreso:</strong> ${new Date(room.admission_date).toLocaleString('es-ES')}</div>` : ''}
                            ${room.attending_doctor ? `<div><strong>Médico:</strong> ${room.attending_doctor}</div>` : ''}
                        </div>
                    </div>
                ` : ''}
                
                <div style="display: flex; gap: var(--space-12); justify-content: flex-end; margin-top: var(--space-20);">
                    <button type="button" class="btn btn--outline" onclick="closeModal()">Cerrar</button>
                    ${room.status === 'Ocupada' ? 
                        '<button type="button" class="btn btn--primary" onclick="dischargePatient(\'' + roomId + '\'))">Dar Alta</button>' :
                        room.status === 'Disponible' ? 
                            '<button type="button" class="btn btn--primary" onclick="requestCleaning(\'' + roomId + '\'))">Solicitar Limpieza</button>' :
                            '<button type="button" class="btn btn--success" onclick="markRoomReady(\'' + roomId + '\'))">Marcar Lista</button>'
                    }
                </div>
            `;
            
            document.getElementById('formModal').classList.add('active');
        }
        
        function dischargePatient(roomId) {
            const room = rooms.find(r => r.id === roomId);
            const patient = room.patient_id ? patients.find(p => p.id === room.patient_id) : null;
            
            if (confirm(`¿Confirma el alta del paciente ${patient ? patient.name : 'N/A'}?`)) {
                if (patient) {
                    patient.room_id = null;
                    patient.status = 'active';
                }
                room.status = 'Limpieza';
                room.patient_id = null;
                room.admission_date = null;
                room.attending_doctor = null;
                room.admission_reason = null;
                
                showToast('success', 'Alta procesada', `Paciente dado de alta de la habitación ${roomId}`);
                closeModal();
                if (currentModule === 'rooms') loadRoomsModule();
            }
        }
        
        function requestCleaning(roomId) {
            const room = rooms.find(r => r.id === roomId);
            room.status = 'Limpieza';
            showToast('info', 'Limpieza solicitada', `Limpieza solicitada para habitación ${roomId}`);
            closeModal();
            if (currentModule === 'rooms') loadRoomsModule();
        }
        
        function markRoomReady(roomId) {
            const room = rooms.find(r => r.id === roomId);
            room.status = 'Disponible';
            room.last_cleaning = new Date().toISOString();
            showToast('success', 'Habitación lista', `Habitación ${roomId} marcada como disponible`);
            closeModal();
            if (currentModule === 'rooms') loadRoomsModule();
        }
        
        // === COMMUNICATIONS MANAGEMENT ===
        function showMessageModal() {
            document.getElementById('modalTitle').textContent = 'Nuevo Mensaje Interno';
            document.getElementById('modalBody').innerHTML = `
                <form id="messageForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Para</label>
                            <select name="to" class="form-control" required>
                                <option value="">Seleccionar destinatario...</option>
                                ${users.filter(u => u.id !== currentUser.id).map(u => `<option value="${u.name}">${u.name} - ${u.role}</option>`).join('')}
                                <option value="Equipo Enfermería">Todo el Equipo de Enfermería</option>
                                <option value="Equipo Médico">Todo el Equipo Médico</option>
                                <option value="Administración">Administración</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Prioridad</label>
                            <select name="priority" class="form-control" required>
                                <option value="Normal">Normal</option>
                                <option value="Alta">Alta</option>
                                <option value="Urgente">Urgente</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Asunto</label>
                        <input type="text" name="subject" class="form-control" required placeholder="Asunto del mensaje">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mensaje</label>
                        <textarea name="message" class="form-control" rows="5" required placeholder="Escribir mensaje..."></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Adjuntar</label>
                        <input type="file" name="attachment" class="form-control" accept=".pdf,.doc,.docx,.jpg,.png">
                        <small style="color: var(--color-text-secondary);">Formatos: PDF, DOC, DOCX, JPG, PNG</small>
                    </div>
                    <div style="display: flex; gap: var(--space-12); justify-content: flex-end; margin-top: var(--space-20);">
                        <button type="button" class="btn btn--outline" onclick="closeModal()">Cancelar</button>
                        <button type="submit" class="btn btn--primary">Enviar Mensaje</button>
                    </div>
                </form>
            `;
            
            document.getElementById('formModal').classList.add('active');
            
            document.getElementById('messageForm').onsubmit = function(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                
                const messageData = {
                    id: Math.max(...communications.map(c => c.id)) + 1,
                    from: currentUser.name,
                    to: formData.get('to'),
                    subject: formData.get('subject'),
                    message: formData.get('message'),
                    priority: formData.get('priority'),
                    time: new Date().toISOString(),
                    read: false,
                    urgent: formData.get('priority') === 'Urgente'
                };
                
                communications.push(messageData);
                showToast('success', 'Mensaje enviado', `Mensaje enviado a ${messageData.to}`);
                closeModal();
                if (currentModule === 'communications') loadCommunicationsModule();
            };
        }
        
        let chatMessages = [
            { user: 'Dr. María García', time: '14:30', message: 'Paciente Carlos listo para cirugía', type: 'info' },
            { user: 'Ana Martínez', time: '14:32', message: 'Perfecto, preparando quirófano 1', type: 'success' },
            { user: 'Dr. José Martín', time: '14:35', message: '¿Está disponible el anestesiólogo?', type: 'warning' }
        ];
        
        function sendChatMessage() {
            const messageInput = document.querySelector('#chatMessages').parentElement.querySelector('input[type="text"]');
            const message = messageInput.value.trim();
            
            if (message) {
                const newMessage = {
                    user: currentUser.name,
                    time: new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }),
                    message: message,
                    type: 'primary'
                };
                
                chatMessages.push(newMessage);
                
                // Update chat display
                const chatContainer = document.getElementById('chatMessages');
                if (chatContainer) {
                    chatContainer.innerHTML += `
                        <div style="margin-bottom: var(--space-12);">
                            <strong style="color: var(--color-primary);">${newMessage.user}</strong>
                            <small style="color: var(--color-text-secondary); margin-left: var(--space-8);">${newMessage.time}</small>
                            <div style="margin-top: var(--space-4);">${newMessage.message}</div>
                        </div>
                    `;
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
                
                messageInput.value = '';
                showToast('success', 'Mensaje enviado', 'Mensaje agregado al chat del equipo');
            }
        }
        
        // === REPORTS MANAGEMENT ===
        function exportReport() {
            // Generate comprehensive report
            const reportData = {
                date: new Date().toLocaleDateString('es-ES'),
                time: new Date().toLocaleTimeString('es-ES'),
                statistics: {
                    patients_total: patients.length,
                    appointments_today: appointments.filter(a => a.date === new Date().toISOString().split('T')[0]).length,
                    surgeries_scheduled: surgeries.filter(s => s.status === 'Programada').length,
                    rooms_occupied: rooms.filter(r => r.status === 'Ocupada').length,
                    emergencies_today: emergencies.filter(e => e.arrival_time.startsWith(new Date().toISOString().split('T')[0])).length
                },
                revenue: {
                    total_invoiced: invoices.reduce((sum, inv) => sum + inv.amount, 0),
                    paid: invoices.filter(inv => inv.status === 'Pagada').reduce((sum, inv) => sum + inv.amount, 0),
                    pending: invoices.filter(inv => inv.status === 'Pendiente').reduce((sum, inv) => sum + inv.amount, 0)
                }
            };
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Reporte Hospitalario - ${reportData.date}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; }
                        .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 30px; }
                        .section { margin-bottom: 30px; }
                        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
                        .stat-card { border: 1px solid #ddd; padding: 15px; border-radius: 8px; text-align: center; }
                        .stat-number { font-size: 2em; font-weight: bold; color: #1FB8CD; }
                        .stat-label { color: #666; margin-top: 5px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>REPORTE HOSPITALARIO</h1>
                        <p>HospiSafe - Sistema de Gestión Hospitalaria</p>
                        <p>Generado el ${reportData.date} a las ${reportData.time}</p>
                    </div>
                    
                    <div class="section">
                        <h2>Estadísticas Generales</h2>
                        <div class="stat-grid">
                            <div class="stat-card">
                                <div class="stat-number">${reportData.statistics.patients_total}</div>
                                <div class="stat-label">Total Pacientes</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${reportData.statistics.appointments_today}</div>
                                <div class="stat-label">Citas Hoy</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${reportData.statistics.surgeries_scheduled}</div>
                                <div class="stat-label">Cirugías Programadas</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${reportData.statistics.rooms_occupied}</div>
                                <div class="stat-label">Habitaciones Ocupadas</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${reportData.statistics.emergencies_today}</div>
                                <div class="stat-label">Emergencias Hoy</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h2>Indicadores Financieros</h2>
                        <div class="stat-grid">
                            <div class="stat-card">
                                <div class="stat-number">€${reportData.revenue.total_invoiced.toFixed(2)}</div>
                                <div class="stat-label">Total Facturado</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">€${reportData.revenue.paid.toFixed(2)}</div>
                                <div class="stat-label">Total Cobrado</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">€${reportData.revenue.pending.toFixed(2)}</div>
                                <div class="stat-label">Pendiente de Cobro</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h2>Personal Médico</h2>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 1px solid #ddd;">
                                    <th style="text-align: left; padding: 10px;">Nombre</th>
                                    <th style="text-align: left; padding: 10px;">Especialidad</th>
                                    <th style="text-align: left; padding: 10px;">Pacientes Asignados</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${doctors.map(doctor => `
                                    <tr>
                                        <td style="padding: 10px;">${doctor.name}</td>
                                        <td style="padding: 10px;">${doctor.specialty}</td>
                                        <td style="padding: 10px;">${patients.filter(p => p.assigned_doctor_id === doctor.id).length}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="margin-top: 50px; text-align: center; font-size: 0.9em; color: #666;">
                        <p>Reporte generado automáticamente por HospiSafe</p>
                        <p>© 2025 Hospital Management System</p>
                    </div>
                </body>
            </html>
            `);
            printWindow.document.close();
            printWindow.print();
            
            showToast('success', 'Reporte generado', 'Reporte hospitalario completo enviado a imprimir');
        }
        
        // === NOTIFICATION SYSTEM ENHANCEMENTS ===
        function markAllAsRead() {
            notifications.forEach(n => n.read = true);
            const panel = document.getElementById('notificationPanel');
            if (panel) {
                panel.remove();
            }
            updateNotificationBadge();
            showToast('success', 'Notificaciones', 'Todas las notificaciones marcadas como leídas');
        }
        
        function markAsRead(id) {
            const notification = notifications.find(n => n.id === id);
            if (notification) {
                notification.read = true;
                updateNotificationBadge();
                showToast('info', 'Leída', 'Notificación marcada como leída');
                // Refresh notification panel
                const panel = document.getElementById('notificationPanel');
                if (panel) {
                    panel.remove();
                    showNotifications();
                }
            }
        }
        
        function updateNotificationBadge() {
            const unreadCount = notifications.filter(n => !n.read).length;
            const badge = document.querySelector('.notification-badge');
            if (badge) {
                if (unreadCount > 0) {
                    badge.style.setProperty('--notification-count', '"' + unreadCount + '"');
                    badge.querySelector('::after').style.display = 'flex';
                } else {
                    badge.style.setProperty('--notification-count', '"0"');
                }
            }
        }
        
        // === WEB SPEECH API FUNCTIONALITY ===
        let recognition = null;
        let synthesis = window.speechSynthesis;
        
        function initializeSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'es-ES';
                
                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    const activeElement = document.activeElement;
                    
                    if (activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA')) {
                        activeElement.value += transcript;
                        showToast('success', 'Dictado completado', 'Texto agregado: "' + transcript + '"');
                    }
                };
                
                recognition.onerror = function(event) {
                    showToast('error', 'Error de voz', 'No se pudo procesar el audio');
                };
            }
        }
        
        function startDictation() {
            if (recognition) {
                recognition.start();
                showToast('info', 'Dictado iniciado', 'Hable ahora...');
            } else {
                showToast('warning', 'No soportado', 'Su navegador no soporta reconocimiento de voz');
            }
        }
        
        function speakText(text) {
            if (synthesis) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'es-ES';
                utterance.rate = 0.9;
                synthesis.speak(utterance);
                showToast('info', 'Síntesis de voz', 'Reproduciendo texto');
            }
        }
        
        // === REAL QR CODE SCANNER WITH jsQR ===
        let qrVideo = null;
        let qrCanvas = null;
        let qrContext = null;
        let qrScanning = false;
        
        function startRealQRScanner() {
            document.getElementById('modalTitle').textContent = 'Escáner QR Real';
            document.getElementById('modalBody').innerHTML = `
                <div style="text-align: center;">
                    <video id="qrVideo" width="100%" height="300" autoplay style="border-radius: var(--radius-base); margin-bottom: var(--space-16);"></video>
                    <canvas id="qrCanvas" style="display: none;"></canvas>
                    <div id="qrResult" style="margin-top: var(--space-16); padding: var(--space-12); background: var(--color-bg-1); border-radius: var(--radius-base); display: none;">
                        <strong>Resultado:</strong> <span id="qrResultText"></span>
                    </div>
                    <div style="margin-top: var(--space-16);">
                        <button class="btn btn--primary" onclick="stopQRScanner()">Detener Escáner</button>
                    </div>
                </div>
            `;
            
            document.getElementById('formModal').classList.add('active');
            
            // Initialize camera
            qrVideo = document.getElementById('qrVideo');
            qrCanvas = document.getElementById('qrCanvas');
            qrContext = qrCanvas.getContext('2d');
            
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(function(stream) {
                    qrVideo.srcObject = stream;
                    qrVideo.setAttribute('playsinline', true);
                    qrVideo.play();
                    qrScanning = true;
                    requestAnimationFrame(scanQRCode);
                })
                .catch(function(err) {
                    showToast('error', 'Error de cámara', 'No se pudo acceder a la cámara');
                    // Fallback to simulation
                    closeModal();
                    setTimeout(simulateQRScan, 100);
                });
        }
        
        function scanQRCode() {
            if (!qrScanning) return;
            
            if (qrVideo.readyState === qrVideo.HAVE_ENOUGH_DATA) {
                qrCanvas.height = qrVideo.videoHeight;
                qrCanvas.width = qrVideo.videoWidth;
                qrContext.drawImage(qrVideo, 0, 0, qrCanvas.width, qrCanvas.height);
                
                const imageData = qrContext.getImageData(0, 0, qrCanvas.width, qrCanvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });
                
                if (code) {
                    document.getElementById('qrResult').style.display = 'block';
                    document.getElementById('qrResultText').textContent = code.data;
                    showToast('success', 'QR Detectado', code.data);
                    processRealQRData(code.data);
                    qrScanning = false;
                }
            }
            
            if (qrScanning) {
                requestAnimationFrame(scanQRCode);
            }
        }
        
        function stopQRScanner() {
            qrScanning = false;
            if (qrVideo && qrVideo.srcObject) {
                qrVideo.srcObject.getTracks().forEach(track => track.stop());
            }
            closeModal();
        }
        
        function processRealQRData(qrData) {
            // Process real QR code data
            if (qrData.includes('patient')) {
                showToast('success', 'Paciente detectado', 'Abriendo perfil del paciente');
                showModule('patients');
            } else if (qrData.includes('room')) {
                showToast('success', 'Habitación detectada', 'Mostrando detalles de habitación');
                showModule('rooms');
            } else if (qrData.includes('medication')) {
                showToast('success', 'Medicamento detectado', 'Verificando inventario');
                showModule('inventory');
            } else {
                showToast('info', 'QR procesado', 'Datos: ' + qrData.substring(0, 50));
            }
        }
        
        function simulateQRScan() {
            const qrResults = [
                { type: 'room', data: 'Habitación 205B - Planta 2', action: 'Ver detalles de habitación' },
                { type: 'patient', data: 'Paciente: Juan Pérez - ID: 12345', action: 'Abrir historial médico' },
                { type: 'medication', data: 'Medicamento: Enalapril 10mg - Lote: ABC123', action: 'Verificar inventario' },
                { type: 'equipment', data: 'Equipo: Monitor Cardíaco - ID: MON-001', action: 'Estado del equipo' },
                { type: 'location', data: 'Consulta de Cardiología - Planta 1', action: 'Navegación interna' }
            ];
            
            const randomResult = qrResults[Math.floor(Math.random() * qrResults.length)];
            
            document.getElementById('modalTitle').textContent = 'Resultado del Escaneo QR';
            document.getElementById('modalBody').innerHTML = `
                <div style="text-align: center; margin: var(--space-20) 0;">
                    <i class="fas fa-qrcode" style="font-size: 3rem; color: var(--color-success); margin-bottom: var(--space-16);"></i>
                    <h4 style="color: var(--color-primary); margin-bottom: var(--space-16);">¡Código QR Escaneado!</h4>
                    
                    <div class="card" style="margin: var(--space-16) 0;">
                        <div class="card-body">
                            <div style="margin-bottom: var(--space-12);">
                                <strong>Tipo:</strong> ${randomResult.type.toUpperCase()}
                            </div>
                            <div style="margin-bottom: var(--space-12);">
                                <strong>Información:</strong> ${randomResult.data}
                            </div>
                            <div style="margin-bottom: var(--space-12);">
                                <strong>Acción disponible:</strong> ${randomResult.action}
                            </div>
                            <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">
                                <strong>Escaneado:</strong> ${new Date().toLocaleString('es-ES')}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: var(--space-12); justify-content: center; margin-top: var(--space-20);">
                    <button type="button" class="btn btn--outline" onclick="closeModal()">Cerrar</button>
                    <button type="button" class="btn btn--primary" onclick="processQRAction('${randomResult.type}', '${randomResult.data}')">Ejecutar Acción</button>
                </div>
            `;
            
            document.getElementById('formModal').classList.add('active');
        }
        
        function processQRAction(type, data) {
            switch(type) {
                case 'room':
                    const roomId = data.match(/Habitación (\w+)/)[1];
                    closeModal();
                    setTimeout(() => showRoomDetails(roomId), 100);
                    break;
                case 'patient':
                    showToast('info', 'Paciente', 'Abriendo historial médico del paciente');
                    closeModal();
                    showModule('patients');
                    break;
                case 'medication':
                    showToast('info', 'Medicamento', 'Verificando estado en inventario');
                    closeModal();
                    showModule('inventory');
                    break;
                case 'equipment':
                    showToast('info', 'Equipo', 'Mostrando estado del equipo médico');
                    closeModal();
                    break;
                case 'location':
                    showToast('info', 'Navegación', 'Indicaciones de navegación activadas');
                    closeModal();
                    break;
                default:
                    showToast('info', 'QR', 'Acción procesada correctamente');
                    closeModal();
            }
        }
        
        // === ADVANCED EXPORT FUNCTIONALITY ===
        function advancedExport(dataType, format = 'csv') {
            let data, filename, headers;
            
            switch(dataType) {
                case 'patients':
                    data = patients;
                    filename = `pacientes_${new Date().toISOString().split('T')[0]}`;
                    headers = ['ID', 'Nombre', 'DNI', 'Teléfono', 'Email', 'Seguro', 'Estado'];
                    break;
                case 'appointments':
                    data = appointments;
                    filename = `citas_${new Date().toISOString().split('T')[0]}`;
                    headers = ['ID', 'Paciente', 'Doctor', 'Fecha', 'Hora', 'Estado', 'Motivo'];
                    break;
                case 'inventory':
                    data = medications;
                    filename = `inventario_${new Date().toISOString().split('T')[0]}`;
                    headers = ['ID', 'Medicamento', 'Categoría', 'Stock', 'Precio', 'Vencimiento'];
                    break;
                case 'financials':
                    data = invoices;
                    filename = `facturacion_${new Date().toISOString().split('T')[0]}`;
                    headers = ['ID', 'Paciente', 'Fecha', 'Concepto', 'Importe', 'Estado'];
                    break;
                default:
                    showToast('error', 'Error', 'Tipo de datos no válido');
                    return;
            }
            
            if (format === 'csv') {
                exportToCSV(data, headers, filename);
            } else if (format === 'pdf') {
                exportToPDF(data, headers, filename, dataType);
            } else if (format === 'excel') {
                exportToExcel(data, headers, filename);
            }
        }
        
        function exportToCSV(data, headers, filename) {
            let csvContent = headers.join(',') + '\n';
            
            data.forEach(item => {
                const row = headers.map(header => {
                    let value = '';
                    switch(header) {
                        case 'ID': value = item.id || ''; break;
                        case 'Nombre': value = item.name || item.patient_name || ''; break;
                        case 'DNI': value = item.dni || ''; break;
                        case 'Teléfono': value = item.phone || ''; break;
                        case 'Email': value = item.email || ''; break;
                        case 'Seguro': value = item.insurance || ''; break;
                        case 'Estado': value = item.status || ''; break;
                        case 'Paciente': value = item.patient_name || ''; break;
                        case 'Doctor': value = item.doctor || ''; break;
                        case 'Fecha': value = item.date || ''; break;
                        case 'Hora': value = item.time || ''; break;
                        case 'Motivo': value = item.reason || ''; break;
                        case 'Medicamento': value = item.name || ''; break;
                        case 'Categoría': value = item.category || ''; break;
                        case 'Stock': value = item.stock || ''; break;
                        case 'Precio': value = item.price || ''; break;
                        case 'Vencimiento': value = item.expiry_date || ''; break;
                        case 'Concepto': value = item.concept || ''; break;
                        case 'Importe': value = item.amount || ''; break;
                        default: value = '';
                    }
                    return `"${value.toString().replace(/"/g, '""')}"`;
                }).join(',');
                csvContent += row + '\n';
            });
            
            downloadFile(csvContent, filename + '.csv', 'text/csv');
            showToast('success', 'Exportación CSV', `${data.length} registros exportados`);
        }
        
        function exportToPDF(data, headers, filename, dataType) {
            // Simulate PDF generation with HTML
            const pdfContent = `
                <html>
                <head>
                    <title>${filename}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 12px; }
                        th { background-color: #1FB8CD; color: white; }
                        .summary { margin-top: 30px; padding: 15px; background: #f5f5f5; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>REPORTE ${dataType.toUpperCase()}</h1>
                        <p>HospiSafe - Sistema de Gestión Hospitalaria</p>
                        <p>Generado: ${new Date().toLocaleString('es-ES')}</p>
                    </div>
                    <table>
                        <thead>
                            <tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>
                        </thead>
                        <tbody>
                            ${data.slice(0, 50).map(item => {
                                const row = headers.map(header => {
                                    let value = '';
                                    switch(header) {
                                        case 'ID': value = item.id || ''; break;
                                        case 'Nombre': value = item.name || item.patient_name || ''; break;
                                        case 'DNI': value = item.dni || ''; break;
                                        case 'Teléfono': value = item.phone || ''; break;
                                        case 'Email': value = item.email || ''; break;
                                        case 'Seguro': value = item.insurance || ''; break;
                                        case 'Estado': value = item.status || ''; break;
                                        case 'Paciente': value = item.patient_name || ''; break;
                                        case 'Doctor': value = item.doctor || ''; break;
                                        case 'Fecha': value = item.date || ''; break;
                                        case 'Hora': value = item.time || ''; break;
                                        case 'Motivo': value = item.reason || ''; break;
                                        case 'Medicamento': value = item.name || ''; break;
                                        case 'Categoría': value = item.category || ''; break;
                                        case 'Stock': value = item.stock || ''; break;
                                        case 'Precio': value = item.price || ''; break;
                                        case 'Vencimiento': value = item.expiry_date || ''; break;
                                        case 'Concepto': value = item.concept || ''; break;
                                        case 'Importe': value = item.amount || ''; break;
                                        default: value = '';
                                    }
                                    return `<td>${value}</td>`;
                                }).join('');
                                return `<tr>${row}</tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                    <div class="summary">
                        <h3>Resumen</h3>
                        <p>Total de registros: ${data.length}</p>
                        <p>Registros mostrados: ${Math.min(data.length, 50)}</p>
                        ${dataType === 'financials' ? `<p>Total facturado: €${data.reduce((sum, item) => sum + (item.amount || 0), 0).toFixed(2)}</p>` : ''}
                    </div>
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(pdfContent);
            printWindow.document.close();
            printWindow.print();
            
            showToast('success', 'Exportación PDF', `Reporte de ${dataType} enviado a imprimir`);
        }
        
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
        
        // === DATA IMPORT FUNCTIONALITY ===
        function showImportModal() {
            document.getElementById('modalTitle').textContent = 'Importar Datos';
            document.getElementById('modalBody').innerHTML = `
                <div class="tab-navigation">
                    <div class="tab-item active" data-tab="patients">Pacientes</div>
                    <div class="tab-item" data-tab="appointments">Citas</div>
                    <div class="tab-item" data-tab="inventory">Inventario</div>
                </div>
                
                <form id="importForm">
                    <div class="form-group">
                        <label class="form-label">Seleccionar archivo</label>
                        <input type="file" id="importFile" class="form-control" accept=".csv,.json,.xlsx" required>
                        <small style="color: var(--color-text-secondary);">Formatos soportados: CSV, JSON, Excel</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Acción en caso de duplicados</label>
                        <select name="duplicateAction" class="form-control">
                            <option value="skip">Omitir duplicados</option>
                            <option value="update">Actualizar existentes</option>
                            <option value="error">Mostrar error</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" name="validateData" checked> Validar datos antes de importar
                        </label>
                    </div>
                    
                    <div id="importPreview" style="display: none; margin-top: var(--space-16); padding: var(--space-12); background: var(--color-bg-1); border-radius: var(--radius-base);">
                        <h5>Vista previa:</h5>
                        <div id="previewContent"></div>
                    </div>
                    
                    <div style="display: flex; gap: var(--space-12); justify-content: flex-end; margin-top: var(--space-20);">
                        <button type="button" class="btn btn--outline" onclick="closeModal()">Cancelar</button>
                        <button type="button" class="btn btn--secondary" onclick="previewImport()">Vista Previa</button>
                        <button type="submit" class="btn btn--primary">Importar Datos</button>
                    </div>
                </form>
            `;
            
            document.getElementById('formModal').classList.add('active');
            
            document.getElementById('importForm').onsubmit = function(e) {
                e.preventDefault();
                processImport();
            };
        }
        
        function previewImport() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showToast('warning', 'Sin archivo', 'Seleccione un archivo primero');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    let data;
                    if (file.name.endsWith('.json')) {
                        data = JSON.parse(e.target.result);
                    } else if (file.name.endsWith('.csv')) {
                        data = parseCSV(e.target.result);
                    } else {
                        showToast('error', 'Formato no soportado', 'Use archivos CSV o JSON');
                        return;
                    }
                    
                    showImportPreview(data.slice(0, 5)); // Show first 5 records
                } catch (error) {
                    showToast('error', 'Error de archivo', 'No se pudo leer el archivo');
                }
            };
            
            reader.readAsText(file);
        }
        
        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
            
            return lines.slice(1).map(line => {
                const values = line.split(',').map(v => v.replace(/"/g, '').trim());
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header] = values[index] || '';
                });
                return obj;
            });
        }
        
        function showImportPreview(data) {
            const previewDiv = document.getElementById('importPreview');
            const contentDiv = document.getElementById('previewContent');
            
            contentDiv.innerHTML = `
                <p><strong>Registros a importar:</strong> ${data.length} (mostrando primeros 5)</p>
                <table class="table">
                    <thead>
                        <tr>${Object.keys(data[0] || {}).map(key => `<th>${key}</th>`).join('')}</tr>
                    </thead>
                    <tbody>
                        ${data.map(row => `
                            <tr>
                                ${Object.values(row).map(value => `<td>${value}</td>`).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            previewDiv.style.display = 'block';
            showToast('success', 'Vista previa', 'Datos cargados para revisión');
        }
        
        function processImport() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showToast('warning', 'Sin archivo', 'Seleccione un archivo primero');
                return;
            }
            
            showToast('info', 'Importando...', 'Procesando datos, por favor espere');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    let data;
                    if (file.name.endsWith('.json')) {
                        data = JSON.parse(e.target.result);
                    } else if (file.name.endsWith('.csv')) {
                        data = parseCSV(e.target.result);
                    }
                    
                    // Simulate import process
                    setTimeout(() => {
                        const imported = Math.min(data.length, 50); // Limit import for demo
                        showToast('success', 'Importación completa', `${imported} registros importados correctamente`);
                        closeModal();
                        
                        // Refresh current module if relevant
                        if (currentModule === 'patients' || currentModule === 'appointments' || currentModule === 'inventory') {
                            loadModuleContent(currentModule);
                        }
                    }, 2000);
                    
                } catch (error) {
                    showToast('error', 'Error de importación', 'No se pudieron procesar los datos');
                }
            };
            
            reader.readAsText(file);
        }
        
        // === ADVANCED NOTIFICATION SYSTEM ===
        function showAdvancedExportOptions() {
            document.getElementById('modalTitle').textContent = 'Opciones de Exportación Avanzada';
            document.getElementById('modalBody').innerHTML = `
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Tipo de datos</label>
                        <select id="exportDataType" class="form-control">
                            <option value="patients">Pacientes</option>
                            <option value="appointments">Citas</option>
                            <option value="inventory">Inventario</option>
                            <option value="financials">Facturación</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Formato</label>
                        <select id="exportFormat" class="form-control">
                            <option value="csv">CSV</option>
                            <option value="pdf">PDF</option>
                            <option value="excel">Excel (simulado)</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Rango de fechas</label>
                    <div class="form-row">
                        <input type="date" id="exportDateFrom" class="form-control">
                        <input type="date" id="exportDateTo" class="form-control">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Filtros adicionales</label>
                    <div id="exportFilters">
                        <label><input type="checkbox" checked> Incluir datos completos</label><br>
                        <label><input type="checkbox"> Solo registros activos</label><br>
                        <label><input type="checkbox"> Incluir estadísticas</label>
                    </div>
                </div>
                
                <div style="display: flex; gap: var(--space-12); justify-content: flex-end; margin-top: var(--space-20);">
                    <button type="button" class="btn btn--outline" onclick="closeModal()">Cancelar</button>
                    <button type="button" class="btn btn--primary" onclick="executeAdvancedExport()">Exportar</button>
                </div>
            `;
            
            document.getElementById('formModal').classList.add('active');
        }
        
        function executeAdvancedExport() {
            const dataType = document.getElementById('exportDataType').value;
            const format = document.getElementById('exportFormat').value;
            
            advancedExport(dataType, format);
            closeModal();
        }
        
        // === AUDIT AND BACKUP FUNCTIONALITY ===
        function showAuditLog() {
            const auditEntries = [
                { user: currentUser.name, action: 'Login exitoso', module: 'Auth', timestamp: new Date().toISOString(), ip: '192.168.1.100' },
                { user: 'Dr. María García', action: 'Crear cita médica', module: 'Citas', timestamp: new Date(Date.now() - 3600000).toISOString(), ip: '192.168.1.101' },
                { user: 'Ana Martínez', action: 'Actualizar historial paciente', module: 'Historiales', timestamp: new Date(Date.now() - 7200000).toISOString(), ip: '192.168.1.102' },
                { user: 'Admin', action: 'Backup automático', module: 'Sistema', timestamp: new Date(Date.now() - 10800000).toISOString(), ip: '192.168.1.1' },
                { user: 'Dr. Pedro López', action: 'Prescribir medicación', module: 'Recetas', timestamp: new Date(Date.now() - 14400000).toISOString(), ip: '192.168.1.103' }
            ];
            
            document.getElementById('modalTitle').textContent = 'Registro de Auditoría - RGPD';
            document.getElementById('modalBody').innerHTML = `
                <div style="margin-bottom: var(--space-16);">
                    <div class="form-row">
                        <input type="date" class="form-control" placeholder="Fecha desde" style="margin-right: var(--space-8);">
                        <input type="date" class="form-control" placeholder="Fecha hasta" style="margin-right: var(--space-8);">
                        <button class="btn btn--outline btn--sm">Filtrar</button>
                    </div>
                </div>
                
                <div style="max-height: 400px; overflow-y: auto;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Fecha/Hora</th>
                                <th>Usuario</th>
                                <th>Acción</th>
                                <th>Módulo</th>
                                <th>IP</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${auditEntries.map(entry => `
                                <tr>
                                    <td style="font-size: var(--font-size-xs);">${new Date(entry.timestamp).toLocaleString('es-ES')}</td>
                                    <td>${entry.user}</td>
                                    <td>${entry.action}</td>
                                    <td><span class="filter-chip">${entry.module}</span></td>
                                    <td style="font-family: monospace; font-size: var(--font-size-xs);">${entry.ip}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: var(--space-16); padding: var(--space-12); background: var(--color-bg-1); border-radius: var(--radius-base);">
                    <h5 style="margin-bottom: var(--space-8);">Cumplimiento RGPD</h5>
                    <p style="font-size: var(--font-size-sm); margin-bottom: var(--space-8);">✅ Registro de accesos activado</p>
                    <p style="font-size: var(--font-size-sm); margin-bottom: var(--space-8);">✅ Encriptación de datos sensibles</p>
                    <p style="font-size: var(--font-size-sm); margin-bottom: var(--space-8);">✅ Retención de logs: 2 años</p>
                    <p style="font-size: var(--font-size-sm);">✅ Derecho al olvido implementado</p>
                </div>
                
                <div style="display: flex; gap: var(--space-12); justify-content: flex-end; margin-top: var(--space-20);">
                    <button type="button" class="btn btn--outline" onclick="closeModal()">Cerrar</button>
                    <button type="button" class="btn btn--primary" onclick="exportAuditLog()">Exportar Log</button>
                </div>
            `;
            
            document.getElementById('formModal').classList.add('active');
        }
        
        function exportAuditLog() {
            showToast('success', 'Exportación', 'Registro de auditoría exportado como archivo encriptado');
            closeModal();
        }
        
        function simulateBackup() {
            // Simulate backup process with progress
            document.getElementById('modalTitle').textContent = 'Copia de Seguridad en Proceso';
            document.getElementById('modalBody').innerHTML = `
                <div style="text-align: center; padding: var(--space-24);">
                    <i class="fas fa-database" style="font-size: 3rem; color: var(--color-primary); margin-bottom: var(--space-16);"></i>
                    <h4 style="margin-bottom: var(--space-16);">Creando Copia de Seguridad</h4>
                    
                    <div class="progress-bar" style="margin: var(--space-20) 0;">
                        <div id="backupProgress" class="progress-fill" style="width: 0%; transition: width 0.5s ease;"></div>
                    </div>
                    
                    <div id="backupStatus" style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-16);">Preparando...</div>
                    
                    <div id="backupDetails" style="font-size: var(--font-size-xs); color: var(--color-text-secondary); text-align: left; background: var(--color-surface); padding: var(--space-12); border-radius: var(--radius-base); max-height: 150px; overflow-y: auto;">
                        <div>Iniciando proceso de backup...</div>
                    </div>
                </div>
            `;
            
            document.getElementById('formModal').classList.add('active');
            
            // Simulate backup process
            const steps = [
                { progress: 10, status: 'Verificando integridad de datos...', detail: 'Comprobando consistencia de base de datos' },
                { progress: 25, status: 'Exportando datos de pacientes...', detail: `Procesando ${patients.length} registros de pacientes` },
                { progress: 40, status: 'Exportando citas y horarios...', detail: `Procesando ${appointments.length} citas programadas` },
                { progress: 55, status: 'Exportando historiales médicos...', detail: `Procesando ${medicalRecords.length} historiales médicos` },
                { progress: 70, status: 'Exportando datos de facturación...', detail: `Procesando ${invoices.length} facturas` },
                { progress: 85, status: 'Comprimiendo archivos...', detail: 'Aplicando compresión y encriptación' },
                { progress: 95, status: 'Verificando backup...', detail: 'Validando integridad del archivo de backup' },
                { progress: 100, status: 'Backup completado exitosamente', detail: 'Archivo guardado: backup_hospital_' + new Date().toISOString().split('T')[0] + '.enc' }
            ];
            
            let currentStep = 0;
            const interval = setInterval(() => {
                if (currentStep < steps.length) {
                    const step = steps[currentStep];
                    document.getElementById('backupProgress').style.width = step.progress + '%';
                    document.getElementById('backupStatus').textContent = step.status;
                    document.getElementById('backupDetails').innerHTML += '<div>' + step.detail + '</div>';
                    document.getElementById('backupDetails').scrollTop = document.getElementById('backupDetails').scrollHeight;
                    
                    currentStep++;
                } else {
                    clearInterval(interval);
                    setTimeout(() => {
                        showToast('success', 'Backup Completado', 'Copia de seguridad creada exitosamente');
                        closeModal();
                    }, 2000);
                }
            }, 800);
        }
        
        // Advanced module functions
        function loadSurgeryModule() {
            const module = document.getElementById('surgeryModule');
            module.innerHTML = `
                <div class="breadcrumbs">
                    <span>Dashboard</span>
                    <span class="breadcrumb-separator">></span>
                    <span>Quirófanos</span>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-20); margin-bottom: var(--space-24);">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Programación Quirúrgica</h3>
                            <button class="btn btn--primary btn--sm" onclick="showSurgeryModal()">
                                <i class="fas fa-plus"></i> Nueva Cirugía
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Paciente</th>
                                            <th>Procedimiento</th>
                                            <th>Fecha/Hora</th>
                                            <th>Cirujano</th>
                                            <th>Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${surgeries.map(surgery => `
                                            <tr class="fade-in">
                                                <td>
                                                    <strong>${surgery.patient_name}</strong>
                                                </td>
                                                <td>
                                                    <div class="tooltip" data-tooltip="Duración estimada: ${surgery.duration} min">
                                                        ${surgery.procedure}
                                                    </div>
                                                </td>
                                                <td>
                                                    ${surgery.date}<br>
                                                    <small>${surgery.time}</small>
                                                </td>
                                                <td>${surgery.surgeon}</td>
                                                <td><span class="status status--warning">${surgery.status}</span></td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">Estado de Quirófanos</h4>
                        </div>
                        <div class="card-body">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-12);">
                                <div style="padding: var(--space-12); border: 1px solid var(--color-border); border-radius: var(--radius-base); text-align: center;">
                                    <div style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--color-success);">Quirófano 1</div>
                                    <div class="status status--warning">Ocupado</div>
                                    <small style="color: var(--color-text-secondary);">Angioplastia - 09:00</small>
                                </div>
                                <div style="padding: var(--space-12); border: 1px solid var(--color-border); border-radius: var(--radius-base); text-align: center;">
                                    <div style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--color-success);">Quirófano 2</div>
                                    <div class="status status--success">Disponible</div>
                                    <small style="color: var(--color-text-secondary);">Listo para uso</small>
                                </div>
                                <div style="padding: var(--space-12); border: 1px solid var(--color-border); border-radius: var(--radius-base); text-align: center;">
                                    <div style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--color-success);">Quirófano 3</div>
                                    <div class="status status--error">Limpieza</div>
                                    <small style="color: var(--color-text-secondary);">Disponible 16:00</small>
                                </div>
                                <div style="padding: var(--space-12); border: 1px solid var(--color-border); border-radius: var(--radius-base); text-align: center;">
                                    <div style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--color-success);">Quirófano 4</div>
                                    <div class="status status--success">Disponible</div>
                                    <small style="color: var(--color-text-secondary);">Listo para uso</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function loadEmergencyModule() {
            const module = document.getElementById('emergencyModule');
            module.innerHTML = `
                <div class="breadcrumbs">
                    <span>Dashboard</span>
                    <span class="breadcrumb-separator">></span>
                    <span>Urgencias</span>
                </div>
                
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--space-20);">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Pacientes en Urgencias</h3>
                            <button class="btn btn--primary btn--sm" onclick="showTriageModal()">
                                <i class="fas fa-plus"></i> Nuevo Paciente
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Paciente</th>
                                            <th>Triaje</th>
                                            <th>Síntomas</th>
                                            <th>Llegada</th>
                                            <th>Tiempo Espera</th>
                                            <th>Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${emergencies.map(emergency => `
                                            <tr class="fade-in">
                                                <td><strong>${emergency.patient_name}</strong></td>
                                                <td>
                                                    <span class="status ${
                                                        emergency.triage_level === 'Crítico' ? 'status--error' :
                                                        emergency.triage_level === 'Urgente' ? 'status--warning' : 'status--info'
                                                    }">${emergency.triage_level}</span>
                                                </td>
                                                <td>
                                                    <div class="tooltip" data-tooltip="${emergency.vital_signs ? Object.entries(emergency.vital_signs).map(([k,v]) => k + ': ' + v).join(', ') : ''}">
                                                        ${emergency.symptoms}
                                                    </div>
                                                </td>
                                                <td>${formatTime(emergency.arrival_time)}</td>
                                                <td>
                                                    ${Math.floor((Date.now() - new Date(emergency.arrival_time)) / 60000)} min
                                                </td>
                                                <td><span class="status status--warning">${emergency.status}</span></td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <div class="card" style="margin-bottom: var(--space-16);">
                            <div class="card-header">
                                <h4 class="card-title">Protocolo de Triaje</h4>
                            </div>
                            <div class="card-body">
                                <div style="margin-bottom: var(--space-12);">
                                    <div class="status status--error" style="width: 100%; justify-content: center; margin-bottom: var(--space-8);">CRÍTICO</div>
                                    <small style="color: var(--color-text-secondary);">Riesgo vital inmediato</small>
                                </div>
                                <div style="margin-bottom: var(--space-12);">
                                    <div class="status status--warning" style="width: 100%; justify-content: center; margin-bottom: var(--space-8);">URGENTE</div>
                                    <small style="color: var(--color-text-secondary);">Atención en 15 min</small>
                                </div>
                                <div style="margin-bottom: var(--space-12);">
                                    <div class="status status--info" style="width: 100%; justify-content: center; margin-bottom: var(--space-8);">MENOS URGENTE</div>
                                    <small style="color: var(--color-text-secondary);">Atención en 60 min</small>
                                </div>
                                <div>
                                    <div class="status status--success" style="width: 100%; justify-content: center; margin-bottom: var(--space-8);">NO URGENTE</div>
                                    <small style="color: var(--color-text-secondary);">Atención en 120 min</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h4 class="card-title">Estadísticas del Día</h4>
                            </div>
                            <div class="card-body">
                                <div style="margin-bottom: var(--space-12);">
                                    <div>Total Pacientes</div>
                                    <div class="stat-number" style="font-size: var(--font-size-xl);">${emergencies.length}</div>
                                </div>
                                <div style="margin-bottom: var(--space-12);">
                                    <div>Tiempo Promedio</div>
                                    <div class="stat-number" style="font-size: var(--font-size-xl); color: var(--color-warning);">15 min</div>
                                </div>
                                <div>
                                    <div>Camas Disponibles</div>
                                    <div class="stat-number" style="font-size: var(--font-size-xl); color: var(--color-success);">8/12</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function loadRoomsModule() {
            const module = document.getElementById('roomsModule');
            module.innerHTML = `
                <div class="breadcrumbs">
                    <span>Dashboard</span>
                    <span class="breadcrumb-separator">></span>
                    <span>Habitaciones y Hospitalización</span>
                </div>
                
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--space-20);">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Mapa de Habitaciones</h3>
                            <div>
                                <button class="btn btn--outline btn--sm" onclick="showRoomFilters()">
                                    <i class="fas fa-filter"></i> Filtros
                                </button>
                                <button class="btn btn--primary btn--sm" onclick="assignRoom()">
                                    <i class="fas fa-bed"></i> Asignar Habitación
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div style="margin-bottom: var(--space-16);">
                                <strong>Planta 1</strong>
                                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: var(--space-8); margin: var(--space-12) 0;">
                                    ${Array.from({length: 5}, (_, i) => {
                                        const roomId = `10${i+1}A`;
                                        const room = rooms.find(r => r.id === roomId) || {status: 'Disponible'};
                                        return `
                                            <div class="tooltip" data-tooltip="Habitación ${roomId}" style="
                                                aspect-ratio: 1;
                                                border: 2px solid var(--color-border);
                                                border-radius: var(--radius-base);
                                                display: flex;
                                                align-items: center;
                                                justify-content: center;
                                                cursor: pointer;
                                                background: ${room.status === 'Ocupada' ? 'var(--color-bg-4)' : 
                                                              room.status === 'Limpieza' ? 'var(--color-bg-2)' : 'var(--color-bg-3)'};
                                            " onclick="showRoomDetails('${roomId}')">
                                                <div style="text-align: center;">
                                                    <div style="font-size: var(--font-size-xs); font-weight: var(--font-weight-bold);">${roomId}</div>
                                                    <i class="fas ${
                                                        room.status === 'Ocupada' ? 'fa-user' :
                                                        room.status === 'Limpieza' ? 'fa-broom' : 'fa-bed'
                                                    }" style="font-size: var(--font-size-sm);"></i>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                                
                                <strong>Planta 2</strong>
                                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: var(--space-8); margin: var(--space-12) 0;">
                                    ${Array.from({length: 5}, (_, i) => {
                                        const roomId = `20${i+1}A`;
                                        const room = rooms.find(r => r.id === roomId) || {
                                            status: i === 0 ? 'Ocupada' : i === 1 ? 'Limpieza' : 'Disponible'
                                        };
                                        return `
                                            <div class="tooltip" data-tooltip="Habitación ${roomId}" style="
                                                aspect-ratio: 1;
                                                border: 2px solid var(--color-border);
                                                border-radius: var(--radius-base);
                                                display: flex;
                                                align-items: center;
                                                justify-content: center;
                                                cursor: pointer;
                                                background: ${room.status === 'Ocupada' ? 'var(--color-bg-4)' : 
                                                              room.status === 'Limpieza' ? 'var(--color-bg-2)' : 'var(--color-bg-3)'};
                                            " onclick="showRoomDetails('${roomId}')">
                                                <div style="text-align: center;">
                                                    <div style="font-size: var(--font-size-xs); font-weight: var(--font-weight-bold);">${roomId}</div>
                                                    <i class="fas ${
                                                        room.status === 'Ocupada' ? 'fa-user' :
                                                        room.status === 'Limpieza' ? 'fa-broom' : 'fa-bed'
                                                    }" style="font-size: var(--font-size-sm);"></i>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <div class="card" style="margin-bottom: var(--space-16);">
                            <div class="card-header">
                                <h4 class="card-title">Ocupación</h4>
                            </div>
                            <div class="card-body">
                                <div style="margin-bottom: var(--space-12);">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-4);">
                                        <span>Ocupadas</span>
                                        <span>7/15</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: 47%;"></div>
                                    </div>
                                </div>
                                <div style="margin-bottom: var(--space-12);">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-4);">
                                        <span>Limpieza</span>
                                        <span>3/15</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: 20%; background: var(--color-warning);"></div>
                                    </div>
                                </div>
                                <div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-4);">
                                        <span>Disponibles</span>
                                        <span>5/15</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: 33%; background: var(--color-success);"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h4 class="card-title">Leyenda</h4>
                            </div>
                            <div class="card-body">
                                <div style="display: flex; align-items: center; margin-bottom: var(--space-8);">
                                    <div style="width: 16px; height: 16px; background: var(--color-bg-4); border-radius: var(--radius-sm); margin-right: var(--space-8);"></div>
                                    <span>Ocupada</span>
                                </div>
                                <div style="display: flex; align-items: center; margin-bottom: var(--space-8);">
                                    <div style="width: 16px; height: 16px; background: var(--color-bg-2); border-radius: var(--radius-sm); margin-right: var(--space-8);"></div>
                                    <span>Limpieza</span>
                                </div>
                                <div style="display: flex; align-items: center;">
                                    <div style="width: 16px; height: 16px; background: var(--color-bg-3); border-radius: var(--radius-sm); margin-right: var(--space-8);"></div>
                                    <span>Disponible</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function loadCommunicationsModule() {
            const module = document.getElementById('communicationsModule');
            module.innerHTML = `
                <div class="breadcrumbs">
                    <span>Dashboard</span>
                    <span class="breadcrumb-separator">></span>
                    <span>Comunicaciones</span>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-20);">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Mensajes Internos</h3>
                            <button class="btn btn--primary btn--sm" onclick="showMessageModal()">
                                <i class="fas fa-plus"></i> Nuevo Mensaje
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>De</th>
                                            <th>Para</th>
                                            <th>Asunto</th>
                                            <th>Fecha</th>
                                            <th>Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${communications.map(comm => `
                                            <tr class="fade-in ${comm.urgent ? 'urgent' : ''}">
                                                <td>${comm.from}</td>
                                                <td>${comm.to}</td>
                                                <td>
                                                    <div class="tooltip" data-tooltip="${comm.message}">
                                                        ${comm.subject}
                                                        ${comm.urgent ? '<i class="fas fa-exclamation" style="color: var(--color-error); margin-left: var(--space-4);"></i>' : ''}
                                                    </div>
                                                </td>
                                                <td>${formatTime(comm.time)}</td>
                                                <td>
                                                    <span class="status ${comm.read ? 'status--success' : 'status--warning'}">
                                                        ${comm.read ? 'Leído' : 'No leído'}
                                                    </span>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <div class="card" style="margin-bottom: var(--space-16);">
                            <div class="card-header">
                                <h4 class="card-title">Chat en Vivo - Equipo Médico</h4>
                            </div>
                            <div class="card-body">
                                <div id="chatMessages" style="height: 300px; overflow-y: auto; border: 1px solid var(--color-border); border-radius: var(--radius-base); padding: var(--space-12); margin-bottom: var(--space-12);">
                                    <div style="margin-bottom: var(--space-12);">
                                        <strong style="color: var(--color-primary);">Dr. María García</strong>
                                        <small style="color: var(--color-text-secondary); margin-left: var(--space-8);">14:30</small>
                                        <div style="margin-top: var(--space-4);">Paciente Carlos listo para cirugía</div>
                                    </div>
                                    <div style="margin-bottom: var(--space-12);">
                                        <strong style="color: var(--color-success);">Ana Martínez</strong>
                                        <small style="color: var(--color-text-secondary); margin-left: var(--space-8);">14:32</small>
                                        <div style="margin-top: var(--space-4);">Perfecto, preparando quirófano 1</div>
                                    </div>
                                    <div>
                                        <strong style="color: var(--color-warning);">Dr. José Martín</strong>
                                        <small style="color: var(--color-text-secondary); margin-left: var(--space-8);">14:35</small>
                                        <div style="margin-top: var(--space-4);">¿Está disponible el anestesiólogo?</div>
                                    </div>
                                </div>
                                <div style="display: flex; gap: var(--space-8);">
                                    <input type="text" class="form-control" placeholder="Escribir mensaje..." style="flex: 1;">
                                    <button class="btn btn--primary" onclick="sendChatMessage()">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h4 class="card-title">Avisos Generales</h4>
                            </div>
                            <div class="card-body">
                                <div class="notification-item info">
                                    <strong>Mantenimiento Programado</strong><br>
                                    <small>Sistema de rayos X no disponible el viernes de 14:00 a 16:00</small>
                                </div>
                                <div class="notification-item warning">
                                    <strong>Nuevo Protocolo COVID</strong><br>
                                    <small>Recordatorio: uso obligatorio de EPP en todas las áreas</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function loadReportsModule() {
            const module = document.getElementById('reportsModule');
            module.innerHTML = `
                <div class="breadcrumbs">
                    <span>Dashboard</span>
                    <span class="breadcrumb-separator">></span>
                    <span>Estadísticas y Reportes</span>
                </div>
                
                <div class="tab-navigation">
                    <div class="tab-item active" data-tab="dashboard">Dashboard Ejecutivo</div>
                    <div class="tab-item" data-tab="financial">Reportes Financieros</div>
                    <div class="tab-item" data-tab="clinical">Indicadores Clínicos</div>
                    <div class="tab-item" data-tab="operational">Operacionales</div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-20); margin-bottom: var(--space-24);">
                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">Ingresos por Departamento</h4>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="departmentRevenueChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">Satisfacción del Paciente</h4>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="satisfactionChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">KPIs Hospitalarios</h3>
                        <button class="btn btn--outline btn--sm" onclick="exportReport()">
                            <i class="fas fa-file-pdf"></i> Exportar PDF
                        </button>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-16);">
                            <div class="stat-card" data-bg="1">
                                <div class="stat-number">92%</div>
                                <div class="stat-label">Tasa de Ocupación</div>
                                <div class="stat-trend">↗ +3% vs mes anterior</div>
                            </div>
                            <div class="stat-card" data-bg="2">
                                <div class="stat-number">4.2</div>
                                <div class="stat-label">Estancia Media (días)</div>
                                <div class="stat-trend">↘ -0.3 vs meta</div>
                            </div>
                            <div class="stat-card" data-bg="3">
                                <div class="stat-number">1.8%</div>
                                <div class="stat-label">Tasa de Infección</div>
                                <div class="stat-trend">↘ -0.2% vs mes anterior</div>
                            </div>
                            <div class="stat-card" data-bg="4">
                                <div class="stat-number">15min</div>
                                <div class="stat-label">Tiempo Espera Promedio</div>
                                <div class="stat-trend">↗ +2min vs meta</div>
                            </div>
                            <div class="stat-card" data-bg="5">
                                <div class="stat-number">98.5%</div>
                                <div class="stat-label">Disponibilidad Sistema</div>
                                <div class="stat-trend">⭐ Excelente</div>
                            </div>
                            <div class="stat-card" data-bg="6">
                                <div class="stat-number">€2.3M</div>
                                <div class="stat-label">Ingresos Mensuales</div>
                                <div class="stat-trend">↗ +12% vs mes anterior</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Load additional charts after DOM is ready
            // Load additional charts after DOM is ready
            setTimeout(() => {
                loadDepartmentRevenueChart();
                loadSatisfactionChart();
            }, 100);
        }
        
        function loadDepartmentRevenueChart() {
            const ctx = document.getElementById('departmentRevenueChart');
            if (ctx) {
                new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['Cardiología', 'Traumatología', 'Medicina Interna', 'Cirugía', 'Urgencias'],
                        datasets: [{
                            data: [35, 25, 20, 15, 5],
                            backgroundColor: ['#1FB8CD', '#FFC185', '#B4413C', '#ECEBD5', '#5D878F']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                onClick: function(e, legendItem) {
                                    // Make chart interactive
                                    showToast('info', 'Departamento', `Detalles de ${legendItem.text}: ${legendItem.parsed}% de ingresos`);
                                }
                            }
                        }
                    }
                });
            }
        }
        
        function loadSatisfactionChart() {
            const ctx = document.getElementById('satisfactionChart');
            if (ctx) {
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Muy Insatisfecho', 'Insatisfecho', 'Neutral', 'Satisfecho', 'Muy Satisfecho'],
                        datasets: [{
                            label: 'Pacientes',
                            data: [2, 5, 15, 45, 33],
                            backgroundColor: ['#B4413C', '#FFC185', '#ECEBD5', '#5D878F', '#1FB8CD']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Número de Pacientes'
                                }
                            }
                        },
                        onClick: function(event, elements) {
                            if (elements.length > 0) {
                                const element = elements[0];
                                const label = this.data.labels[element.index];
                                const value = this.data.datasets[0].data[element.index];
                                showToast('info', 'Satisfacción', `${label}: ${value} pacientes`);
                            }
                        }
                    }
                });
            }
        }
        
        // === TABLE SORTING AND FILTERING FUNCTIONALITY ===
        let currentSort = { column: null, direction: 'asc' };
        let currentFilters = {};
        let currentPage = 1;
        const itemsPerPage = 10;
        
        function sortTable(tableId, column, data, renderFunction) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            
            const sortedData = [...data].sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];
                
                // Handle different data types
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }
                
                if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });
            
            renderFunction(sortedData);
            showToast('info', 'Ordenamiento', `Tabla ordenada por ${column} (${currentSort.direction === 'asc' ? 'ascendente' : 'descendente'})`);
        }
        
        function filterTable(data, filters) {
            return data.filter(item => {
                return Object.entries(filters).every(([key, value]) => {
                    if (!value) return true;
                    const itemValue = item[key]?.toString().toLowerCase() || '';
                    return itemValue.includes(value.toLowerCase());
                });
            });
        }
        
        function paginateData(data, page, perPage) {
            const startIndex = (page - 1) * perPage;
            const endIndex = startIndex + perPage;
            return {
                data: data.slice(startIndex, endIndex),
                totalPages: Math.ceil(data.length / perPage),
                currentPage: page,
                totalItems: data.length
            };
        }
        
        function createPaginationControls(totalPages, currentPage, onPageChange) {
            if (totalPages <= 1) return '';
            
            let pagination = '<div style="display: flex; justify-content: center; align-items: center; gap: var(--space-8); margin-top: var(--space-16);">';
            
            // Previous button
            if (currentPage > 1) {
                pagination += `<button class="btn btn--outline btn--sm" onclick="${onPageChange}(${currentPage - 1})"><i class="fas fa-chevron-left"></i></button>`;
            }
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage) {
                    pagination += `<button class="btn btn--primary btn--sm">${i}</button>`;
                } else {
                    pagination += `<button class="btn btn--outline btn--sm" onclick="${onPageChange}(${i})">${i}</button>`;
                }
            }
            
            // Next button
            if (currentPage < totalPages) {
                pagination += `<button class="btn btn--outline btn--sm" onclick="${onPageChange}(${currentPage + 1})"><i class="fas fa-chevron-right"></i></button>`;
            }
            
            pagination += '</div>';
            return pagination;
        }
        
        // Additional utility functions for enhanced UX
        function showSkeletonLoading(containerId) {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = `
                    <div class="skeleton" style="height: 20px; margin-bottom: 10px; border-radius: 4px;"></div>
                    <div class="skeleton" style="height: 20px; margin-bottom: 10px; border-radius: 4px; width: 80%;"></div>
                    <div class="skeleton" style="height: 20px; margin-bottom: 10px; border-radius: 4px; width: 60%;"></div>
                `;
            }
        }
        
        function initializeTooltips() {
            // Tooltips are handled via CSS, but we could enhance them here
            document.querySelectorAll('.tooltip').forEach(element => {
                element.addEventListener('mouseenter', function() {
                    // Could add custom tooltip behavior here
                });
            });
        }
        
        function validateForm(formData, rules) {
            const errors = [];
            
            for (const [field, rule] of Object.entries(rules)) {
                const value = formData.get(field);
                
                if (rule.required && !value) {
                    errors.push(`${field} es requerido`);
                }
                
                if (rule.minLength && value && value.length < rule.minLength) {
                    errors.push(`${field} debe tener al menos ${rule.minLength} caracteres`);
                }
                
                if (rule.pattern && value && !rule.pattern.test(value)) {
                    errors.push(`${field} tiene un formato inválido`);
                }
            }
            
            return errors;
        }
        
        function autoSave(formId, data) {
            // Simulate auto-save functionality
            const autoSaveKey = `autosave_${formId}`;
            try {
                // Note: localStorage is not available in sandbox, so we'll use memory
                window.autoSaveData = window.autoSaveData || {};
                window.autoSaveData[autoSaveKey] = data;
                showToast('info', 'Auto-guardado', 'Datos guardados automáticamente');
            } catch (error) {
                console.log('Auto-save simulated for form:', formId);
            }
        }
        
        function loadAutoSave(formId) {
            // Load auto-saved data
            const autoSaveKey = `autosave_${formId}`;
            try {
                return window.autoSaveData?.[autoSaveKey] || null;
            } catch (error) {
                return null;
            }
        }
        
        // CRUD OPERATIONS - TOTALMENTE FUNCIONALES
        
        // === APPOINTMENTS MANAGEMENT ===
        function showAppointmentModal(appointmentId = null) {
            const appointment = appointmentId ? appointments.find(a => a.id === appointmentId) : {};
            const isEdit = !!appointmentId;
            
            document.getElementById('modalTitle').textContent = isEdit ? 'Editar Cita' : 'Nueva Cita';
            document.getElementById('modalBody').innerHTML = `
                <form id="appointmentForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Paciente</label>
                            <select name="patient_id" class="form-control" required>
                                <option value="">Seleccionar paciente...</option>
                                ${patients.map(p => `<option value="${p.id}" ${appointment.patient_id == p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Doctor</label>
                            <select name="doctor" class="form-control" required>
                                <option value="">Seleccionar doctor...</option>
                                ${doctors.map(d => `<option value="${d.name}" ${appointment.doctor === d.name ? 'selected' : ''}>${d.name} - ${d.specialty}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Fecha</label>
                            <input type="date" name="date" class="form-control" value="${appointment.date || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Hora</label>
                            <input type="time" name="time" class="form-control" value="${appointment.time || ''}" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Motivo de la consulta</label>
                        <textarea name="reason" class="form-control" rows="3" required>${appointment.reason || ''}</textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Estado</label>
                            <select name="status" class="form-control" required>
                                <option value="Programada" ${appointment.status === 'Programada' ? 'selected' : ''}>Programada</option>
                                <option value="Confirmada" ${appointment.status === 'Confirmada' ? 'selected' : ''}>Confirmada</option>
                                <option value="Completada" ${appointment.status === 'Completada' ? 'selected' : ''}>Completada</option>
                                <option value="Cancelada" ${appointment.status === 'Cancelada' ? 'selected' : ''}>Cancelada</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Especialidad</label>
                            <input type="text" name="specialty" class="form-control" value="${appointment.specialty || ''}" readonly>
                        </div>
                    </div>
                    <div style="display: flex; gap: var(--space-12); justify-content: flex-end; margin-top: var(--space-20);">
                        <button type="button" class="btn btn--outline" onclick="closeModal()">Cancelar</button>
                        <button type="submit" class="btn btn--primary">Guardar Cita</button>
                    </div>
                </form>
            `;
            
            document.getElementById('formModal').classList.add('active');
            
            // Auto-fill specialty when doctor is selected
            const doctorSelect = document.querySelector('select[name="doctor"]');
            const specialtyInput = document.querySelector('input[name="specialty"]');
            doctorSelect.addEventListener('change', function() {
                const selectedDoctor = doctors.find(d => d.name === this.value);
                if (selectedDoctor) {
                    specialtyInput.value = selectedDoctor.specialty;
                }
            });
            
            document.getElementById('appointmentForm').onsubmit = function(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                const errors = validateAppointmentData(formData);
                
                if (showValidationErrors(errors)) {
                    saveAppointment(formData, appointmentId);
                }
            };
        }
        
        function saveAppointment(formData, appointmentId) {
            const selectedPatient = patients.find(p => p.id == formData.get('patient_id'));
            
            const appointmentData = {
                patient_id: parseInt(formData.get('patient_id')),
                patient_name: selectedPatient ? selectedPatient.name : '',
                doctor: formData.get('doctor'),
                specialty: formData.get('specialty'),
                date: formData.get('date'),
                time: formData.get('time'),
                status: formData.get('status'),
                reason: formData.get('reason')
            };
            
            if (appointmentId) {
                const index = appointments.findIndex(a => a.id === appointmentId);
                appointments[index] = { ...appointments[index], ...appointmentData };
                showToast('success', 'Cita actualizada', 'La cita se ha actualizado correctamente');
            } else {
                appointmentData.id = Math.max(...appointments.map(a => a.id)) + 1;
                appointments.push(appointmentData);
                showToast('success', 'Cita creada', 'Nueva cita programada exitosamente');
            }
            
            closeModal();
            if (currentModule === 'appointments') loadAppointmentsModule();
            updateDashboardStats();
        }
        
        function editAppointment(id) {
            showAppointmentModal(id);
        }
        
        function cancelAppointment(id) {
            if (confirm('¿Está seguro de que desea cancelar esta cita?')) {
                const appointment = appointments.find(a => a.id === id);
                if (appointment) {
                    appointment.status = 'Cancelada';
                    showToast('warning', 'Cita cancelada', 'La cita ha sido cancelada');
                    if (currentModule === 'appointments') loadAppointmentsModule();
                }
            }
        }
        
        // === MEDICAL RECORDS MANAGEMENT ===
        function showRecordModal(recordId = null) {
            const record = recordId ? medicalRecords.find(r => r.id === recordId) : {};
            const isEdit = !!recordId;
            
            document.getElementById('modalTitle').textContent = isEdit ? 'Editar Historial' : 'Nuevo Historial Médico';
            document.getElementById('modalBody').innerHTML = `
                <form id="recordForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Paciente</label>
                            <select name="patient_id" class="form-control" required>
                                <option value="">Seleccionar paciente...</option>
                                ${patients.map(p => `<option value="${p.id}" ${record.patient_id == p.id ? 'selected' : ''}>${p.name} - ${p.dni}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Médico</label>
                            <input type="text" name="doctor" class="form-control" value="${record.doctor || currentUser.name}" readonly>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Fecha</label>
                        <input type="date" name="date" class="form-control" value="${record.date || new Date().toISOString().split('T')[0]}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Diagnóstico</label>
                        <input type="text" name="diagnosis" class="form-control" value="${record.diagnosis || ''}" required placeholder="Ej: Hipertensión arterial">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tratamiento</label>
                        <textarea name="treatment" class="form-control" rows="3" required placeholder="Ej: Enalapril 10mg - 1 comp/día">${record.treatment || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notas adicionales</label>
                        <textarea name="notes" class="form-control" rows="2" placeholder="Observaciones, seguimiento, etc.">${record.notes || ''}</textarea>
                    </div>
                    <div style="display: flex; gap: var(--space-12); justify-content: flex-end; margin-top: var(--space-20);">
                        <button type="button" class="btn btn--outline" onclick="closeModal()">Cancelar</button>
                        <button type="submit" class="btn btn--primary">Guardar Historial</button>
                    </div>
                </form>
            `;
            
            document.getElementById('formModal').classList.add('active');
            
            document.getElementById('recordForm').onsubmit = function(e) {
                e.preventDefault();
                saveMedicalRecord(new FormData(e.target), recordId);
            };
        }
        
        function saveMedicalRecord(formData, recordId) {
            const recordData = {
                patient_id: parseInt(formData.get('patient_id')),
                date: formData.get('date'),
                doctor: formData.get('doctor'),
                diagnosis: formData.get('diagnosis'),
                treatment: formData.get('treatment'),
                notes: formData.get('notes')
            };
            
            if (recordId) {
                const index = medicalRecords.findIndex(r => r.id === recordId);
                medicalRecords[index] = { ...medicalRecords[index], ...recordData };
                showToast('success', 'Historial actualizado', 'El historial médico se ha actualizado');
            } else {
                recordData.id = Math.max(...medicalRecords.map(r => r.id)) + 1;
                medicalRecords.push(recordData);
                showToast('success', 'Historial creado', 'Nuevo historial médico registrado');
            }
            
            closeModal();
            if (currentModule === 'records') loadRecordsModule();
        }
        
        function viewRecord(id) {
            const record = medicalRecords.find(r => r.id === id);
            const patient = patients.find(p => p.id === record.patient_id);
            
            document.getElementById('modalTitle').textContent = 'Detalle del Historial Médico';
            document.getElementById('modalBody').innerHTML = `
                <div style="margin-bottom: var(--space-20);">
                    <h4 style="color: var(--color-primary); margin-bottom: var(--space-12);">${patient ? patient.name : 'N/A'}</h4>
                    <div class="form-row">
                        <div><strong>Fecha:</strong> ${record.date}</div>
                        <div><strong>Doctor:</strong> ${record.doctor}</div>
                    </div>
                </div>
                <div class="card" style="margin-bottom: var(--space-16);">
                    <div class="card-header">
                        <h5 class="card-title">Diagnóstico</h5>
                    </div>
                    <div class="card-body">
                        ${record.diagnosis}
                    </div>
                </div>
                <div class="card" style="margin-bottom: var(--space-16);">
                    <div class="card-header">
                        <h5 class="card-title">Tratamiento</h5>
                    </div>
                    <div class="card-body">
                        ${record.treatment}
                    </div>
                </div>
                ${record.notes ? `
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">Notas</h5>
                    </div>
                    <div class="card-body">
                        ${record.notes}
                    </div>
                </div>
                ` : ''}
                <div style="display: flex; gap: var(--space-12); justify-content: flex-end; margin-top: var(--space-20);">
                    <button type="button" class="btn btn--outline" onclick="closeModal()">Cerrar</button>
                    <button type="button" class="btn btn--primary" onclick="editRecord(${id})">Editar</button>
                </div>
            `;
            
            document.getElementById('formModal').classList.add('active');
        }
        
        function editRecord(id) {
            closeModal();
            setTimeout(() => showRecordModal(id), 100);
        }
        
        // === DOCTORS MANAGEMENT ===
        function showDoctorModal(doctorId = null) {
            const doctor = doctorId ? doctors.find(d => d.id === doctorId) : {};
            const isEdit = !!doctorId;
            
            document.getElementById('modalTitle').textContent = isEdit ? 'Editar Personal' : 'Nuevo Personal Médico';
            document.getElementById('modalBody').innerHTML = `
                <form id="doctorForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Nombre Completo</label>
                            <input type="text" name="name" class="form-control" value="${doctor.name || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Especialidad</label>
                            <select name="specialty" class="form-control" required>
                                <option value="">Seleccionar...</option>
                                <option value="Cardiología" ${doctor.specialty === 'Cardiología' ? 'selected' : ''}>Cardiología</option>
                                <option value="Medicina General" ${doctor.specialty === 'Medicina General' ? 'selected' : ''}>Medicina General</option>
                                <option value="Traumatología" ${doctor.specialty === 'Traumatología' ? 'selected' : ''}>Traumatología</option>
                                <option value="Pediatría" ${doctor.specialty === 'Pediatría' ? 'selected' : ''}>Pediatría</option>
                                <option value="Ginecología" ${doctor.specialty === 'Ginecología' ? 'selected' : ''}>Ginecología</option>
                                <option value="Neurología" ${doctor.specialty === 'Neurología' ? 'selected' : ''}>Neurología</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Número de Colegiado</label>
                            <input type="text" name="license" class="form-control" value="${doctor.license || ''}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Teléfono</label>
                            <input type="tel" name="phone" class="form-control" value="${doctor.phone || ''}" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" name="email" class="form-control" value="${doctor.email || ''}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Horario</label>
                        <input type="text" name="schedule" class="form-control" value="${doctor.schedule || ''}" placeholder="Ej: L-V 8:00-15:00" required>
                    </div>
                    <div style="display: flex; gap: var(--space-12); justify-content: flex-end; margin-top: var(--space-20);">
                        <button type="button" class="btn btn--outline" onclick="closeModal()">Cancelar</button>
                        <button type="submit" class="btn btn--primary">Guardar</button>
                    </div>
                </form>
            `;
            
            document.getElementById('formModal').classList.add('active');
            
            document.getElementById('doctorForm').onsubmit = function(e) {
                e.preventDefault();
                saveDoctor(new FormData(e.target), doctorId);
            };
        }
        
        function saveDoctor(formData, doctorId) {
            const doctorData = {
                name: formData.get('name'),
                specialty: formData.get('specialty'),
                license: formData.get('license'),
                phone: formData.get('phone'),
                email: formData.get('email'),
                schedule: formData.get('schedule')
            };
            
            if (doctorId) {
                const index = doctors.findIndex(d => d.id === doctorId);
                doctors[index] = { ...doctors[index], ...doctorData };
                showToast('success', 'Personal actualizado', 'Los datos del personal se han actualizado');
            } else {
                doctorData.id = Math.max(...doctors.map(d => d.id)) + 1;
                doctors.push(doctorData);
                showToast('success', 'Personal agregado', 'Nuevo personal médico registrado');
            }
            
            closeModal();
            if (currentModule === 'doctors') loadDoctorsModule();
        }
        
        function editDoctor(id) {
            showDoctorModal(id);
        }
        
        function deleteDoctor(id) {
            if (confirm('¿Está seguro de que desea eliminar este personal médico?')) {
                const index = doctors.findIndex(d => d.id === id);
                doctors.splice(index, 1);
                showToast('warning', 'Personal eliminado', 'El personal médico ha sido eliminado');
                if (currentModule === 'doctors') loadDoctorsModule();
            }
        }
        
        // === PRESCRIPTIONS MANAGEMENT ===
        function showPrescriptionModal(prescriptionId = null) {
            const prescription = prescriptionId ? prescriptions.find(p => p.id === prescriptionId) : {};
            const isEdit = !!prescriptionId;
            
            document.getElementById('modalTitle').textContent = isEdit ? 'Editar Receta' : 'Nueva Receta Médica';
            document.getElementById('modalBody').innerHTML = `
                <form id="prescriptionForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Paciente</label>
                            <select name="patient_id" class="form-control" required>
                                <option value="">Seleccionar paciente...</option>
                                ${patients.map(p => `<option value="${p.id}" ${prescription.patient_id == p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Médico</label>
                            <input type="text" name="doctor" class="form-control" value="${prescription.doctor || currentUser.name}" readonly>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Fecha</label>
                        <input type="date" name="date" class="form-control" value="${prescription.date || new Date().toISOString().split('T')[0]}" required>
                    </div>
                    <div class="card" style="margin: var(--space-16) 0;">
                        <div class="card-header">
                            <h5 class="card-title">Medicamentos</h5>
                            <button type="button" class="btn btn--outline btn--sm" onclick="addMedication()">+ Agregar</button>
                        </div>
                        <div class="card-body" id="medicationsContainer">
                            ${(prescription.medications || [{}]).map((med, index) => `
                                <div class="medication-row" style="margin-bottom: var(--space-16); padding: var(--space-12); border: 1px solid var(--color-border); border-radius: var(--radius-base);">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Medicamento</label>
                                            <select name="medication_name_${index}" class="form-control" required>
                                                <option value="">Seleccionar...</option>
                                                ${medications.map(m => `<option value="${m.name}" ${med.name === m.name ? 'selected' : ''}>${m.name} - ${m.dosage}</option>`).join('')}
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Dosis</label>
                                            <input type="text" name="medication_dosage_${index}" class="form-control" value="${med.dosage || ''}" placeholder="10mg" required>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Frecuencia</label>
                                            <select name="medication_frequency_${index}" class="form-control" required>
                                                <option value="1 vez al día" ${med.frequency === '1 vez al día' ? 'selected' : ''}>1 vez al día</option>
                                                <option value="2 veces al día" ${med.frequency === '2 veces al día' ? 'selected' : ''}>2 veces al día</option>
                                                <option value="3 veces al día" ${med.frequency === '3 veces al día' ? 'selected' : ''}>3 veces al día</option>
                                                <option value="Cada 8 horas" ${med.frequency === 'Cada 8 horas' ? 'selected' : ''}>Cada 8 horas</option>
                                                <option value="Cada 12 horas" ${med.frequency === 'Cada 12 horas' ? 'selected' : ''}>Cada 12 horas</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Duración</label>
                                            <input type="text" name="medication_duration_${index}" class="form-control" value="${med.duration || ''}" placeholder="7 días" required>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn--outline btn--sm" onclick="removeMedication(this)" style="margin-top: var(--space-8);">Eliminar</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div style="display: flex; gap: var(--space-12); justify-content: flex-end; margin-top: var(--space-20);">
                        <button type="button" class="btn btn--outline" onclick="closeModal()">Cancelar</button>
                        <button type="submit" class="btn btn--primary">Guardar Receta</button>
                    </div>
                </form>
            `;
            
            document.getElementById('formModal').classList.add('active');
            
            document.getElementById('prescriptionForm').onsubmit = function(e) {
                e.preventDefault();
                savePrescription(new FormData(e.target), prescriptionId);
            };
        }
        
        function addMedication() {
            const container = document.getElementById('medicationsContainer');
            const index = container.children.length;
            const medicationRow = document.createElement('div');
            medicationRow.className = 'medication-row';
            medicationRow.style.cssText = 'margin-bottom: var(--space-16); padding: var(--space-12); border: 1px solid var(--color-border); border-radius: var(--radius-base);';
            medicationRow.innerHTML = `
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Medicamento</label>
                        <select name="medication_name_${index}" class="form-control" required>
                            <option value="">Seleccionar...</option>
                            ${medications.map(m => `<option value="${m.name}">${m.name} - ${m.dosage}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Dosis</label>
                        <input type="text" name="medication_dosage_${index}" class="form-control" placeholder="10mg" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Frecuencia</label>
                        <select name="medication_frequency_${index}" class="form-control" required>
                            <option value="1 vez al día">1 vez al día</option>
                            <option value="2 veces al día">2 veces al día</option>
                            <option value="3 veces al día">3 veces al día</option>
                            <option value="Cada 8 horas">Cada 8 horas</option>
                            <option value="Cada 12 horas">Cada 12 horas</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Duración</label>
                        <input type="text" name="medication_duration_${index}" class="form-control" placeholder="7 días" required>
                    </div>
                </div>
                <button type="button" class="btn btn--outline btn--sm" onclick="removeMedication(this)" style="margin-top: var(--space-8);">Eliminar</button>
            `;
            container.appendChild(medicationRow);
        }
        
        function removeMedication(button) {
            button.parentElement.remove();
        }
        
        function savePrescription(formData, prescriptionId) {
            const selectedPatient = patients.find(p => p.id == formData.get('patient_id'));
            
            // Collect medications
            const medications = [];
            let index = 0;
            while (formData.get(`medication_name_${index}`) !== null) {
                medications.push({
                    name: formData.get(`medication_name_${index}`),
                    dosage: formData.get(`medication_dosage_${index}`),
                    frequency: formData.get(`medication_frequency_${index}`),
                    duration: formData.get(`medication_duration_${index}`)
                });
                index++;
            }
            
            const prescriptionData = {
                patient_id: parseInt(formData.get('patient_id')),
                patient_name: selectedPatient ? selectedPatient.name : '',
                doctor: formData.get('doctor'),
                date: formData.get('date'),
                medications: medications,
                status: 'Activa'
            };
            
            if (prescriptionId) {
                const index = prescriptions.findIndex(p => p.id === prescriptionId);
                prescriptions[index] = { ...prescriptions[index], ...prescriptionData };
                showToast('success', 'Receta actualizada', 'La receta médica se ha actualizado');
            } else {
                prescriptionData.id = Math.max(...prescriptions.map(p => p.id)) + 1;
                prescriptions.push(prescriptionData);
                showToast('success', 'Receta creada', 'Nueva receta médica registrada');
            }
            
            closeModal();
            if (currentModule === 'prescriptions') loadPrescriptionsModule();
        }
        
        function printPrescription(id) {
            const prescription = prescriptions.find(p => p.id === id);
            const patient = patients.find(p => p.id === prescription.patient_id);
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Receta Médica - ${patient ? patient.name : 'N/A'}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; }
                        .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 30px; }
                        .patient-info { margin-bottom: 30px; }
                        .medications { margin-bottom: 30px; }
                        .medication { margin-bottom: 15px; border-left: 4px solid #1FB8CD; padding-left: 15px; }
                        .signature { margin-top: 50px; text-align: right; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>RECETA MÉDICA</h1>
                        <p>HospiSafe - Sistema de Gestión Hospitalaria</p>
                    </div>
                    <div class="patient-info">
                        <p><strong>Paciente:</strong> ${patient ? patient.name : 'N/A'}</p>
                        <p><strong>DNI:</strong> ${patient ? patient.dni : 'N/A'}</p>
                        <p><strong>Fecha:</strong> ${prescription.date}</p>
                        <p><strong>Médico:</strong> ${prescription.doctor}</p>
                    </div>
                    <div class="medications">
                        <h3>Medicamentos Prescritos:</h3>
                        ${prescription.medications.map(med => `
                            <div class="medication">
                                <p><strong>${med.name}</strong> - ${med.dosage}</p>
                                <p>Frecuencia: ${med.frequency}</p>
                                <p>Duración: ${med.duration}</p>
                            </div>
                        `).join('')}
                    </div>
                    <div class="signature">
                        <p>_________________________</p>
                        <p><strong>${prescription.doctor}</strong></p>
                        <p>Médico Colegiado</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
            showToast('success', 'Impresión', 'Receta enviada a imprimir');
        }
        
        function editPrescription(id) {
            showPrescriptionModal(id);
        }
        
        // === BILLING MANAGEMENT ===
        function showInvoiceModal(invoiceId = null) {
            const invoice = invoiceId ? invoices.find(i => i.id === invoiceId) : {};
            const isEdit = !!invoiceId;
            
            document.getElementById('modalTitle').textContent = isEdit ? 'Editar Factura' : 'Nueva Factura';
            document.getElementById('modalBody').innerHTML = `
                <form id="invoiceForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Paciente</label>
                            <select name="patient_id" class="form-control" required>
                                <option value="">Seleccionar paciente...</option>
                                ${patients.map(p => `<option value="${p.id}" ${invoice.patient_id == p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Fecha</label>
                            <input type="date" name="date" class="form-control" value="${invoice.date || new Date().toISOString().split('T')[0]}" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Concepto</label>
                            <select name="concept" class="form-control" required>
                                <option value="">Seleccionar...</option>
                                <option value="Consulta Medicina General" ${invoice.concept === 'Consulta Medicina General' ? 'selected' : ''}>Consulta Medicina General</option>
                                <option value="Consulta Cardiología" ${invoice.concept === 'Consulta Cardiología' ? 'selected' : ''}>Consulta Cardiología</option>
                                <option value="Consulta Traumatología" ${invoice.concept === 'Consulta Traumatología' ? 'selected' : ''}>Consulta Traumatología</option>
                                <option value="Análisis de Laboratorio" ${invoice.concept === 'Análisis de Laboratorio' ? 'selected' : ''}>Análisis de Laboratorio</option>
                                <option value="Radiografía" ${invoice.concept === 'Radiografía' ? 'selected' : ''}>Radiografía</option>
                                <option value="Ecografía" ${invoice.concept === 'Ecografía' ? 'selected' : ''}>Ecografía</option>
                                <option value="TAC" ${invoice.concept === 'TAC' ? 'selected' : ''}>TAC</option>
                                <option value="Resonancia Magnética" ${invoice.concept === 'Resonancia Magnética' ? 'selected' : ''}>Resonancia Magnética</option>
                                <option value="Cirugía Menor" ${invoice.concept === 'Cirugía Menor' ? 'selected' : ''}>Cirugía Menor</option>
                                <option value="Hospitalización" ${invoice.concept === 'Hospitalización' ? 'selected' : ''}>Hospitalización</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Importe (€)</label>
                            <input type="number" name="amount" class="form-control" value="${invoice.amount || ''}" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Estado</label>
                            <select name="status" class="form-control" required>
                                <option value="Pendiente" ${invoice.status === 'Pendiente' ? 'selected' : ''}>Pendiente</option>
                                <option value="Pagada" ${invoice.status === 'Pagada' ? 'selected' : ''}>Pagada</option>
                                <option value="Anulada" ${invoice.status === 'Anulada' ? 'selected' : ''}>Anulada</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Método de Pago</label>
                            <select name="payment_method" class="form-control" required>
                                <option value="Efectivo" ${invoice.payment_method === 'Efectivo' ? 'selected' : ''}>Efectivo</option>
                                <option value="Tarjeta" ${invoice.payment_method === 'Tarjeta' ? 'selected' : ''}>Tarjeta</option>
                                <option value="Transferencia" ${invoice.payment_method === 'Transferencia' ? 'selected' : ''}>Transferencia</option>
                                <option value="Seguro" ${invoice.payment_method === 'Seguro' ? 'selected' : ''}>Seguro</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: flex; gap: var(--space-12); justify-content: flex-end; margin-top: var(--space-20);">
                        <button type="button" class="btn btn--outline" onclick="closeModal()">Cancelar</button>
                        <button type="submit" class="btn btn--primary">Guardar Factura</button>
                    </div>
                </form>
            `;
            
            document.getElementById('formModal').classList.add('active');
            
            document.getElementById('invoiceForm').onsubmit = function(e) {
                e.preventDefault();
                saveInvoice(new FormData(e.target), invoiceId);
            };
        }
        
        function saveInvoice(formData, invoiceId) {
            const selectedPatient = patients.find(p => p.id == formData.get('patient_id'));
            
            const invoiceData = {
                patient_id: parseInt(formData.get('patient_id')),
                patient_name: selectedPatient ? selectedPatient.name : '',
                date: formData.get('date'),
                concept: formData.get('concept'),
                amount: parseFloat(formData.get('amount')),
                status: formData.get('status'),
                payment_method: formData.get('payment_method')
            };
            
            if (invoiceId) {
                const index = invoices.findIndex(i => i.id === invoiceId);
                invoices[index] = { ...invoices[index], ...invoiceData };
                showToast('success', 'Factura actualizada', 'La factura se ha actualizado correctamente');
            } else {
                invoiceData.id = Math.max(...invoices.map(i => i.id)) + 1;
                invoices.push(invoiceData);
                showToast('success', 'Factura creada', 'Nueva factura registrada exitosamente');
            }
            
            closeModal();
            if (currentModule === 'billing') loadBillingModule();
        }
        
        function printInvoice(id) {
            const invoice = invoices.find(i => i.id === id);
            const patient = patients.find(p => p.id === invoice.patient_id);
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Factura #${invoice.id.toString().padStart(6, '0')}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; }
                        .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 30px; }
                        .invoice-info { display: flex; justify-content: space-between; margin-bottom: 30px; }
                        .details { margin-bottom: 30px; }
                        .total { text-align: right; font-size: 1.2em; font-weight: bold; margin-top: 20px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>FACTURA</h1>
                        <p>HospiSafe - Sistema de Gestión Hospitalaria</p>
                        <p>Factura #${invoice.id.toString().padStart(6, '0')}</p>
                    </div>
                    <div class="invoice-info">
                        <div>
                            <h3>Datos del Paciente:</h3>
                            <p><strong>Nombre:</strong> ${patient ? patient.name : 'N/A'}</p>
                            <p><strong>DNI:</strong> ${patient ? patient.dni : 'N/A'}</p>
                            <p><strong>Dirección:</strong> ${patient ? patient.address : 'N/A'}</p>
                        </div>
                        <div>
                            <p><strong>Fecha:</strong> ${invoice.date}</p>
                            <p><strong>Estado:</strong> ${invoice.status}</p>
                            <p><strong>Método:</strong> ${invoice.payment_method}</p>
                        </div>
                    </div>
                    <div class="details">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 1px solid #ddd;">
                                    <th style="text-align: left; padding: 10px;">Concepto</th>
                                    <th style="text-align: right; padding: 10px;">Importe</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="padding: 10px;">${invoice.concept}</td>
                                    <td style="text-align: right; padding: 10px;">€${invoice.amount.toFixed(2)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="total">
                        <p>TOTAL: €${invoice.amount.toFixed(2)}</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
            showToast('success', 'Impresión', 'Factura enviada a imprimir');
        }
        
        function markAsPaid(id) {
            if (confirm('¿Confirma que esta factura ha sido pagada?')) {
                const invoice = invoices.find(inv => inv.id === id);
                if (invoice) {
                    invoice.status = 'Pagada';
                    showToast('success', 'Factura pagada', 'El estado de la factura se ha actualizado a pagada');
                    if (currentModule === 'billing') loadBillingModule();
                }
            }
        }
        
        // Advanced module loading functions
        function loadInventoryModule() {
            const module = document.getElementById('inventoryModule');
            module.innerHTML = `
                <div class="breadcrumbs">
                    <span>Dashboard</span>
                    <span class="breadcrumb-separator">></span>
                    <span>Inventario y Farmacia</span>
                </div>
                
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--space-20); margin-bottom: var(--space-24);">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Inventario de Medicamentos</h3>
                            <div>
                                <button class="btn btn--outline btn--sm" onclick="exportInventory()">
                                    <i class="fas fa-download"></i> Exportar
                                </button>
                                <button class="btn btn--primary btn--sm" onclick="showMedicationModal()">
                                    <i class="fas fa-plus"></i> Nuevo Medicamento
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="filter-bar">
                                <div class="filter-chip active" data-filter="all">Todos</div>
                                <div class="filter-chip" data-filter="low-stock">Stock Bajo</div>
                                <div class="filter-chip" data-filter="expired">Vencidos</div>
                                <div class="filter-chip" data-filter="IECA">IECA</div>
                                <div class="filter-chip" data-filter="AINE">AINE</div>
                            </div>
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Medicamento</th>
                                            <th>Categoría</th>
                                            <th>Stock</th>
                                            <th>Precio</th>
                                            <th>Vencimiento</th>
                                            <th>Estado</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${medications.map(med => `
                                            <tr class="fade-in">
                                                <td>
                                                    <strong>${med.name}</strong><br>
                                                    <small style="color: var(--color-text-secondary);">${med.generic_name}</small>
                                                </td>
                                                <td><span class="filter-chip">${med.category}</span></td>
                                                <td>
                                                    <div class="tooltip" data-tooltip="Mínimo: ${med.min_stock}">
                                                        ${med.stock} unidades
                                                        ${med.stock <= med.min_stock ? '<i class="fas fa-exclamation-triangle" style="color: var(--color-warning);"></i>' : ''}
                                                    </div>
                                                </td>
                                                <td>€${med.price.toFixed(2)}</td>
                                                <td>${med.expiry_date}</td>
                                                <td>
                                                    <span class="status ${med.stock > med.min_stock ? 'status--success' : 'status--warning'}">
                                                        ${med.stock > med.min_stock ? 'Disponible' : 'Stock Bajo'}
                                                    </span>
                                                </td>
                                                <td>
                                                    <button class="btn btn--outline btn--sm" onclick="editMedication(${med.id})">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn--outline btn--sm" onclick="orderMedication(${med.id})" style="margin-left: var(--space-8);">
                                                        <i class="fas fa-shopping-cart"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <div class="card" style="margin-bottom: var(--space-16);">
                            <div class="card-header">
                                <h4 class="card-title">Alertas de Stock</h4>
                            </div>
                            <div class="card-body">
                                ${medications.filter(m => m.stock <= m.min_stock).map(med => `
                                    <div class="notification-item warning">
                                        <strong>${med.name}</strong><br>
                                        <small>Stock: ${med.stock}/${med.min_stock}</small>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h4 class="card-title">Estadísticas</h4>
                            </div>
                            <div class="card-body">
                                <div style="margin-bottom: var(--space-16);">
                                    <div>Total Medicamentos</div>
                                    <div class="stat-number" style="font-size: var(--font-size-xl);">${medications.length}</div>
                                </div>
                                <div style="margin-bottom: var(--space-16);">
                                    <div>Con Stock Bajo</div>
                                    <div class="stat-number" style="font-size: var(--font-size-xl); color: var(--color-warning);">
                                        ${medications.filter(m => m.stock <= m.min_stock).length}
                                    </div>
                                </div>
                                <div>
                                    <div>Valor Total</div>
                                    <div class="stat-number" style="font-size: var(--font-size-xl); color: var(--color-success);">
                                        €${medications.reduce((total, med) => total + (med.stock * med.price), 0).toFixed(2)}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function loadLaboratoryModule() {
            const module = document.getElementById('laboratoryModule');
            module.innerHTML = `
                <div class="breadcrumbs">
                    <span>Dashboard</span>
                    <span class="breadcrumb-separator">></span>
                    <span>Laboratorio</span>
                </div>
                
                <div class="tab-navigation">
                    <div class="tab-item active" data-tab="pending">Pendientes</div>
                    <div class="tab-item" data-tab="inprogress">En Proceso</div>
                    <div class="tab-item" data-tab="completed">Completados</div>
                    <div class="tab-item" data-tab="critical">Valores Críticos</div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Análisis de Laboratorio</h3>
                        <button class="btn btn--primary btn--sm" onclick="showLabTestModal()">
                            <i class="fas fa-plus"></i> Nueva Solicitud
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Paciente</th>
                                        <th>Análisis</th>
                                        <th>Médico Solicitante</th>
                                        <th>Fecha Solicitud</th>
                                        <th>Estado</th>
                                        <th>Prioridad</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${laboratoryTests.map(test => {
                                        const patient = patients.find(p => p.id === test.patient_id);
                                        return `
                                            <tr class="fade-in">
                                                <td>
                                                    <strong>${patient ? patient.name : 'N/A'}</strong><br>
                                                    <small style="color: var(--color-text-secondary);">${patient ? patient.dni : ''}</small>
                                                </td>
                                                <td>
                                                    <div class="tooltip" data-tooltip="Análisis completo de sangre">
                                                        ${test.test_name}
                                                    </div>
                                                </td>
                                                <td>${test.ordered_by}</td>
                                                <td>${test.order_date}</td>
                                                <td>
                                                    <span class="status ${
                                                        test.status === 'Completado' ? 'status--success' :
                                                        test.status === 'En proceso' ? 'status--warning' : 'status--error'
                                                    }">${test.status}</span>
                                                </td>
                                                <td>
                                                    <span class="status ${
                                                        test.priority === 'Urgente' ? 'status--error' :
                                                        test.priority === 'Normal' ? 'status--info' : 'status--success'
                                                    }">${test.priority}</span>
                                                </td>
                                                <td>
                                                    ${test.status === 'Completado' ? 
                                                        `<button class="btn btn--outline btn--sm" onclick="viewLabResults(${test.id})">
                                                            <i class="fas fa-eye"></i> Ver Resultados
                                                        </button>` :
                                                        `<button class="btn btn--primary btn--sm" onclick="processLabTest(${test.id})">
                                                            <i class="fas fa-play"></i> Procesar
                                                        </button>`
                                                    }
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function loadRadiologyModule() {
            const module = document.getElementById('radiologyModule');
            module.innerHTML = `
                <div class="breadcrumbs">
                    <span>Dashboard</span>
                    <span class="breadcrumb-separator">></span>
                    <span>Radiología e Imágenes</span>
                </div>
                
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--space-20);">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Estudios Radiológicos</h3>
                            <button class="btn btn--primary btn--sm" onclick="showRadiologyModal()">
                                <i class="fas fa-plus"></i> Nueva Solicitud
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="tab-navigation">
                                <div class="tab-item active" data-tab="pending">Pendientes</div>
                                <div class="tab-item" data-tab="completed">Completados</div>
                                <div class="tab-item" data-tab="reported">Reportados</div>
                            </div>
                            
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Paciente</th>
                                            <th>Estudio</th>
                                            <th>Fecha</th>
                                            <th>Estado</th>
                                            <th>Radiólogo</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr class="fade-in">
                                            <td>
                                                <strong>Juan Pérez López</strong><br>
                                                <small style="color: var(--color-text-secondary);">12345678A</small>
                                            </td>
                                            <td>
                                                <div class="tooltip" data-tooltip="Radiografía de tórax AP y lateral">
                                                    <i class="fas fa-x-ray"></i> RX Tórax
                                                </div>
                                            </td>
                                            <td>2025-10-22</td>
                                            <td><span class="status status--success">Completado</span></td>
                                            <td>Dr. Radiología</td>
                                            <td>
                                                <button class="btn btn--outline btn--sm" onclick="viewRadiologyImages()">
                                                    <i class="fas fa-images"></i> Ver Imágenes
                                                </button>
                                            </td>
                                        </tr>
                                        <tr class="fade-in">
                                            <td>
                                                <strong>Ana Rodríguez</strong><br>
                                                <small style="color: var(--color-text-secondary);">87654321B</small>
                                            </td>
                                            <td>
                                                <div class="tooltip" data-tooltip="Tomografía computarizada de abdomen">
                                                    <i class="fas fa-procedures"></i> TAC Abdomen
                                                </div>
                                            </td>
                                            <td>2025-10-23</td>
                                            <td><span class="status status--warning">En Proceso</span></td>
                                            <td>-</td>
                                            <td>
                                                <button class="btn btn--primary btn--sm" onclick="assignRadiologist()">
                                                    <i class="fas fa-user-plus"></i> Asignar
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <div class="card" style="margin-bottom: var(--space-16);">
                            <div class="card-header">
                                <h4 class="card-title">Visor DICOM Simulado</h4>
                            </div>
                            <div class="card-body">
                                <div style="background: var(--color-charcoal-700); height: 200px; border-radius: var(--radius-base); display: flex; align-items: center; justify-content: center; color: var(--color-white); flex-direction: column;">
                                    <i class="fas fa-x-ray" style="font-size: 3rem; margin-bottom: var(--space-12);"></i>
                                    <div>Imagen DICOM</div>
                                    <div style="font-size: var(--font-size-sm); opacity: 0.7;">RX Tórax - 22/10/2025</div>
                                    <div style="margin-top: var(--space-16); display: flex; gap: var(--space-8);">
                                        <button class="btn btn--outline btn--sm" onclick="zoomImage()">
                                            <i class="fas fa-search-plus"></i>
                                        </button>
                                        <button class="btn btn--outline btn--sm" onclick="rotateImage()">
                                            <i class="fas fa-redo"></i>
                                        </button>
                                        <button class="btn btn--outline btn--sm" onclick="measureImage()">
                                            <i class="fas fa-ruler"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h4 class="card-title">Equipos Disponibles</h4>
                            </div>
                            <div class="card-body">
                                <div style="margin-bottom: var(--space-12);">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-8);">
                                        <span>Rayos X</span>
                                        <span class="status status--success">Disponible</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-8);">
                                        <span>TAC</span>
                                        <span class="status status--warning">Ocupado</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-8);">
                                        <span>RM</span>
                                        <span class="status status--error">Mantenimiento</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span>Ecografía</span>
                                        <span class="status status--success">Disponible</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Notification and toast system
        function showNotifications() {
            const panel = document.getElementById('notificationPanel');
            if (!panel) {
                createNotificationPanel();
            } else {
                panel.classList.toggle('active');
            }
        }
        
        function createNotificationPanel() {
            const panel = document.createElement('div');
            panel.id = 'notificationPanel';
            panel.className = 'notification-panel active';
            panel.innerHTML = `
                <div class="card-header">
                    <h4 class="card-title">Notificaciones</h4>
                    <button class="btn btn--outline btn--sm" onclick="markAllAsRead()">
                        <i class="fas fa-check-double"></i> Marcar todas leídas
                    </button>
                </div>
                <div class="card-body" style="padding: 0;">
                    ${notifications.map(notif => `
                        <div class="notification-item ${notif.type} ${notif.read ? '' : 'unread'}" onclick="markAsRead(${notif.id})">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div>
                                    <strong>${notif.title}</strong><br>
                                    <small style="color: var(--color-text-secondary);">${notif.message}</small><br>
                                    <small style="color: var(--color-text-secondary); opacity: 0.7;">${formatTime(notif.time)}</small>
                                </div>
                                ${!notif.read ? '<div style="width: 8px; height: 8px; background: var(--color-primary); border-radius: 50%; margin-top: var(--space-4);"></div>' : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            document.body.appendChild(panel);
        }
        
        function showToast(type, title, message) {
            const toast = document.createElement('div');
            toast.className = `notification-item ${type} fade-in`;
            toast.style.cssText = `
                position: fixed;
                top: 100px;
                right: var(--space-20);
                z-index: 1002;
                background: var(--color-surface);
                border: 1px solid var(--color-border);
                border-radius: var(--radius-lg);
                box-shadow: var(--shadow-lg);
                min-width: 300px;
                cursor: pointer;
            `;
            toast.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div>
                        <strong>${title}</strong><br>
                        <small style="color: var(--color-text-secondary);">${message}</small>
                    </div>
                    <button style="background: none; border: none; cursor: pointer;" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 5000);
        }
        
        // Dark mode functionality
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const icon = document.getElementById('themeIcon');
            if (document.body.classList.contains('dark-mode')) {
                icon.className = 'fas fa-sun';
                appState.darkMode = true;
            } else {
                icon.className = 'fas fa-moon';
                appState.darkMode = false;
            }
        }
        
        // Utility functions
        function formatTime(timestamp) {
            return new Date(timestamp).toLocaleTimeString('es-ES', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function updateBreadcrumbs(moduleId) {
            const breadcrumbContainer = document.querySelector('.breadcrumbs');
            if (breadcrumbContainer) {
                const moduleNames = {
                    dashboard: 'Dashboard',
                    patients: 'Pacientes',
                    appointments: 'Citas',
                    records: 'Historiales',
                    doctors: 'Personal',
                    prescriptions: 'Recetas',
                    billing: 'Facturación',
                    inventory: 'Inventario',
                    laboratory: 'Laboratorio',
                    radiology: 'Radiología',
                    surgery: 'Quirófanos',
                    emergency: 'Urgencias',
                    rooms: 'Habitaciones',
                    communications: 'Comunicaciones',
                    reports: 'Reportes',
                    settings: 'Configuración'
                };
                
                breadcrumbContainer.innerHTML = `
                    <span onclick="showModule('dashboard')" style="cursor: pointer; color: var(--color-primary);">Dashboard</span>
                    <span class="breadcrumb-separator">></span>
                    <span>${moduleNames[moduleId] || moduleId}</span>
                `;
            }
        }

        // Global search functionality
        function setupGlobalSearch() {
            const searchInput = document.getElementById('globalSearch');
            searchInput.addEventListener('input', function(e) {
                const query = e.target.value.toLowerCase();
                if (query.length > 2) {
                    performGlobalSearch(query);
                } else {
                    clearSearchResults();
                }
            });
        }
        
        function performGlobalSearch(query) {
            let results = [];
            
            // Search in patients
            const patientResults = patients.filter(p => 
                p.name.toLowerCase().includes(query) || 
                p.dni.includes(query) ||
                p.phone.includes(query)
            ).map(p => ({...p, type: 'patient', module: 'patients'}));
            
            // Search in appointments
            const appointmentResults = appointments.filter(a => 
                a.patient_name.toLowerCase().includes(query) ||
                a.doctor.toLowerCase().includes(query)
            ).map(a => ({...a, type: 'appointment', module: 'appointments'}));
            
            // Search in doctors
            const doctorResults = doctors.filter(d => 
                d.name.toLowerCase().includes(query) ||
                d.specialty.toLowerCase().includes(query)
            ).map(d => ({...d, type: 'doctor', module: 'doctors'}));
            
            results = [...patientResults, ...appointmentResults, ...doctorResults];
            
            if (results.length > 0) {
                showSearchResults(results);
            } else {
                showToast('info', 'Búsqueda', 'No se encontraron resultados para "' + query + '"');
            }
        }
        
        function showSearchResults(results) {
            // Show search results in a dropdown or modal
            console.log('Search results:', results);
            showToast('success', 'Búsqueda', results.length + ' resultados encontrados');
        }
        
        function clearSearchResults() {
            // Clear search results display
            console.log('Search cleared');
        }
        
        function setupTabNavigation() {
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('tab-item')) {
                    const tabContainer = e.target.parentElement;
                    tabContainer.querySelectorAll('.tab-item').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    e.target.classList.add('active');
                    
                    const tabId = e.target.dataset.tab;
                    showToast('info', 'Pestaña', 'Cambiado a: ' + tabId);
                }
            });
        }
        
        function setupFilterChips() {
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('filter-chip')) {
                    const filterContainer = e.target.parentElement;
                    filterContainer.querySelectorAll('.filter-chip').forEach(chip => {
                        chip.classList.remove('active');
                    });
                    e.target.classList.add('active');
                    
                    const filterId = e.target.dataset.filter || e.target.textContent;
                    showToast('info', 'Filtro', 'Aplicado: ' + filterId);
                }
            });
        }
        
        function initializeRealTimeUpdates() {
            // Simulate real-time updates
            setInterval(() => {
                // Update notification count randomly
                const unreadCount = notifications.filter(n => !n.read).length;
                const badge = document.querySelector('.notification-badge');
                if (badge && unreadCount > 0) {
                    badge.style.setProperty('--notification-count', '"' + unreadCount + '"');
                }
                
                // Randomly update some statistics
                if (Math.random() > 0.9) {
                    const elements = ['totalPatientsCount', 'todayAppointmentsCount', 'emergenciesToday'];
                    const randomElement = elements[Math.floor(Math.random() * elements.length)];
                    const element = document.getElementById(randomElement);
                    if (element) {
                        const currentValue = parseInt(element.textContent);
                        const change = Math.floor(Math.random() * 3) - 1; // -1, 0, or 1
                        element.textContent = Math.max(0, currentValue + change);
                    }
                }
            }, 10000); // Update every 10 seconds
        }
        
        function setupKeyboardShorts() {
            document.addEventListener('keydown', function(e) {
                // Ctrl/Cmd + K for global search
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    document.getElementById('globalSearch').focus();
                    showToast('info', 'Atajo', 'Búsqueda global activada');
                }
                
                // Ctrl/Cmd + D for dashboard
                if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                    e.preventDefault();
                    showModule('dashboard');
                }
                
                // Ctrl/Cmd + P for patients
                if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
                    e.preventDefault();
                    showModule('patients');
                }
                
                // ESC to close modals
                if (e.key === 'Escape') {
                    const modal = document.querySelector('.modal.active');
                    const panel = document.querySelector('.notification-panel.active');
                    if (modal) {
                        closeModal();
                    }
                    if (panel) {
                        panel.remove();
                    }
                }
            });
        }

        // === PWA SERVICE WORKER ===
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        console.log('SW registered: ', registration);
                        showToast('info', 'PWA', 'Aplicación lista para instalación offline');
                    })
                    .catch(function(registrationError) {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
        
        // === ADVANCED CALENDAR WITH DRAG & DROP ===
        function loadAdvancedCalendar() {
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            document.getElementById('modalTitle').textContent = 'Calendario de Citas - Drag & Drop';
            document.getElementById('modalBody').innerHTML = `
                <div style="margin-bottom: var(--space-16);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-16);">
                        <button class="btn btn--outline btn--sm" onclick="changeCalendarMonth(-1)">← Anterior</button>
                        <h3 id="calendarTitle">${getMonthName(currentMonth)} ${currentYear}</h3>
                        <button class="btn btn--outline btn--sm" onclick="changeCalendarMonth(1)">Siguiente →</button>
                    </div>
                    <div id="calendarGrid" class="calendar-grid"></div>
                    <div style="margin-top: var(--space-16);">
                        <h5>Citas Disponibles para Arrastrar:</h5>
                        <div id="unassignedAppointments" style="display: flex; gap: var(--space-8); flex-wrap: wrap; margin-top: var(--space-8);">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
                <div style="display: flex; gap: var(--space-12); justify-content: flex-end; margin-top: var(--space-20);">
                    <button type="button" class="btn btn--outline" onclick="closeModal()">Cerrar</button>
                    <button type="button" class="btn btn--primary" onclick="saveCalendarChanges()">Guardar Cambios</button>
                </div>
            `;
            
            document.getElementById('formModal').classList.add('active');
            generateCalendar(currentYear, currentMonth);
            loadUnassignedAppointments();
        }
        
        let currentCalendarDate = new Date();
        
        function generateCalendar(year, month) {
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            const calendarGrid = document.getElementById('calendarGrid');
            let calendarHTML = '<div class="calendar-header">';
            
            // Days of week header
            const daysOfWeek = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
            daysOfWeek.forEach(day => {
                calendarHTML += `<div class="calendar-day-header">${day}</div>`;
            });
            
            calendarHTML += '</div><div class="calendar-body">';
            
            // Generate calendar days
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const isCurrentMonth = date.getMonth() === month;
                const isToday = date.toDateString() === new Date().toDateString();
                const dayAppointments = getAppointmentsForDate(date);
                
                calendarHTML += `
                    <div class="calendar-day ${isCurrentMonth ? '' : 'other-month'} ${isToday ? 'today' : ''}" 
                         data-date="${date.toISOString().split('T')[0]}"
                         ondrop="dropAppointment(event)" ondragover="allowDrop(event)">
                        <div class="day-number">${date.getDate()}</div>
                        <div class="day-appointments">
                            ${dayAppointments.map(apt => `
                                <div class="appointment-item" draggable="true" ondragstart="dragAppointment(event)" data-id="${apt.id}">
                                    ${apt.time} - ${apt.patient_name.split(' ')[0]}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            calendarHTML += '</div>';
            calendarGrid.innerHTML = calendarHTML;
        }
        
        function getAppointmentsForDate(date) {
            const dateStr = date.toISOString().split('T')[0];
            return appointments.filter(apt => apt.date === dateStr);
        }
        
        function loadUnassignedAppointments() {
            const container = document.getElementById('unassignedAppointments');
            const unassigned = appointments.filter(apt => !apt.date || apt.status === 'Por programar');
            
            container.innerHTML = unassigned.map(apt => `
                <div class="appointment-item unassigned" draggable="true" ondragstart="dragAppointment(event)" data-id="${apt.id}">
                    <i class="fas fa-calendar-plus"></i> ${apt.patient_name} - ${apt.doctor}
                </div>
            `).join('');
        }
        
        function changeCalendarMonth(direction) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
            document.getElementById('calendarTitle').textContent = 
                getMonthName(currentCalendarDate.getMonth()) + ' ' + currentCalendarDate.getFullYear();
            generateCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
        }
        
        function getMonthName(month) {
            const months = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];
            return months[month];
        }
        
        function allowDrop(event) {
            event.preventDefault();
        }
        
        function dragAppointment(event) {
            event.dataTransfer.setData('text/plain', event.target.dataset.id);
            event.target.style.opacity = '0.5';
        }
        
        function dropAppointment(event) {
            event.preventDefault();
            const appointmentId = parseInt(event.dataTransfer.getData('text/plain'));
            const dayElement = event.target.closest('.calendar-day');
            const newDate = dayElement.dataset.date;
            
            // Update appointment date
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (appointment) {
                appointment.date = newDate;
                appointment.status = 'Programada';
                showToast('success', 'Cita reprogramada', `Cita movida al ${newDate}`);
                generateCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
                loadUnassignedAppointments();
            }
        }
        
        function saveCalendarChanges() {
            showToast('success', 'Cambios guardados', 'Todas las modificaciones del calendario se han guardado');
            closeModal();
        }
        
        // === ADVANCED SEARCH FUNCTIONALITY ===
        function setupAdvancedSearch() {
            const searchInput = document.getElementById('globalSearch');
            let searchTimeout;
            
            searchInput.addEventListener('input', function(e) {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    const query = e.target.value.toLowerCase().trim();
                    if (query.length >= 2) {
                        performAdvancedSearch(query);
                    }
                }, 300);
            });
            
            // Voice search button
            const voiceBtn = document.createElement('button');
            voiceBtn.className = 'btn btn--outline btn--sm';
            voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            voiceBtn.onclick = startVoiceSearch;
            voiceBtn.style.marginLeft = 'var(--space-8)';
            searchInput.parentElement.appendChild(voiceBtn);
        }
        
        function startVoiceSearch() {
            if (recognition) {
                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('globalSearch').value = transcript;
                    performAdvancedSearch(transcript.toLowerCase());
                };
                recognition.start();
                showToast('info', 'Búsqueda por voz', 'Diga lo que busca...');
            }
        }
        
        function performAdvancedSearch(query) {
            let results = [];
            
            // Enhanced search with fuzzy matching
            const patientResults = patients.filter(p => 
                fuzzyMatch(p.name, query) || 
                p.dni.includes(query) ||
                p.phone.includes(query) ||
                (p.email && fuzzyMatch(p.email, query))
            ).map(p => ({...p, type: 'Paciente', module: 'patients', relevance: calculateRelevance(p.name, query)}));
            
            const appointmentResults = appointments.filter(a => 
                fuzzyMatch(a.patient_name, query) ||
                fuzzyMatch(a.doctor, query) ||
                a.reason.toLowerCase().includes(query)
            ).map(a => ({...a, type: 'Cita', module: 'appointments', relevance: calculateRelevance(a.patient_name, query)}));
            
            const recordResults = medicalRecords.filter(r => 
                fuzzyMatch(r.diagnosis, query) ||
                fuzzyMatch(r.treatment, query)
            ).map(r => ({...r, type: 'Historial', module: 'records', relevance: calculateRelevance(r.diagnosis, query)}));
            
            const medicationResults = medications.filter(m => 
                fuzzyMatch(m.name, query) ||
                fuzzyMatch(m.category, query)
            ).map(m => ({...m, type: 'Medicamento', module: 'inventory', relevance: calculateRelevance(m.name, query)}));
            
            results = [...patientResults, ...appointmentResults, ...recordResults, ...medicationResults]
                .sort((a, b) => b.relevance - a.relevance)
                .slice(0, 10);
            
            if (results.length > 0) {
                showAdvancedSearchResults(results, query);
            } else {
                showToast('info', 'Búsqueda', 'No se encontraron resultados para "' + query + '"');
            }
        }
        
        function fuzzyMatch(text, query) {
            if (!text) return false;
            text = text.toLowerCase();
            query = query.toLowerCase();
            
            // Simple fuzzy matching - exact match, starts with, or contains
            return text === query || text.startsWith(query) || text.includes(query);
        }
        
        function calculateRelevance(text, query) {
            if (!text) return 0;
            text = text.toLowerCase();
            query = query.toLowerCase();
            
            if (text === query) return 100;
            if (text.startsWith(query)) return 80;
            if (text.includes(query)) return 60;
            return 0;
        }
        
        function showAdvancedSearchResults(results, query) {
            const resultsPanel = document.createElement('div');
            resultsPanel.id = 'searchResultsPanel';
            resultsPanel.className = 'notification-panel active';
            resultsPanel.style.top = '120px';
            resultsPanel.innerHTML = `
                <div class="card-header">
                    <h4 class="card-title">Resultados: "${query}"</h4>
                    <button class="btn btn--outline btn--sm" onclick="closeSearchResults()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="card-body" style="padding: 0; max-height: 400px; overflow-y: auto;">
                    ${results.map(result => `
                        <div class="notification-item" onclick="openSearchResult('${result.module}', ${result.id || 0})" style="cursor: pointer;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div>
                                    <strong>${result.name || result.patient_name || result.diagnosis || 'N/A'}</strong>
                                    <span class="status status--info" style="margin-left: var(--space-8);">${result.type}</span><br>
                                    <small style="color: var(--color-text-secondary);">
                                        ${result.dni || result.doctor || result.treatment || result.category || 'Detalles'}
                                    </small>
                                </div>
                                <div style="text-align: right;">
                                    <small style="color: var(--color-success);">Relevancia: ${result.relevance}%</small>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            // Remove existing search results
            const existing = document.getElementById('searchResultsPanel');
            if (existing) existing.remove();
            
            document.body.appendChild(resultsPanel);
        }
        
        function closeSearchResults() {
            const panel = document.getElementById('searchResultsPanel');
            if (panel) panel.remove();
        }
        
        function openSearchResult(module, id) {
            closeSearchResults();
            showModule(module);
            
            // Auto-focus on the relevant item if ID is provided
            if (id) {
                setTimeout(() => {
                    if (module === 'patients') viewPatient(id);
                    else if (module === 'appointments') editAppointment(id);
                    else if (module === 'records') viewRecord(id);
                    else if (module === 'inventory') editMedication(id);
                }, 500);
            }
            
            showToast('success', 'Resultado abierto', 'Navegando al elemento seleccionado');
        }
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Set up event listeners
            document.getElementById('loginForm').addEventListener('submit', login);
            document.getElementById('twofaForm').addEventListener('submit', verify2FA);
            
            // Navigation event listeners
            document.querySelectorAll('[data-module]').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const module = e.target.closest('[data-module]').dataset.module;
                    showModule(module);
                });
            });
            
            // Mobile menu toggle
            document.getElementById('mobileMenuBtn').addEventListener('click', function() {
                document.getElementById('sidebar').classList.toggle('active');
            });
            
            // Setup advanced search with voice
            setupAdvancedSearch();
            
            // Initialize speech recognition
            initializeSpeechRecognition();
            
            // Setup tab navigation
            setupTabNavigation();
            
            // Setup filter chips
            setupFilterChips();
            
            // Initialize real-time updates
            initializeRealTimeUpdates();
            
            // Setup keyboard shortcuts
            setupKeyboardShorts();
            
            // Setup advanced search
            setupAdvancedSearch();
            
            // Close modal when clicking outside
            document.getElementById('formModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });
            
            // Initialize notification badge
            updateNotificationBadge();
            
            // Install PWA prompt
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                showPWAInstallPrompt();
            });
            
            // Handle service worker messages
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.addEventListener('message', event => {
                    if (event.data && event.data.type === 'PWA_INSTALLABLE') {
                        showPWAInstallPrompt();
                    }
                });
            }
            
            // Add dictation button to text areas
            addDictationButtons();
            
            // Initialize real-time updates simulation
            initializeRealTimeFeatures();
            
            // Initialize offline detection
            initializeOfflineMode();
        });
        
        // === PWA INSTALLATION ===
        function showPWAInstallPrompt() {
            const prompt = document.createElement('div');
            prompt.className = 'install-prompt show';
            prompt.innerHTML = `
                <div>
                    <strong>Instalar HospiSafe</strong><br>
                    <small>Accede rápidamente sin navegador</small>
                </div>
                <div>
                    <button class="btn btn--outline btn--sm" onclick="dismissInstallPrompt()">No, gracias</button>
                    <button class="btn btn--primary btn--sm" onclick="installPWA()" style="margin-left: var(--space-8);">Instalar</button>
                </div>
            `;
            
            // Remove existing prompt
            const existing = document.querySelector('.install-prompt');
            if (existing) existing.remove();
            
            document.body.appendChild(prompt);
            
            // Auto-dismiss after 10 seconds
            setTimeout(() => {
                if (prompt.parentNode) {
                    prompt.remove();
                }
            }, 10000);
        }
        
        function installPWA() {
            const prompt = document.querySelector('.install-prompt');
            if (prompt) prompt.remove();
            
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        showToast('success', 'PWA Instalada', 'HospiSafe se ha instalado correctamente');
                    }
                    deferredPrompt = null;
                });
            } else {
                showToast('info', 'Ya instalado', 'HospiSafe ya está instalado o disponible');
            }
        }
        
        function dismissInstallPrompt() {
            const prompt = document.querySelector('.install-prompt');
            if (prompt) prompt.remove();
        }
        
        // === VOICE DICTATION ENHANCEMENTS ===
        function addDictationButtons() {
            document.querySelectorAll('textarea, input[type="text"]').forEach(element => {
                if (!element.parentElement.querySelector('.dictation-btn')) {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'btn btn--outline btn--sm dictation-btn';
                    btn.innerHTML = '<i class="fas fa-microphone"></i>';
                    btn.style.cssText = 'position: absolute; right: 8px; top: 50%; transform: translateY(-50%); z-index: 10;';
                    btn.onclick = () => startDictationFor(element);
                    
                    element.parentElement.style.position = 'relative';
                    element.style.paddingRight = '40px';
                    element.parentElement.appendChild(btn);
                }
            });
        }
        
        function startDictationFor(targetElement) {
            if (recognition) {
                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    targetElement.value += (targetElement.value ? ' ' : '') + transcript;
                    targetElement.dispatchEvent(new Event('input', { bubbles: true }));
                    showToast('success', 'Dictado completado', 'Texto agregado correctamente');
                };
                
                recognition.start();
                const btn = targetElement.parentElement.querySelector('.dictation-btn');
                btn.classList.add('voice-recording');
                
                recognition.onend = function() {
                    btn.classList.remove('voice-recording');
                };
                
                showToast('info', 'Dictado activo', 'Hable ahora para dictar texto');
            } else {
                showToast('warning', 'No disponible', 'Reconocimiento de voz no soportado');
            }
        }
        
        // === REAL-TIME FEATURES ===
        function initializeRealTimeFeatures() {
            // Simulate real-time notifications
            setInterval(() => {
                if (Math.random() > 0.95) { // 5% chance every interval
                    const randomNotifications = [
                        { type: 'info', title: 'Nueva cita', message: 'Cita programada para mañana' },
                        { type: 'warning', title: 'Stock bajo', message: 'Revisar inventario de medicamentos' },
                        { type: 'success', title: 'Resultado listo', message: 'Resultado de laboratorio disponible' },
                        { type: 'urgent', title: 'Emergencia', message: 'Paciente crítico en UCI' }
                    ];
                    
                    const randomNotif = randomNotifications[Math.floor(Math.random() * randomNotifications.length)];
                    
                    const newNotification = {
                        id: Math.max(...notifications.map(n => n.id)) + 1,
                        type: randomNotif.type,
                        title: randomNotif.title,
                        message: randomNotif.message,
                        time: new Date().toISOString(),
                        read: false
                    };
                    
                    notifications.unshift(newNotification);
                    updateNotificationBadge();
                    
                    // Show toast for urgent notifications
                    if (randomNotif.type === 'urgent') {
                        showToast('error', randomNotif.title, randomNotif.message);
                    }
                }
            }, 15000); // Check every 15 seconds
            
            // Real-time stats updates
            setInterval(() => {
                updateRealTimeStats();
            }, 30000); // Update every 30 seconds
        }
        
        function updateRealTimeStats() {
            // Simulate random small changes in statistics
            const elements = {
                'totalPatientsCount': { current: statistics.patients_total, change: () => Math.floor(Math.random() * 3) - 1 },
                'todayAppointmentsCount': { current: statistics.appointments_today, change: () => Math.floor(Math.random() * 2) },
                'emergenciesToday': { current: statistics.emergency_cases_today, change: () => Math.floor(Math.random() * 2) }
            };
            
            Object.entries(elements).forEach(([id, config]) => {
                const element = document.getElementById(id);
                if (element && Math.random() > 0.8) { // 20% chance of update
                    const change = config.change();
                    const newValue = Math.max(0, config.current + change);
                    
                    if (id === 'totalPatientsCount') statistics.patients_total = newValue;
                    else if (id === 'todayAppointmentsCount') statistics.appointments_today = newValue;
                    else if (id === 'emergenciesToday') statistics.emergency_cases_today = newValue;
                    
                    // Animate counter
                    animateCounter(id, newValue);
                    
                    if (change > 0 && Math.random() > 0.7) {
                        showToast('info', 'Actualización', `${id.replace('Count', '').replace(/([A-Z])/g, ' $1')} actualizado`);
                    }
                }
            });
        }
        
        // === OFFLINE MODE ===
        function initializeOfflineMode() {
            window.addEventListener('online', () => {
                showToast('success', 'Conexión restaurada', 'Sincronizando datos pendientes...');
                syncOfflineData();
            });
            
            window.addEventListener('offline', () => {
                showToast('warning', 'Sin conexión', 'Trabajando en modo offline');
            });
        }
        
        function syncOfflineData() {
            // Simulate syncing offline changes
            setTimeout(() => {
                showToast('success', 'Sincronización completa', 'Todos los datos se han sincronizado');
            }, 2000);
        }
        
        // === PERFORMANCE MONITORING ===
        function initPerformanceMonitoring() {
            // Monitor page load performance
            window.addEventListener('load', () => {
                const perfData = performance.getEntriesByType('navigation')[0];
                const loadTime = perfData.loadEventEnd - perfData.loadEventStart;
                
                if (loadTime > 3000) {
                    console.warn(`Slow page load: ${loadTime}ms`);
                }
            });
            
            // Monitor memory usage
            if ('memory' in performance) {
                setInterval(() => {
                    const memInfo = performance.memory;
                    if (memInfo.usedJSHeapSize > 100 * 1024 * 1024) { // 100MB
                        console.warn('High memory usage detected');
                    }
                }, 60000); // Check every minute
            }
        }
        
        // === DATA PERSISTENCE ENHANCEMENTS ===
        function saveToLocalMemory(key, data) {
            try {
                // Since localStorage is not available, use memory storage
                window.hospiSafeData = window.hospiSafeData || {};
                window.hospiSafeData[key] = JSON.stringify(data);
                return true;
            } catch (error) {
                console.warn('Could not save to memory:', error);
                return false;
            }
        }
        
        function loadFromLocalMemory(key) {
            try {
                if (window.hospiSafeData && window.hospiSafeData[key]) {
                    return JSON.parse(window.hospiSafeData[key]);
                }
                return null;
            } catch (error) {
                console.warn('Could not load from memory:', error);
                return null;
            }
        }
        
        // Auto-save important data
        setInterval(() => {
            saveToLocalMemory('patients', patients);
            saveToLocalMemory('appointments', appointments);
            saveToLocalMemory('notifications', notifications);
        }, 30000); // Auto-save every 30 seconds
        
        // === ADVANCED UI ENHANCEMENTS ===
        function initializeAdvancedUI() {
            // Add keyboard navigation
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case '1': e.preventDefault(); showModule('dashboard'); break;
                        case '2': e.preventDefault(); showModule('patients'); break;
                        case '3': e.preventDefault(); showModule('appointments'); break;
                        case 'n': e.preventDefault(); showPatientModal(); break;
                        case '/': e.preventDefault(); document.getElementById('globalSearch').focus(); break;
                    }
                }
            });
            
            // Add tooltips with delay
            document.querySelectorAll('[data-tooltip]').forEach(element => {
                let tooltipTimeout;
                
                element.addEventListener('mouseenter', () => {
                    tooltipTimeout = setTimeout(() => {
                        // Tooltip is handled by CSS, but could add dynamic positioning here
                    }, 500);
                });
                
                element.addEventListener('mouseleave', () => {
                    clearTimeout(tooltipTimeout);
                });
            });
            
            // Add smooth scrolling
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        target.scrollIntoView({ behavior: 'smooth' });
                    }
                });
            });
        }
        
        // Initialize everything when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // ... existing initialization code ...
        });
    </script>
</body>
</html>